<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Courses Offered | Food Business Academy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --primary: #2563eb;       /* Blue */
  --secondary: #7c3aed;     /* Purple */
  --dark: #0f172a;
  --light: #f8fafc;
  --gray: #64748b;
  --white: #ffffff;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
}

* { box-sizing: border-box; font-family: 'Outfit', sans-serif; }

body {
  margin: 0;
  background-color: #f1f5f9;
  color: var(--dark);
  padding-bottom: 50px;
}

/* --- HEADER / STUDENT INFO --- */
.header-bar {
  background: var(--white);
  padding: 20px 30px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
  flex-wrap: wrap;
  gap: 15px;
}

.brand h2 { margin: 0; color: var(--primary); font-weight: 700; }

.student-badge {
  display: flex;
  align-items: center;
  gap: 15px;
  background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
  padding: 10px 20px;
  border-radius: 50px;
  border: 1px solid #bae6fd;
}

.student-info div { display: flex; flex-direction: column; }
.student-info small { color: var(--gray); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
.student-info span { font-weight: 600; color: var(--dark); font-size: 0.9rem; }

/* --- MAIN LAYOUT --- */
.main-container {
  max-width: 1200px;
  margin: 40px auto;
  padding: 0 20px;
}

.page-title {
  text-align: center;
  margin-bottom: 40px;
}
.page-title h1 { font-size: 2.5rem; margin: 0 0 10px 0; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.page-title p { color: var(--gray); margin: 0; }

/* --- GRID --- */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
  gap: 30px;
}

/* --- COURSE CARD --- */
.card {
  background: var(--white);
  border-radius: 24px;
  overflow: hidden;
  box-shadow: var(--shadow);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  display: flex;
  flex-direction: column;
  position: relative;
  border: 1px solid rgba(0,0,0,0.03);
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 20px 40px -12px rgba(0,0,0,0.15);
}

/* Status Badge */
.status-badge {
  position: absolute;
  top: 20px;
  right: 20px;
  padding: 6px 14px;
  border-radius: 30px;
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  z-index: 10;
}
.status-badge.approved { background: #dcfce7; color: #166534; }
.status-badge.pending { background: #fef3c7; color: #92400e; }

/* Card Content */
.card-body { padding: 30px; flex-grow: 1; }

.card-title {
  font-size: 1.4rem;
  font-weight: 700;
  margin: 0 0 15px 0;
  line-height: 1.3;
  padding-right: 60px; /* Space for badge */
}

/* Section Headers */
.section-label {
  font-size: 0.75rem;
  text-transform: uppercase;
  color: var(--gray);
  font-weight: 700;
  letter-spacing: 1px;
  margin-bottom: 8px;
  display: block;
}

.course-overview {
  color: var(--gray);
  font-size: 0.95rem;
  line-height: 1.6;
  margin-bottom: 25px;
}

/* Curriculum List */
.curriculum-list {
  list-style: none;
  padding: 0;
  margin: 0 0 25px 0;
}

.curriculum-list li {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  margin-bottom: 10px;
  font-size: 0.9rem;
  color: var(--dark);
}

.curriculum-list li svg {
  min-width: 18px;
  width: 18px;
  color: var(--primary);
  margin-top: 2px;
}

/* Footer & Price */
.card-footer {
  padding: 20px 30px;
  background: #f8fafc;
  border-top: 1px solid #e2e8f0;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.price-tag {
  font-size: 1.5rem;
  font-weight: 800;
  color: var(--dark);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.price-tag span { font-size: 0.9rem; font-weight: 500; color: var(--gray); }

/* Buttons */
button {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}
.btn-primary:hover { opacity: 0.95; transform: scale(1.01); }

.btn-success {
  background: var(--success);
  color: white;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.btn-pending {
  background: #e2e8f0;
  color: var(--gray);
  cursor: not-allowed;
}

.btn-cancel {
  background: transparent;
  color: var(--danger);
  font-size: 0.85rem;
  padding: 8px;
  margin-top: 5px;
}
.btn-cancel:hover { text-decoration: underline; }

/* Responsive */
@media(max-width: 600px){
  .header-bar { flex-direction: column; text-align: center; }
  .student-badge { width: 100%; justify-content: center; }
}
</style>
</head>

<body>

<header class="header-bar">
  <div class="brand">
    <h2>FBA Portal</h2>
  </div>
  <div class="student-badge">
    <div class="student-info">
      <small>Logged in as</small>
      <span id="studentEmail">Loading...</span>
    </div>
    <div style="height: 25px; width: 1px; background: #cbd5e1;"></div>
    <div class="student-info">
      <small>Student ID</small>
      <span id="studentId">...</span>
    </div>
  </div>
</header>

<main class="main-container">
  
  <div class="page-title">
    <h1>Available Courses</h1>
    <p>Select a course below to view the curriculum and enroll.</p>
  </div>

  <div class="grid" id="coursesGrid">
    <div style="text-align:center; width:100%; grid-column: 1/-1;">
      <p>Loading course catalog...</p>
    </div>
  </div>

</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, query, where, getDocs,
  doc, getDoc, serverTimestamp, deleteDoc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* ðŸ”¥ FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain: "students-login-29409.firebaseapp.com",
  projectId: "students-login-29409",
  storageBucket: "students-login-29409.firebasestorage.app",
  messagingSenderId: "634331456872",
  appId: "1:634331456872:web:6dae360c5e28d8356562dd",
  measurementId: "G-96XXYG1VR2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ðŸ“š COURSES DATA (EXPANDED) 
   Note: Edit the text inside strings to change content.
*/
const courses = [
  {
    name: "Food Business Management Course",
    price: 49,
    overview: "A comprehensive guide to running a successful food business. Learn to navigate regulations, manage supply chains, and optimize daily operations.",
    curriculum: [
      "Introduction to Food Business Ecosystems",
      "Strategic Operations & Compliance",
      "Food Safety Management Systems (HACCP)",
      "Supply Chain & Inventory Control",
      "Marketing & Distribution Channels"
    ]
  },
  {
    name: "Financial Management for Food Processors",
    price: 59,
    overview: "Master the numbers behind food processing. This course focuses on costing, pricing strategies, and maintaining healthy cash flow for manufacturing.",
    curriculum: [
      "Costing & Pricing Strategies",
      "Cash Flow Management & Optimization",
      "Budgeting & Financial Forecasting",
      "Profitability Analysis per Product Line",
      "Investment & Capital Management"
    ]
  },
  {
    name: "Food Value Addition Course for Farmers",
    price: 45,
    overview: "Transform raw produce into high-value market products. Learn processing techniques that increase shelf-life and profitability.",
    curriculum: [
      "Post-Harvest Handling Best Practices",
      "Processing Techniques (Drying, Canning, etc.)",
      "Packaging Technology & Labeling",
      "Quality Control Standards",
      "Market Readiness & Logistics"
    ]
  },
  {
    name: "New Product Development and Management",
    price: 69,
    overview: "From concept to grocery shelf. Learn the step-by-step process of innovating, testing, and launching new food products.",
    curriculum: [
      "Idea Generation & Market Gap Analysis",
      "Recipe Standardization & Prototyping",
      "Sensory Evaluation & Consumer Testing",
      "Regulatory Approval & Nutritional Facts",
      "Go-to-Market Launch Strategy"
    ]
  },
  {
    name: "Management",
    price: 39,
    overview: "Essential leadership skills for the food industry. Build strong teams and make ethical business decisions.",
    curriculum: [
      "Core Leadership Skills",
      "Conflict Resolution & Team Management",
      "Strategic Decision Making",
      "Business Ethics & Corporate Responsibility",
      "Performance Management"
    ]
  }
];

const grid = document.getElementById("coursesGrid");

/* ðŸ”¥ AUTH & LOGIC */
onAuthStateChanged(auth, async (user) => {
  if (!user) return location.href = "login.html";

  // Update Header
  document.getElementById("studentEmail").textContent = user.email;
  document.getElementById("studentId").textContent = user.uid.substring(0, 8) + "..."; // Shorten ID for UI

  // Fetch Data
  const studentSnap = await getDoc(doc(db,"students",user.uid));
  const coursesPaid = studentSnap.exists() ? (studentSnap.data().coursesPaid || []) : [];

  const paymentsSnap = await getDocs(
    query(collection(db,"payments"), where("studentId","==",user.uid))
  );

  const paymentMap = {};
  paymentsSnap.forEach(d => paymentMap[d.data().courseName] = {...d.data(), id: d.id});

  // Render Grid
  grid.innerHTML = "";

  courses.forEach(course => {
    const hasAccess = coursesPaid.includes(course.name);
    const payment = paymentMap[course.name];

    let badge = "", actionHtml = "";

    // Determine State
    if (hasAccess) {
      badge = `<div class="status-badge approved">Enrolled</div>`;
      actionHtml = `<button class="btn-success" onclick="startCourse('${course.name}')">Access Course Content</button>`;
    } else if (payment?.status === "pending") {
      badge = `<div class="status-badge pending">Payment Pending</div>`;
      actionHtml = `
        <button class="btn-pending" disabled>Waiting for Approval...</button>
        <button class="btn-cancel" onclick="cancelInvoice('${payment.id}')">Cancel Invoice</button>
      `;
    } else {
      actionHtml = `<button class="btn-primary" onclick="createInvoice('${course.name}', ${course.price})">Enroll Now</button>`;
    }

    // Generate Curriculum List HTML
    const curriculumHtml = course.curriculum.map(item => `
      <li>
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        ${item}
      </li>
    `).join("");

    // HTML Template
    grid.innerHTML += `
      <div class="card">
        ${badge}
        <div class="card-body">
          <h3 class="card-title">${course.name}</h3>
          
          <span class="section-label">Course Overview</span>
          <p class="course-overview">${course.overview}</p>

          <span class="section-label">Curriculum</span>
          <ul class="curriculum-list">
            ${curriculumHtml}
          </ul>
        </div>

        <div class="card-footer">
          <div class="price-tag">
            $${course.price}
            <span>One-time payment</span>
          </div>
          ${actionHtml}
        </div>
      </div>
    `;
  });
});

/* ðŸ§¾ CREATE INVOICE */
window.createInvoice = async (courseName, price) => {
  const user = auth.currentUser;
  if (!user) return;

  const confirmed = confirm(`Generate invoice for:\n\n${courseName}\n$${price}\n\nProceed?`);
  if (!confirmed) return;

  const existingQ = query(
    collection(db,"payments"),
    where("studentId","==",user.uid),
    where("courseName","==",courseName),
    where("status","==","pending")
  );
  const existingSnap = await getDocs(existingQ);

  if (!existingSnap.empty) {
    window.location.href = `student-details.html?invoiceId=${existingSnap.docs[0].id}`;
    return;
  }

  const docRef = await addDoc(collection(db,"payments"), {
    studentId: user.uid,
    studentName: user.displayName || "Student",
    email: user.email,
    courseName,
    price,
    paymentMethod: "Manual",
    invoiceNumber: `FBA-${Date.now()}`,
    status: "pending",
    createdAt: serverTimestamp()
  });

  window.location.href = `student-details.html?invoiceId=${docRef.id}`;
};

/* âŒ CANCEL PENDING INVOICE */
window.cancelInvoice = async (invoiceId) => {
  if (!confirm("Cancel this invoice?")) return;
  await deleteDoc(doc(db,"payments",invoiceId));
  location.reload();
};

/* â–¶ START COURSE */
window.startCourse = (courseName) => {
  const coursePages = {
    "Management": "management_course.html",
    "Food Business Management Course": "course-food-business-management.html",
    "Financial Management for Food Processors": "course-financial-management.html",
    "Food Value Addition Course for Farmers": "course-value-addition.html",
    "New Product Development and Management": "course-product-development.html"
  };
  const page = coursePages[courseName];
  if (page) {
    window.location.href = page;
  } else {
    alert("Course page not found.");
  }
};
</script>
</body>
</html>
