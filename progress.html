<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Learning Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --success: #10b981;
            --bg: #f8fafc;
        }

        body {
            margin: 0;
            font-family: Inter, system-ui, sans-serif;
            background: var(--bg);
            color: #1e293b;
        }

        .container {
            max-width: 1100px;
            margin: auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .controls {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        #courseSearch {
            padding: 12px 25px;
            border-radius: 25px;
            border: 1px solid #ddd;
            width: 100%;
            max-width: 420px;
            outline: none;
        }

        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 6px 16px rgba(0,0,0,0.05);
            transition: .3s;
        }

        .card:hover {
            transform: translateY(-4px);
        }

        .title {
            font-weight: 800;
            font-size: 1.2rem;
            margin-bottom: 12px;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #64748b;
        }

        .progress-bar {
            background: #f1f5f9;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin: 14px 0;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background: var(--primary);
            transition: width .6s ease;
        }

        .progress-fill.done {
            background: var(--success);
        }

        .meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            font-weight: bold;
        }

        .cert-badge {
            margin-top: 16px;
            padding: 12px;
            background: #ecfdf5;
            color: #065f46;
            border-radius: 10px;
            text-align: center;
            font-size: 13px;
            border: 1px solid #a7f3d0;
        }

        #loading {
            text-align: center;
            padding: 60px;
            color: var(--primary);
        }

        .empty {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ðŸš€ Student Dashboard</h1>
        <p>Live progress from published modules only</p>
    </div>

    <div class="controls">
        <input id="courseSearch" placeholder="Search courses..." onkeyup="filterCourses()">
    </div>

    <div id="loading">Loading your progressâ€¦</div>
    <div id="courseGrid" class="course-grid"></div>
</div>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
    apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
    authDomain: "students-login-29409.firebaseapp.com",
    projectId: "students-login-29409"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ================= AUTH ================= */
auth.onAuthStateChanged(user => {
    if (!user) return location.href = "login.html";
    loadDashboard(user.uid);
});

/* ================= LOAD DASHBOARD ================= */
async function loadDashboard(uid) {
    const grid = document.getElementById("courseGrid");
    const loading = document.getElementById("loading");

    try {
        const studentSnap = await db.collection("students").doc(uid).get();
        const enrolled = studentSnap.data()?.enrolledCourses;

        if (!enrolled) {
            loading.innerHTML = `<div class="empty">No enrolled courses.</div>`;
            return;
        }

        loading.style.display = "none";
        grid.innerHTML = "";

        for (const [courseId, data] of Object.entries(enrolled)) {

            // 1ï¸âƒ£ Get published modules
            const modsSnap = await db
                .collection("courses")
                .doc(courseId)
                .collection("modules")
                .where("status", "==", "published")
                .get();

            const publishedIds = modsSnap.docs.map(d => d.id);
            const total = publishedIds.length;

            // 2ï¸âƒ£ Normalize completed modules
            const completedRaw = data.completedModules || {};
            const completedIds = Object.keys(completedRaw);

            // 3ï¸âƒ£ Count ONLY published + completed
            const validCompleted = completedIds.filter(id =>
                publishedIds.includes(id)
            );

            const completedCount = validCompleted.length;
            const progress = total > 0
                ? Math.round((completedCount / total) * 100)
                : 0;

            renderCard(grid, {
                id: courseId,
                title: formatTitle(courseId),
                completed: completedCount,
                total,
                progress,
                done: progress === 100 && total > 0
            });
        }

    } catch (e) {
        console.error(e);
        loading.innerHTML = `<p style="color:red">Error loading dashboard</p>`;
    }
}

/* ================= RENDER ================= */
function renderCard(grid, c) {
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.name = c.id.toLowerCase();

    card.innerHTML = `
        <div class="title">${c.title}</div>

        <div class="stats-row">
            <span>Modules</span>
            <strong>${c.completed} / ${c.total}</strong>
        </div>

        <div class="progress-bar">
            <div class="progress-fill ${c.done ? 'done' : ''}"
                style="width:${c.progress}%"></div>
        </div>

        <div class="meta">
            <span>${c.progress}% COMPLETE</span>
            <span>${c.done ? 'âœ… FINISHED' : 'ðŸ“– STUDYING'}</span>
        </div>

        ${c.done ? `<div class="cert-badge">ðŸŽ“ Certificate Unlocked</div>` : ``}
    `;

    grid.appendChild(card);
}

/* ================= HELPERS ================= */
function formatTitle(id) {
    return id.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
}

function filterCourses() {
    const q = courseSearch.value.toLowerCase();
    document.querySelectorAll(".card").forEach(c => {
        c.style.display = c.dataset.name.includes(q) ? "block" : "none";
    });
}
</script>

</body>
</html>
