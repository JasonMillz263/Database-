<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Learning Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #6366f1; --success: #10b981; --bg: #f8fafc; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: #1e293b; }
        .container { max-width: 1100px; margin: auto; padding: 40px 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        
        .controls { display: flex; gap: 10px; margin-bottom: 30px; justify-content: center; }
        #courseSearch { padding: 12px 25px; border-radius: 25px; border: 1px solid #ddd; width: 100%; max-width: 400px; outline: none; transition: 0.3s; }
        #courseSearch:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }

        .course-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; }
        
        .card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: 0.3s; border: 1px solid #edf2f7; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 24px rgba(0,0,0,0.1); }
        
        .title { font-weight: 800; font-size: 1.2rem; margin-bottom: 12px; color: #1e293b; }
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 13px; color: #64748b; }
        
        .progress-container { margin: 15px 0; }
        .progress-bar { background: #f1f5f9; height: 12px; border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: var(--primary); transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .progress-fill.completed { background: var(--success); }
        
        .meta { display: flex; justify-content: space-between; font-size: 12px; margin-top: 10px; font-weight: bold; letter-spacing: 0.5px; }
        .cert-badge { margin-top: 18px; padding: 12px; background: #ecfdf5; color: #065f46; border-radius: 10px; font-size: 13px; font-weight: bold; text-align: center; border: 1px solid #a7f3d0; }
        
        #loading { text-align: center; padding: 60px; font-size: 1.1rem; color: #6366f1; }
        .empty-state { text-align: center; grid-column: 1 / -1; padding: 40px; color: #94a3b8; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ðŸš€ Student Dashboard</h1>
        <p>Your real-time course progress and certificates</p>
    </div>

    <div class="controls">
        <input type="text" id="courseSearch" placeholder="Search your courses..." onkeyup="filterCourses()">
    </div>

    <div id="loading">Connecting to your profile...</div>
    <div id="courseGrid" class="course-grid"></div>
</div>

<script>
// --- CONFIGURATION ---
const firebaseConfig = {
    apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
    authDomain: "students-login-29409.firebaseapp.com",
    projectId: "students-login-29409"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- AUTH OBSERVER ---
auth.onAuthStateChanged((user) => {
    if (user) {
        loadStudentData(user.uid);
    } else {
        window.location.href = "login.html";
    }
});

// --- CORE DATA LOADING ---
async function loadStudentData(uid) {
    const grid = document.getElementById("courseGrid");
    const loader = document.getElementById("loading");

    try {
        // 1. Get Student Data
        const studentDoc = await db.collection("students").doc(uid).get();

        if (!studentDoc.exists || !studentDoc.data().enrolledCourses) {
            loader.innerHTML = `
                <div class="empty-state">
                    <h3>No courses found.</h3>
                    <p>Enroll in a course to start tracking your progress!</p>
                </div>`;
            return;
        }

        const enrolledCourses = studentDoc.data().enrolledCourses;
        grid.innerHTML = "";
        loader.style.display = "none";

        // 2. Process each course
        for (const [courseId, userData] of Object.entries(enrolledCourses)) {
            
            // 3. Fetch current course structure to verify modules
            const courseDoc = await db.collection("courses").doc(courseId).get();
            
            if (!courseDoc.exists) continue;

            const courseData = courseDoc.data();
            const allModules = courseData.modules || [];
            
            // FILTER: Only include modules that are published and NOT deleted
            const validModules = allModules.filter(m => m.status === 'published' && !m.deleted);
            const totalValidCount = validModules.length;

            // BUG FIX: If course has no modules, skip it entirely
            if (totalValidCount === 0) continue;

            // 4. Calculate accurate progress based on valid modules
            const userCompletedKeys = userData.completedModules ? Object.keys(userData.completedModules) : [];
            const validCompletedCount = userCompletedKeys.filter(id => 
                validModules.some(m => m.id === id)
            ).length;

            const progress = Math.round((validCompletedCount / totalValidCount) * 100);
            const isDone = progress >= 100;

            // 5. Build UI Card
            const card = document.createElement("div");
            card.className = "card";
            card.setAttribute("data-name", courseId.toLowerCase());

            card.innerHTML = `
                <div class="title">${formatTitle(courseId)}</div>
                
                <div class="stats-row">
                    <span>Modules Finished:</span>
                    <strong>${validCompletedCount} / ${totalValidCount}</strong>
                </div>

                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill ${isDone ? 'completed' : ''}" style="width: ${progress}%"></div>
                    </div>
                </div>

                <div class="meta">
                    <span style="color: ${isDone ? 'var(--success)' : 'var(--primary)'}">
                        ${progress}% COMPLETE
                    </span>
                    <span>${isDone ? 'âœ… FINISHED' : 'ðŸ“– STUDYING'}</span>
                </div>

                ${isDone ? `
                    <div class="cert-badge">âœ¨ Certificate Unlocked & Ready</div>
                ` : `
                    <div style="font-size:11px; color:#94a3b8; margin-top:15px; text-align:center;">
                        Keep learning to earn your certificate
                    </div>
                `}
            `;
            grid.appendChild(card);
        }

    } catch (error) {
        console.error("Dashboard Error:", error);
        loader.innerHTML = `<p style="color:red">Error syncing data. Please check connection.</p>`;
    }
}

// --- HELPERS ---

function formatTitle(id) {
    return id.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase());
}

function filterCourses() {
    const query = document.getElementById("courseSearch").value.toLowerCase();
    const cards = document.querySelectorAll('.card');
    
    cards.forEach(card => {
        const name = card.getAttribute('data-name');
        card.style.display = name.includes(query) ? "block" : "none";
    });
}
</script>
</body>
</html>
