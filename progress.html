<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Learning Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #6366f1; --success: #10b981; --bg: #f8fafc; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: #1e293b; }
        .container { max-width: 1100px; margin: auto; padding: 40px 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        
        .controls { display: flex; gap: 10px; margin-bottom: 30px; justify-content: center; }
        /* UPDATED: Removed specific number from placeholder */
        #courseSearch { padding: 12px 25px; border-radius: 25px; border: 1px solid #ddd; width: 100%; max-width: 400px; outline: none; transition: 0.3s; }
        #courseSearch:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }

        .course-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; }
        
        .card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: 0.3s; border: 1px solid #edf2f7; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 24px rgba(0,0,0,0.1); }
        
        .title { font-weight: 800; font-size: 1.2rem; margin-bottom: 12px; color: #1e293b; }
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 13px; color: #64748b; }
        
        .progress-container { margin: 15px 0; }
        .progress-bar { background: #f1f5f9; height: 12px; border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: var(--primary); transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .progress-fill.completed { background: var(--success); }
        
        .meta { display: flex; justify-content: space-between; font-size: 12px; margin-top: 10px; font-weight: bold; letter-spacing: 0.5px; }
        .cert-badge { margin-top: 18px; padding: 12px; background: #ecfdf5; color: #065f46; border-radius: 10px; font-size: 13px; font-weight: bold; text-align: center; border: 1px solid #a7f3d0; }
        
        #loading { text-align: center; padding: 60px; font-size: 1.1rem; color: #6366f1; }
        .empty-state { text-align: center; grid-column: 1 / -1; padding: 40px; color: #94a3b8; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ðŸš€ Student Dashboard</h1>
        <p>Your real-time course progress and certificates</p>
    </div>

    <div class="controls">
        <input type="text" id="courseSearch" placeholder="Search your courses..." onkeyup="filterCourses()">
    </div>

    <div id="loading">Calculating latest progress...</div>
    <div id="courseGrid" class="course-grid"></div>
</div>

<script>
// --- CONFIGURATION ---
const firebaseConfig = {
    apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
    authDomain: "students-login-29409.firebaseapp.com",
    projectId: "students-login-29409"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- AUTH OBSERVER ---
auth.onAuthStateChanged((user) => {
    if (user) {
        loadStudentData(user.uid);
    } else {
        // Redirect if needed, or handle logout
        // window.location.href = "login.html";
        console.log("No user logged in");
    }
});

// --- CORE DATA LOADING (REWRITTEN) ---
async function loadStudentData(uid) {
    const grid = document.getElementById("courseGrid");
    const loader = document.getElementById("loading");

    try {
        // 1. Get Student's Enrolled List
        const studentDoc = await db.collection("students").doc(uid).get();

        if (!studentDoc.exists || !studentDoc.data().enrolledCourses) {
            renderEmptyState(loader);
            return;
        }

        const enrolledMap = studentDoc.data().enrolledCourses;
        const courseIds = Object.keys(enrolledMap);

        if (courseIds.length === 0) {
            renderEmptyState(loader);
            return;
        }

        // 2. Process courses in parallel to fetch "Source of Truth" module counts
        const coursePromises = courseIds.map(async (courseId) => {
            const studentCourseData = enrolledMap[courseId];
            
            // --- CRITICAL UPDATE: Fetch Valid Modules from DB ---
            // We assume modules are stored at: courses/{courseId}/modules
            // We filter for published ones immediately.
            const modulesSnapshot = await db.collection('courses').doc(courseId).collection('modules')
                .where('status', '==', 'published')
                .get();

            // Filter out 'deleted' ones if you use a specific flag like isDeleted
            // (If you actually delete the doc from Firestore, the query above is sufficient)
            const validModuleIds = [];
            modulesSnapshot.forEach(doc => {
                const data = doc.data();
                // If you have a soft delete field, uncomment the check below:
                // if (data.isDeleted !== true) { 
                    validModuleIds.push(doc.id);
                // }
            });

            const totalModules = validModuleIds.length;

            // --- BUG FIX: Hide empty courses (like Management) ---
            if (totalModules === 0) {
                return null; // This course will be filtered out later
            }

            // 3. Calculate Progress
            // We intersect student's completed IDs with the currently valid IDs
            const studentCompletedMap = studentCourseData.completedModules || {};
            const studentCompletedIds = Object.keys(studentCompletedMap);
            
            // Count how many completed modules are actually in the valid list
            let validCompletedCount = 0;
            studentCompletedIds.forEach(id => {
                if (validModuleIds.includes(id)) {
                    validCompletedCount++;
                }
            });

            const progressPercentage = Math.floor((validCompletedCount / totalModules) * 100);

            return {
                id: courseId,
                title: formatTitle(courseId),
                progress: progressPercentage,
                completedCount: validCompletedCount,
                totalCount: totalModules,
                isDone: progressPercentage >= 100
            };
        });

        // Wait for all calculations
        const coursesData = await Promise.all(coursePromises);
        
        // Remove nulls (empty courses)
        const activeCourses = coursesData.filter(c => c !== null);

        // Render
        grid.innerHTML = "";
        loader.style.display = "none";

        if (activeCourses.length === 0) {
            renderEmptyState(loader); // User has courses, but none have active modules
            return;
        }

        activeCourses.forEach(course => {
            const card = document.createElement("div");
            card.className = "card";
            card.setAttribute("data-name", course.id.toLowerCase());

            card.innerHTML = `
                <div class="title">${course.title}</div>
                
                <div class="stats-row">
                    <span>Active Modules:</span>
                    <strong>${course.completedCount} / ${course.totalCount}</strong>
                </div>

                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill ${course.isDone ? 'completed' : ''}" style="width: ${course.progress}%"></div>
                    </div>
                </div>

                <div class="meta">
                    <span style="color: ${course.isDone ? 'var(--success)' : 'var(--primary)'}">
                        ${course.progress}% COMPLETE
                    </span>
                    <span>${course.isDone ? 'âœ… FINISHED' : 'ðŸ“– STUDYING'}</span>
                </div>

                ${course.isDone ? `
                    <div class="cert-badge">âœ¨ Certificate Unlocked & Ready</div>
                ` : `
                    <div style="font-size:11px; color:#94a3b8; margin-top:15px; text-align:center;">
                        Keep learning to earn your certificate
                    </div>
                `}
            `;
            grid.appendChild(card);
        });

    } catch (error) {
        console.error("Dashboard Error:", error);
        loader.innerHTML = `<p style="color:red">Error syncing data. Please check console.</p>`;
    }
}

// --- HELPERS ---

function renderEmptyState(container) {
    container.innerHTML = `
        <div class="empty
