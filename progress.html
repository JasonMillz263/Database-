<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Learning Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #6366f1; --success: #10b981; --bg: #f8fafc; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: #1e293b; }
        .container { max-width: 1100px; margin: auto; padding: 40px 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        
        .controls { display: flex; gap: 10px; margin-bottom: 30px; justify-content: center; }
        #courseSearch { padding: 12px 25px; border-radius: 25px; border: 1px solid #ddd; width: 100%; max-width: 400px; outline: none; transition: 0.3s; }
        #courseSearch:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }

        .course-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; }
        
        .card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: 0.3s; border: 1px solid #edf2f7; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 24px rgba(0,0,0,0.1); }
        
        .title { font-weight: 800; font-size: 1.2rem; margin-bottom: 12px; color: #1e293b; }
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 13px; color: #64748b; }
        
        .progress-container { margin: 15px 0; }
        .progress-bar { background: #f1f5f9; height: 12px; border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: var(--primary); transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .progress-fill.completed { background: var(--success); }
        
        .meta { display: flex; justify-content: space-between; font-size: 12px; margin-top: 10px; font-weight: bold; letter-spacing: 0.5px; }
        .cert-badge { margin-top: 18px; padding: 12px; background: #ecfdf5; color: #065f46; border-radius: 10px; font-size: 13px; font-weight: bold; text-align: center; border: 1px solid #a7f3d0; }
        
        #loading { text-align: center; padding: 60px; font-size: 1.1rem; color: #6366f1; }
        .empty-state { text-align: center; grid-column: 1 / -1; padding: 40px; color: #94a3b8; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ðŸš€ Student Dashboard</h1>
        <p>Your real-time course progress and certificates</p>
    </div>

    <div class="controls">
        <input type="text" id="courseSearch" placeholder="Search your 5 courses..." onkeyup="filterCourses()">
    </div>

    <div id="loading">Connecting to your profile...</div>
    <div id="courseGrid" class="course-grid"></div>
</div>

<
                <script>
// --- CONFIGURATION ---
const firebaseConfig = {
    apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
    authDomain: "students-login-29409.firebaseapp.com",
    projectId: "students-login-29409"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- AUTH OBSERVER ---
auth.onAuthStateChanged((user) => {
    if (user) {
        loadStudentData(user.uid);
    } else {
        window.location.href = "login.html";
    }
});

// --- CORE DATA LOADING ---
async function loadStudentData(uid) {
    const grid = document.getElementById("courseGrid");
    const loader = document.getElementById("loading");

    try {
        // 1. Get Student Data
        const studentDoc = await db.collection("students").doc(uid).get();

        if (!studentDoc.exists || !studentDoc.data().enrolledCourses) {
            renderEmptyState(loader);
            return;
        }

        const enrolledCourses = studentDoc.data().enrolledCourses;
        grid.innerHTML = ""; // Clear loader
        loader.style.display = "none";

        // 2. Prepare to fetch "Master Data" for all enrolled courses
        // We map the object entries to a list of Promises
        const coursePromises = Object.entries(enrolledCourses).map(async ([courseId, studentData]) => {
            
            // Fetch the Master Course Document to see what is "Published"
            let publishedModuleCount = 0;
            let validModuleIds = [];

            try {
                const courseDoc = await db.collection("courses").doc(courseId).get();
                
                if (courseDoc.exists) {
                    const allModules = courseDoc.data().modules || {};
                    
                    // FILTER: Only keep modules where status is 'published'
                    validModuleIds = Object.keys(allModules).filter(modId => 
                        allModules[modId].status === 'published'
                    );
                    publishedModuleCount = validModuleIds.length;
                } else {
                    console.warn(`Course definition not found for: ${courseId}`);
                }
            } catch (err) {
                console.error(`Error fetching course details for ${courseId}`, err);
            }

            // 3. Calculate Real Progress
            // We count a module as done ONLY if the student has it AND it is currently published
            const studentCompleted = studentData.completedModules || {};
            
            const realCompletedCount = Object.keys(studentCompleted).filter(modId => 
                validModuleIds.includes(modId)
            ).length;

            // Recalculate percentage based on live data
            // Avoid division by zero if course has no published modules
            const realProgress = publishedModuleCount > 0 
                ? Math.round((realCompletedCount / publishedModuleCount) * 100) 
                : 0;

            return {
                id: courseId,
                title: formatTitle(courseId),
                completed: realCompletedCount,
                total: publishedModuleCount,
                progress: realProgress,
                isDone: realProgress >= 100 && publishedModuleCount > 0
            };
        });

        // 4. Wait for all data processing to finish, then render
        const courses = await Promise.all(coursePromises);

        courses.forEach(course => {
            renderCard(grid, course);
        });

    } catch (error) {
        console.error("Dashboard Error:", error);
        loader.innerHTML = `<p style="color:red">Error syncing data. Please check console.</p>`;
    }
}

// --- RENDERING ---
function renderCard(grid, course) {
    const card = document.createElement("div");
    card.className = "card";
    card.setAttribute("data-name", course.id.toLowerCase());

    card.innerHTML = `
        <div class="title">${course.title}</div>
        
        <div class="stats-row">
            <span>Modules Finished:</span>
            <strong>${course.completed} / ${course.total}</strong>
        </div>

        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill ${course.isDone ? 'completed' : ''}" style="width: ${course.progress}%"></div>
            </div>
        </div>

        <div class="meta">
            <span style="color: ${course.isDone ? 'var(--success)' : 'var(--primary)'}">
                ${course.progress}% COMPLETE
            </span>
            <span>${course.isDone ? 'âœ… FINISHED' : 'ðŸ“– STUDYING'}</span>
        </div>

        ${course.isDone ? `
            <div class="cert-badge">âœ¨ Certificate Unlocked & Ready</div>
        ` : `
            <div style="font-size:11px; color:#94a3b8; margin-top:15px; text-align:center;">
                Complete all published modules
            </div>
        `}
    `;
    grid.appendChild(card);
}

function renderEmptyState(loader) {
    loader.innerHTML = `
        <div class="empty-state">
            <h3>No courses found.</h3>
            <p>Enroll in a course to start tracking your progress!</p>
        </div>`;
}

// --- HELPERS ---
function formatTitle(id) {
    return id.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase());
}

function filterCourses() {
    const query = document.getElementById("courseSearch").value.toLowerCase();
    const cards = document.querySelectorAll('.card');
    cards.forEach(card => {
        const name = card.getAttribute('data-name');
        card.style.display = name.includes(query) ? "block" : "none";
    });
}
</script>
