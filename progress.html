<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Learning Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Palette */
            --primary-dark: #4c1d95; /* Deep Purple */
            --primary-light: #8b5cf6; /* Lighter Purple */
            --accent-blue: #3b82f6; /* Blue */
            --accent-yellow: #fbbf24; /* Amber/Yellow */
            --accent-red: #ef4444; /* Red */
            --bg-body: #f3f4f6;
            --text-main: #1f2937;
            --card-bg: #ffffff;
        }

        /* Dark Mode Support */
        [data-theme="dark"] {
            --bg-body: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f3f4f6;
        }

        body {
            margin: 0; font-family: 'Inter', sans-serif;
            background: var(--bg-body); color: var(--text-main);
            transition: background 0.3s, color 0.3s;
        }

        /* --- HERO SECTION --- */
        .hero {
            background: linear-gradient(135deg, var(--primary-dark), var(--accent-blue));
            color: white;
            padding: 40px 20px 80px; /* Extra padding bottom for overlap */
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            position: relative;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .hero-content { max-width: 1000px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .hero h1 { font-family: 'Playfair Display', serif; font-size: 2.5rem; margin: 0; }
        .hero p { opacity: 0.9; font-size: 1.1rem; margin-top: 10px; }
        
        .logout-btn {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4);
            color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer;
            font-weight: 600; backdrop-filter: blur(5px);
        }
        .logout-btn:hover { background: var(--accent-red); border-color: var(--accent-red); }

        /* --- MAIN GRID --- */
        .container {
            max-width: 1000px; margin: -50px auto 40px; padding: 0 20px;
            position: relative; z-index: 10;
        }

        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        /* --- COURSE CARD --- */
        .course-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            border-top: 5px solid transparent;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }

        /* Dynamic Border Colors based on status */
        .card-active { border-top-color: var(--primary-light); }
        .card-completed { border-top-color: var(--accent-yellow); }
        .card-locked { border-top-color: var(--accent-red); opacity: 0.8; }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .badge {
            font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; font-weight: 700; text-transform: uppercase;
        }
        .badge-active { background: #e0e7ff; color: var(--primary-dark); }
        .badge-done { background: #fef3c7; color: #b45309; }
        .badge-new { background: #fee2e2; color: var(--accent-red); }

        .course-title { font-size: 1.25rem; font-weight: 800; margin: 0 0 10px 0; color: var(--text-main); }
        .course-meta { font-size: 0.9rem; color: #6b7280; margin-bottom: 20px; }

        /* PROGRESS BAR DESIGN */
        .progress-wrapper { margin-bottom: 20px; }
        .progress-labels { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; }
        .progress-bg {
            height: 10px; background: #e5e7eb; border-radius: 10px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; border-radius: 10px; width: 0%;
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            /* Gradient for the bar */
            background: linear-gradient(90deg, var(--primary-light), var(--accent-blue));
        }
        
        /* Yellow fill for completed courses */
        .fill-complete { background: var(--accent-yellow); }

        /* BUTTONS */
        .card-footer { margin-top: auto; }
        .btn-course {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            font-weight: 600; cursor: pointer; text-align: center;
            font-size: 0.95rem; transition: background 0.2s;
            text-decoration: none; display: inline-block;
        }
        .btn-start { background: var(--primary-dark); color: white; }
        .btn-start:hover { background: var(--accent-blue); }
        
        .btn-certificate { background: var(--accent-yellow); color: #000; }
        .btn-certificate:hover { background: #fbbf24; filter: brightness(1.1); }

        /* LOADING STATE */
        .skeleton { animation: pulse 1.5s infinite; background: #e0e0e0; height: 20px; border-radius: 4px; margin-bottom: 10px; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

    </style>
</head>
<body>

<div class="hero">
    <div class="hero-content">
        <div>
            <h1>Student Portal</h1>
            <p>Welcome back! Here is your progress across all 5 courses.</p>
        </div>
        <button class="logout-btn" onclick="firebase.auth().signOut()">Sign Out</button>
    </div>
</div>

<div class="container">
    <div id="loadingGrid" class="course-grid">
        <div class="course-card"><div class="skeleton" style="height:150px"></div></div>
        <div class="course-card"><div class="skeleton" style="height:150px"></div></div>
        <div class="course-card"><div class="skeleton" style="height:150px"></div></div>
    </div>

    <div id="coursesGrid" class="course-grid" style="display:none;">
        </div>
</div>

<script>
    // --- 1. FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
        authDomain: "students-login-29409.firebaseapp.com",
        projectId: "students-login-29409"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- 2. MAIN LOGIC ---
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            loadDashboard(user);
        } else {
            // If not logged in, redirect to login page
            window.location.href = "index.html"; 
        }
    });

    async function loadDashboard(user) {
        const grid = document.getElementById('coursesGrid');
        const loader = document.getElementById('loadingGrid');
        
        try {
            // A. GET ALL COURSES (The "5 Courses")
            // We fetch the course definitions first to get Titles and Total Modules
            const coursesSnapshot = await db.collection('courses').get();
            
            // B. GET STUDENT PROGRESS
            const studentDoc = await db.collection('students').doc(user.uid).get();
            const studentData = studentDoc.data() || {};
            const enrolledData = studentData.enrolledCourses || {};

            let htmlContent = '';

            // C. LOOP THROUGH COURSES AND CALCULATE PROGRESS
            // This is the logic you asked for
            for (const doc of coursesSnapshot.docs) {
                const courseId = doc.id;
                const courseData = doc.data();
                
                // 1. Get Total Modules (Count the subcollection or use a field)
                // Note: Reading subcollections needs a separate query, 
                // so for efficiency, I assume you have a field 'totalModules' in the course doc.
                // If not, we set a default or we have to query the subcollection.
                let totalModules = courseData.totalModules || 5; // Default to 5 if not set
                
                // 2. Get User's Completed count
                const userCourseProgress = enrolledData[courseId] || {};
                const completedModulesMap = userCourseProgress.completedModules || {};
                const completedCount = Object.keys(completedModulesMap).length;

                // 3. Calculate Percentage
                let percent = Math.round((completedCount / totalModules) * 100);
                if (percent > 100) percent = 100; // Cap at 100

                // 4. Determine Status for UI
                let statusClass = 'card-active'; 
                let badgeHtml = `<span class="badge badge-active">In Progress</span>`;
                let btnHtml = `<a href="course.html?id=${courseId}" class="btn-course btn-start">Continue Learning</a>`;
                let fillClass = '';

                if (percent === 0) {
                    statusClass = 'card-locked';
                    badgeHtml = `<span class="badge badge-new">Not Started</span>`;
                    btnHtml = `<a href="course.html?id=${courseId}" class="btn-course btn-start" style="background:var(--text-main)">Start Course</a>`;
                } else if (percent === 100) {
                    statusClass = 'card-completed';
                    badgeHtml = `<span class="badge badge-done">Completed</span>`;
                    fillClass = 'fill-complete';
                    btnHtml = `<button class="btn-course btn-certificate" onclick="viewCertificate('${courseId}')">üèÜ View Certificate</button>`;
                }

                // 5. Generate HTML Card
                htmlContent += `
                    <div class="course-card ${statusClass}">
                        <div>
                            <div class="card-header">
                                <span style="font-size:2rem;">${courseData.icon || 'üìö'}</span>
                                ${badgeHtml}
                            </div>
                            <h3 class="course-title">${courseData.title || 'Untitled Course'}</h3>
                            <div class="course-meta">${completedCount} / ${totalModules} Modules</div>
                            
                            <div class="progress-wrapper">
                                <div class="progress-labels">
                                    <span>Progress</span>
                                    <span>${percent}%</span>
                                </div>
                                <div class="progress-bg">
                                    <div class="progress-fill ${fillClass}" style="width: ${percent}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            ${btnHtml}
                        </div>
                    </div>
                `;
            }

            // D. RENDER
            loader.style.display = 'none';
            grid.innerHTML = htmlContent;
            grid.style.display = 'grid';

        } catch (error) {
            console.error("Error loading dashboard:", error);
            grid.innerHTML = `<p>Error loading courses. Please check your internet connection.</p>`;
            loader.style.display = 'none';
            grid.style.display = 'block';
        }
    }

    function viewCertificate(courseId) {
        // You can link this to the previous code's certificate section
        // Or simply alert for now
        alert("Redirecting to certificate for Course ID: " + courseId);
        // window.location.href = `course_player.html?course=${courseId}&view=certificate`;
    }
</script>

</body>
</html>
