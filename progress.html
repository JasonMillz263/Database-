<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Student Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #6366f1; --success: #10b981; --bg: #f8fafc; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: #1e293b; }
        .container { max-width: 1100px; margin: auto; padding: 40px 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        
        /* Search & Filter Bar */
        .controls { display: flex; gap: 10px; margin-bottom: 30px; justify-content: center; }
        #courseSearch { padding: 12px 25px; border-radius: 25px; border: 1px solid #ddd; width: 100%; max-width: 400px; outline: none; transition: 0.3s; }
        #courseSearch:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }

        .course-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        
        .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: 0.3s; border: 1px solid #edf2f7; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        .title { font-weight: 800; font-size: 1.1rem; margin-bottom: 10px; color: #2d3748; }
        .module-info { font-size: 13px; color: #718096; background: #f7fafc; padding: 8px; border-radius: 8px; margin-bottom: 15px; }
        
        .progress-bar { background: #edf2f7; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: var(--primary); transition: width 1s ease; }
        .progress-fill.completed { background: var(--success); }
        
        .meta { display: flex; justify-content: space-between; font-size: 12px; margin-top: 8px; font-weight: bold; }
        .cert-badge { margin-top: 15px; padding: 10px; background: #f0fff4; color: #276749; border-radius: 8px; font-size: 12px; font-weight: bold; text-align: center; border: 1px solid #c6f6d5; }
        
        #loading { text-align: center; padding: 50px; font-weight: bold; color: #667eea; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üöÄ My Dashboard</h1>
        <p>Track your payments and course progress</p>
    </div>

    <div class="controls">
        <input type="text" id="courseSearch" placeholder="Filter courses..." onkeyup="filterCourses()">
    </div>

    <div id="loading">Syncing your enrollment data...</div>
    <div id="courseGrid" class="course-grid"></div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
    authDomain: "students-login-29409.firebaseapp.com",
    projectId: "students-login-29409"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

auth.onAuthStateChanged(async (user) => {
    if (!user) {
        window.location.href = "login.html";
        return;
    }
    loadData(user.uid);
});

async function loadData(uid) {
    const grid = document.getElementById("courseGrid");
    const loader = document.getElementById("loading");

    try {
        // 1. SCAN PAYMENTS: Find what courses the user has actually paid for
        // Assuming you have a 'payments' collection or a 'paidCourses' array in user doc
        // For this fix, we will pull all courses from the "courses" collection 
        // and match them against progress fields.
        
        const snapshot = await db.collection("courses").get();
        
        if (snapshot.empty) {
            loader.innerHTML = "No enrolled courses found.";
            return;
        }

        grid.innerHTML = "";
        loader.style.display = "none";

        snapshot.forEach(doc => {
            const data = doc.data();
            const courseId = doc.id;

            // --- THE FIX FOR THE 0% PROGRESS ISSUE ---
            // We check for several variations of "certificate" and "completed"
            const hasCert = data.certificateGenerated === true || 
                            data.certificate === true || 
                            data.status === "completed" ||
                            data.certificateGenerated === "true"; // handle string values

            let progressValue = 0;
            if (hasCert) {
                progressValue = 100;
            } else {
                progressValue = data.progress || 0;
            }

            const currentModule = data.currentModule || "Module 1: Getting Started";

            const card = document.createElement("div");
            card.className = "card";
            card.setAttribute("data-name", courseId.toLowerCase());

            card.innerHTML = `
                <div class="title">${formatTitle(courseId)}</div>
                <div class="module-info">
                    <strong>Current:</strong> ${hasCert ? "All Modules Finished" : currentModule}
                </div>
                <div class="progress-bar">
                    <div class="progress-fill ${hasCert ? 'completed' : ''}" style="width: ${progressValue}%"></div>
                </div>
                <div class="meta">
                    <span>${progressValue}% COMPLETE</span>
                    <span>${hasCert ? 'üèÜ DONE' : 'üî• LEARNING'}</span>
                </div>
                ${hasCert ? `
                    <div class="cert-badge">‚ú® Certificate Unlocked & Ready</div>
                ` : `
                    <div style="font-size:11px; color:#cbd5e0; margin-top:10px; text-align:center;">
                        Complete modules to earn certificate
                    </div>
                `}
            `;
            grid.appendChild(card);
        });

    } catch (err) {
        console.error(err);
        loader.innerHTML = "Error loading data. Check Firestore permissions.";
    }
}

function formatTitle(id) {
    return id.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase());
}

function filterCourses() {
    const val = document.getElementById("courseSearch").value.toLowerCase();
    document.querySelectorAll('.card').forEach(card => {
        card.style.display = card.getAttribute('data-name').includes(val) ? "block" : "none";
    });
}
</script>
</body>
</html>
