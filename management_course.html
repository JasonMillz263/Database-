<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Management Course</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>

/* ========= RESET ========= */
*{box-sizing:border-box}
html,body{margin:0;padding:0;width:100%;overflow-x:hidden;font-family:Inter,Segoe UI,sans-serif}

/* ========= THEME COLORS ========= */
:root{
 --lux-blue:#5b5fff;
 --lux-purple:#7a3cff;
 --lux-yellow:#ffb700;
 --lux-red:#ef4444;
 --lux-bg:#f4f6fb;
 --lux-card:#ffffff;
 --lux-dark:#0f1220;
 --lux-dark-card:#11172c;
 --lux-text-dark:#d7dbff;
}

body{
 background:var(--lux-bg);
 transition:0.3s;
}

/* ========= DARK MODE ========= */
body.dark{
 background:var(--lux-dark);
 color:#fff;
}

body.dark .card,
body.dark .module-preview,
body.dark .info-tag,
body.dark .module-full,
body.dark #certificateSection{
 background:var(--lux-dark-card);
 color:#fff;
 border-color:#1f2b4a;
}

/* ========= HEADER ========= */
.header{
 padding:18px;
 border-radius:0 0 22px 22px;
 background:linear-gradient(135deg,var(--lux-blue),var(--lux-purple));
 color:#fff;
}

/* Course title top */
.header h2{
 margin:6px 0 14px 0;
 font-size:22px;
 font-weight:800;
}

/* Row layouts */
.header-row{
 display:grid;
 gap:10px;
}

/* top row */
.info-row{
 grid-template-columns:1fr 1fr;
}

.info-tag{
 padding:10px;
 border-radius:12px;
 background:#ffffff20;
 font-size:14px;
}

/* second row */
.action-row{
 grid-template-columns:1fr 1fr;
}

.action-tag{
 padding:10px;
 border-radius:12px;
 background:#00000025;
 display:flex;
 align-items:center;
 justify-content:space-between;
}

.action-tag button{
 background:#fff;
 color:var(--lux-blue);
 border:none;
 padding:8px 10px;
 border-radius:8px;
 font-weight:600;
 cursor:pointer;
}

/* Dark toggle switch */
.toggle{
 cursor:pointer;
 font-size:14px;
}

/* ========= PROGRESS ========= */
.progress-bar{
 margin-top:14px;
 height:12px;
 border-radius:12px;
 background:#ffffff40;
}

.progress-fill{
 height:100%;
 width:0;
 background:white;
 border-radius:12px;
}

/* ========= MODULE LIST ========= */
.modules{
 margin-top:16px;
 display:flex;
 flex-direction:column;
 gap:14px;
}

/* Module preview card */
.module-preview{
 width:100%;
 border-radius:18px;
 border:2px solid var(--lux-blue);
 background:#fff;
 padding:12px;
 position:relative;
 overflow:hidden;
}

/* Image crop style (blogger look) */
.module-thumb{
 width:100%;
 height:190px;
 border-radius:14px;
 object-fit:cover;
 display:none;
}

.module-title{
 font-size:17px;
 font-weight:800;
 margin:10px 0 6px;
}

.module-short{
 font-size:14px;
 opacity:.9;
}

/* Read more button */
.read-btn{
 margin-top:10px;
 width:100%;
 background:var(--lux-blue);
 color:white;
 border:none;
 padding:10px;
 border-radius:10px;
 font-weight:700;
 cursor:pointer;
}

/* Hidden full lesson container */
.module-full{
 display:none;
 margin-top:12px;
 padding:12px;
 border-radius:16px;
 border:2px solid var(--lux-purple);
}

.lesson-content img{
 width:100%;
 height:220px;
 object-fit:cover;
 border-radius:14px;
 margin:10px 0;
}

/* ========= QUIZ ========= */
.quiz-box{
 margin-top:12px;
 padding:12px;
 border-radius:14px;
 border:2px dashed var(--lux-blue);
}

.timer{text-align:center;color:var(--lux-red);font-weight:800}

button{
 border:none;
 border-radius:12px;
 padding:12px;
 font-weight:700;
 background:var(--lux-blue);
 color:#fff;
 cursor:pointer;
}

button:disabled{background:#aaa}

/* ========= TTS BUTTON ========= */
.listen-btn{
 background:var(--lux-yellow);
 color:#000;
}

/* ========= CERTIFICATE SECTION ========= */
#certificateSection{
 display:none;
 margin-top:20px;
 padding:12px;
 border-radius:18px;
 background:#fff;
}

.certificate{max-width:100%;overflow:hidden}

/* MOBILE SUPPORT */
@media (max-width:768px){
 .certificate{transform:scale(.9);transform-origin:top center}
}

</style>
</head>

<body>

<div class="header">
  <h2>Management Course</h2>

  <div class="header-row info-row">
    <div class="info-tag">Email: <span id="studentEmail"></span></div>
    <div class="info-tag">ID: <span id="studentId"></span></div>
  </div>

  <div class="header-row action-row">
    <div class="action-tag">
      <span class="toggle" onclick="toggleDark()">üåô / ‚òÄÔ∏è Theme</span>
      <button onclick="location.href='https://jasonmillz263.github.io/Database-/student.html'">Dashboard</button>
    </div>
  </div>

  <div class="progress-bar">
    <div class="progress-fill" id="progressFill"></div>
  </div>

  <p id="progressText">0% Completed</p>
</div>

<div class="container">

  <div class="modules" id="modules"></div>

  <!-- CERTIFICATE SECTION WILL BE SHOWN AFTER COMPLETION -->
  <div id="certificateSection"></div><script>

firebase.initializeApp({
 apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
 authDomain:"students-login-29409.firebaseapp.com",
 projectId:"students-login-29409"
});

const auth=firebase.auth();
const db=firebase.firestore();

const COURSE_ID="management_course";
const PASS_MARK=60;
const QUESTION_TIME=20;

let activeModuleId=null;
let currentQuiz=[];
let currentQuestionIndex=0;
let currentScore=0;
let quizBox=null;
let quizTimer=null;
let timeLeft=QUESTION_TIME;

let ttsUtter=null;
let ttsPlaying=false;   // remembers state

let totalModuleCount=0;

/* ========= DARK MODE ========= */
function toggleDark(){
 document.body.classList.toggle("dark");
}

/* ========= AUTH ========= */
auth.onAuthStateChanged(async user=>{
 if(!user) return alert("Login required");

 studentEmail.innerText=user.email;
 studentId.innerText=user.uid;

 const ref=db.collection("students").doc(user.uid);
 if(!(await ref.get()).exists){
  await ref.set({email:user.email,enrolledCourses:{}});
 }

 loadModules(user);
});

/* ========= MODULE LOADING ========= */
async function loadModules(user){

 document.getElementById('certificateSection').style.display='none';

 const modsSnap=await db.collection("courses")
  .doc(COURSE_ID)
  .collection("modules")
  .where("status","==","published")
  .get();

 totalModuleCount=modsSnap.size;

 const snap=await db.collection("students").doc(user.uid).get();
 const completed=snap.data()?.enrolledCourses?.[COURSE_ID]?.completedModules||{};

 modules.innerHTML="";
 let done=0,index=1;

 modsSnap.forEach(doc=>{
  const m=doc.data(),id=doc.id;
  const passed=completed[id]===true;
  if(passed) done++;

  // extract image (first img tag if exists)
  let imgMatch=(m.content||"").match(/<img[^>]+src="([^"]+)"/i);
  let thumb=imgMatch?imgMatch[1]:null;

  let shortText=m.content.replace(/<[^>]*>?/gm,'').slice(0,120)+"...";

  const div=document.createElement("div");
  div.className="module-preview";

  div.innerHTML=`
     ${thumb?`<img src="${thumb}" class="module-thumb" style="display:block">`:''}

     <div class="module-title">Module ${index}: ${m.title}</div>

     <div class="module-short">${shortText}</div>

     <button class="read-btn" onclick="openModule('${id}', this)">Read More</button>

     <div class="module-full">
       <div class="lesson-content">${m.content}</div>

       <button class="listen-btn" onclick="toggleTTS(this)">‚ñ∂ Play / Pause</button>

       <div class="quiz-box"></div>
     </div>
  `;

  modules.appendChild(div);
  index++;
 });

 updateProgress(done,modsSnap.size);

 if(done===totalModuleCount && totalModuleCount>0){
   showCertificate();
 }
}

/* ========= OPEN MODULE (hide others) ========= */
function openModule(id,btn){

 document.querySelectorAll(".module-full").forEach(m=>m.style.display="none");

 const wrap=btn.closest(".module-preview").querySelector(".module-full");
 quizBox=wrap.querySelector(".quiz-box");

 activeModuleId=id;
 wrap.style.display="block";

 wrap.querySelector(".quiz-box").innerHTML=
   `<button onclick="startQuiz('${id}', this)">Start Quiz</button>`;
}

/* ========= TRUE PLAY / PAUSE MEMORY ========= */
function toggleTTS(btn){

 const content=btn.closest(".module-full").querySelector(".lesson-content");

 if(!content) return;

 if(ttsUtter && speechSynthesis.speaking && !speechSynthesis.paused){
    speechSynthesis.pause();
    ttsPlaying=false;
    btn.innerText="‚ñ∂ Resume";
    return;
 }

 if(ttsUtter && speechSynthesis.paused){
    speechSynthesis.resume();
    ttsPlaying=true;
    btn.innerText="‚è∏ Pause";
    return;
 }

 ttsUtter = new SpeechSynthesisUtterance(content.innerText);
 const voice = speechSynthesis.getVoices().find(v=>v.lang.startsWith("en")) || null;
 if(voice) ttsUtter.voice=voice;
 ttsUtter.rate=.95;

 speechSynthesis.speak(ttsUtter);
 btn.innerText="‚è∏ Pause";
 ttsPlaying=true;
}

/* ========= QUIZ ========= */
async function startQuiz(moduleId,btn){
 btn.disabled=true;
 currentQuestionIndex=0;
 currentScore=0;

 const snap=await db.collection("courses")
   .doc(COURSE_ID)
   .collection("modules")
   .doc(moduleId)
   .get();

 currentQuiz=snap.data().quizzes;
 quizBox=btn.closest(".quiz-box");

 clearInterval(quizTimer);
 timeLeft=QUESTION_TIME;

 quizTimer=setInterval(()=>{
   timeLeft--;
   const t=document.getElementById("timeLeft");
   if(t) t.innerText=timeLeft;
   if(timeLeft<=0){
     clearInterval(quizTimer);
     finishQuiz();
   }
 },1000);

 renderQuestion();
}

function renderQuestion(){
 const q=currentQuiz[currentQuestionIndex];
 const isLast=currentQuestionIndex===currentQuiz.length-1;

 quizBox.innerHTML=`
   <div class="timer">‚è± <span id="timeLeft">${timeLeft}</span>s</div>
   <p><strong>${q.question}</strong></p>
   <div class="options-group">
     ${q.options.map(o=>`
       <label><input type="radio" name="ans" value="${o}"> ${o}</label>
     `).join("")}
   </div>
   <button onclick="processSubmission()">${isLast?"Finish Quiz":"Next"}</button>
 `;
}

function processSubmission(){
 const sel=quizBox.querySelector("input[name='ans']:checked");
 if(!sel) return alert("Select an answer");

 const clean=s=>String(s).replace(/\s+/g," ").trim();

 if(clean(sel.value)===clean(currentQuiz[currentQuestionIndex].answer)){
   currentScore++;
 }

 currentQuestionIndex++;

 if(currentQuestionIndex<currentQuiz.length){
   renderQuestion();
 } else {
   clearInterval(quizTimer);
   finishQuiz();
 }
}

async function finishQuiz(){
 const percent=Math.round((currentScore/currentQuiz.length)*100);
 const passed=percent>=PASS_MARK;
 const user=auth.currentUser;

 if(user){
  await db.collection("students").doc(user.uid).set({
    enrolledCourses:{[COURSE_ID]:{completedModules:{[activeModuleId]:passed}}}
  },{merge:true});
 }

 quizBox.innerHTML=`
   <h3>Results</h3>
   <p><strong>${currentScore}/${currentQuiz.length}</strong> (${percent}%)</p>
   ${passed?'<p class="pass">PASSED</p>':'<p class="fail">FAILED</p>'}
   <button onclick="loadModules(auth.currentUser)">Continue</button>
 `;
}

function updateProgress(done,total){
 const p=total?Math.round(done/total*100):0;
 progressFill.style.width=p+"%";
 progressText.innerText=p+"% Completed";
}/* ========= CERTIFICATE ========= */
function showCertificate(){

 const cert = `
 <div class="certificate">

   <div class="top-band">
     <div class="logos">
        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhnNFRpSiba0ztBBehfuW2MWV7LjXfqoVWvjiHT_gLRNgmSSOQv74I5h9gVCyAF4RBjpeMbAYKSfmhpyE2v2ihNRlt4rC63vA0KIdHH0ZEkidtlm37CLrNV0Ty_vBfvQgRnfCmsGycBGwCE_sNedqdNStWhLbntzKfIVx6RFkNU6YIyRBplI0S-NODhKRNa/s1600/IMG-20251223-WA0001.jpg">
        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhIuGx_Tl93TWp5OZYxIn7iCPb3FhwXGTZTr_xVjfUAOy4dt2YzXq0c7H4VizrvCBNkCO12IlSymo4R-7Nq9mSffdpB9w6Yge3O2i0UovqE45XIW1jEyvZJg6sOjDfUUhdRJs2x_Bqui6goNnXmcV8hguXwcIUqsvMv5-kY-yNeo-Onr9TVspl88fBfiEsV/s1600/IMG-20251223-WA0001.png">
     </div>
   </div>

   <div class="content">
     <div class="title">Certificate of Completion</div>
     <div class="subtitle">This is to certify that</div>

     <div class="name" id="certName">PARTICIPANT</div>

     <div class="divider"></div>

     <div class="description">has successfully completed the course entitled</div>

     <div class="course" id="certCourse">Management Course</div>

     <div class="award">
       This certificate is awarded by <strong>FoodPreneur Business Academy</strong>,
       in partnership with <strong>RHAC</strong>.
     </div>
   </div>

 </div>

 <button onclick="window.print()">Print / Save PDF</button>
 `;

 const s=document.getElementById("certificateSection");
 s.innerHTML=cert;
 s.style.display="block";

 document.getElementById("certName").innerText =
   (auth.currentUser?.email || "").split("@")[0].toUpperCase();
}

</script>

</div>
</body>
</html>
