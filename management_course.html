<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Management Course</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:Poppins;background:#f4f4f4}
header{background:#4B0E17;color:#fff;padding:15px}
.container{max-width:1000px;margin:auto;padding:20px}
.card{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px}
.module{border-left:5px solid #4B0E17}
.locked{opacity:.45;pointer-events:none}
button{padding:10px 16px;border:none;border-radius:6px;cursor:pointer}
.complete{background:#4CAF50;color:#fff}
.quiz{margin-top:10px}
.progress{height:8px;background:#ddd;border-radius:5px;overflow:hidden}
.progress div{height:100%;background:#4CAF50}
img{max-width:100%;border-radius:8px}
iframe{width:100%;height:300px;border-radius:8px}
.topbar{font-size:14px;opacity:.9}
.score{margin-top:8px;font-weight:600}
</style>
</head>

<body>

<header>
  <h2>Management Course</h2>
  <div class="topbar" id="studentInfo"></div>
</header>

<div class="container">

<div class="card">
  <strong>Progress</strong>
  <div class="progress"><div id="progressBar"></div></div>
</div>

<div id="modules"></div>

<div class="card" id="certificateCard" style="display:none">
  <h3>ðŸŽ“ Certificate</h3>
  <p>Congratulations! You completed the Management Course.</p>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, getDocs,
  collection, setDoc, updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

/* ================= FIREBASE ================= */
const app = initializeApp({
  apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain:"students-login-29409.firebaseapp.com",
  projectId:"students-login-29409"
});

const db = getFirestore(app);
const auth = getAuth(app);

/* ================= CONFIG ================= */
const COURSE_ID = "management_course";
const MAX_ATTEMPTS = 3;

/* ================= STATE ================= */
let studentRef;
let completedModules = [];
let quizAnswers = {};
let quizScores = {};
let lastModule = null;

/* ================= AUTH ================= */
onAuthStateChanged(auth, async user=>{
  if(!user) return location.href="login.html";

  document.getElementById("studentInfo").innerHTML =
    `Email: ${user.email}<br>Student ID: ${user.uid}`;

  studentRef = doc(db,"students",user.uid);
  const snap = await getDoc(studentRef);

  if(!snap.exists()){
    await setDoc(studentRef,{
      completedModules:[],
      quiz:{},
      quizScores:{},
      progress:0,
      lastModule:null,
      lastAccessed:serverTimestamp()
    });
  }

  const data = (await getDoc(studentRef)).data();
  completedModules = data.completedModules || [];
  quizAnswers = data.quiz || {};
  quizScores = data.quizScores || {};
  lastModule = data.lastModule;

  loadModules();
});

/* ================= LOAD MODULES ================= */
async function loadModules(){
  const modulesDiv = document.getElementById("modules");
  modulesDiv.innerHTML = "";

  const snap = await getDocs(collection(db,"courses",COURSE_ID,"modules"));

  const modules = snap.docs
    .map(d => ({ id: d.id, ...d.data() }))
    .filter(m => m.status === "published")
    .sort((a,b) => a.order - b.order);

  if(modules.length === 0){
    modulesDiv.innerHTML = `
      <div class="card">
        <p>No published modules yet.</p>
      </div>`;
    return;
  }

  modules.forEach((m,i)=>{
    const done = completedModules.includes(m.id);
    const locked = i > 0 && !completedModules.includes(modules[i-1].id);
    const score = quizScores[m.id];

    modulesDiv.innerHTML += `
      <div class="card module ${locked?'locked':''}">
        <h3>${m.title}</h3>

        ${m.imageUrl ? `<img src="${m.imageUrl}">` : ""}

        ${m.videoUrl ? `<iframe src="${m.videoUrl}" allowfullscreen></iframe>` : ""}

        <div>${m.content}</div>

        ${renderQuiz(m)}

        ${score ? `
          <div class="score">
            Score: ${score.score}% |
            Attempts: ${score.attempts}/${MAX_ATTEMPTS}
          </div>` : ""
        }

        ${done
          ? "<p>âœ… Completed</p>"
          : `<button class="complete" onclick="submitQuiz('${m.id}',${modules.length})">
               Submit & Complete
             </button>`
        }
      </div>
    `;
  });

  updateProgress(modules.length);
}

/* ================= QUIZ ================= */
function renderQuiz(m){
  if(!m.quizzes?.length) return "";

  return `
    <div class="quiz">
      <h4>Quiz</h4>
      ${m.quizzes.map((q,i)=>`
        <p><strong>${q.question}</strong></p>
        ${q.options.map(o=>`
          <label>
            <input type="radio"
              name="${m.id}_${i}"
              ${quizAnswers[m.id]?.[i]===o?'checked':''}
              onchange="saveAnswer('${m.id}',${i},'${o}')">
            ${o}
          </label>
        `).join("")}
      `).join("")}
    </div>
  `;
}

/* ================= SAVE ANSWER ================= */
window.saveAnswer = async (moduleId,i,val)=>{
  quizAnswers[moduleId] = quizAnswers[moduleId] || {};
  quizAnswers[moduleId][i] = val;

  await updateDoc(studentRef,{
    quiz:quizAnswers,
    lastModule:moduleId,
    lastAccessed:serverTimestamp()
  });
};

/* ================= SUBMIT QUIZ ================= */
window.submitQuiz = async (moduleId,total)=>{
  const modSnap = await getDoc(doc(db,"courses",COURSE_ID,"modules",moduleId));
  const mod = modSnap.data();

  const answers = quizAnswers[moduleId] || {};
  let correct = 0;

  mod.quizzes.forEach((q,i)=>{
    if(answers[i] === q.answer) correct++;
  });

  const percent = Math.round((correct / mod.quizzes.length) * 100);
  const prev = quizScores[moduleId] || {attempts:0};

  if(prev.attempts >= MAX_ATTEMPTS){
    alert("Maximum attempts reached.");
    return;
  }

  quizScores[moduleId] = {
    score: percent,
    attempts: prev.attempts + 1,
    passed: percent === 100
  };

  await updateDoc(studentRef,{ quizScores });

  if(percent !== 100){
    alert(`Score ${percent}%. Retry allowed.`);
    return;
  }

  completedModules.push(moduleId);

  await updateDoc(studentRef,{
    completedModules,
    lastModule:moduleId
  });

  loadModules();
};

/* ================= PROGRESS ================= */
async function updateProgress(total){
  const percent = Math.round((completedModules.length / total) * 100);
  document.getElementById("progressBar").style.width = percent + "%";

  await updateDoc(studentRef,{ progress:percent });

  if(percent === 100){
    document.getElementById("certificateCard").style.display="block";
  }
}
</script>

</body>
</html>
