<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Course</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* ===== RESET & MOBILE BASE ===== */
*{box-sizing:border-box}
html,body{
  margin:0;
  padding:0;
  width:100%;
  overflow-x:hidden;
}
body{
  background:#f4f6fb;
  font-family:Inter,Segoe UI,sans-serif;
  user-select:none;
}

/* ===== LAYOUT ===== */
.container{
  width:100%;
  max-width:100%;
  padding:12px;
}

/* ===== HEADER ===== */
.header{
  background:linear-gradient(135deg,#5b5fff,#7a7eff);
  color:#fff;
  padding:16px;
  border-radius:16px;
}
.header h2{margin:0 0 6px;font-size:20px}
.header p{margin:4px 0;font-size:13px}

/* ===== PROGRESS ===== */
.progress-bar{
  height:10px;
  background:rgba(255,255,255,.3);
  border-radius:10px;
  margin-top:10px;
}
.progress-fill{height:100%;background:#fff}

/* ===== MODULES ===== */
.modules{
  margin-top:16px;
  display:flex;
  flex-direction:column;
  gap:14px;
}
.module{
  background:#fff;
  border:3px solid #5b5fff;
  border-radius:16px;
  padding:14px;
}
.module h2{
  font-size:16px;
  margin:0 0 8px;
}
.locked{opacity:.5}

/* ===== QUIZ ===== */
.quiz-box{
  margin-top:12px;
  padding:12px;
  border:2px dashed #5b5fff;
  border-radius:12px;
}
.timer{
  font-weight:bold;
  margin-bottom:8px;
}
.quiz-box label{
  display:block;
  padding:10px;
  margin:6px 0;
  background:#eef2ff;
  border-radius:10px;
}
.quiz-box input{
  margin-right:6px;
}

/* ===== BUTTONS ===== */
button{
  width:100%;
  padding:14px;
  margin-top:10px;
  border:none;
  border-radius:12px;
  background:#5b5fff;
  color:#fff;
  font-weight:600;
  font-size:15px;
}
button:disabled{background:#aaa}

/* ===== STATES ===== */
.pass{color:#1e8e3e;font-weight:bold}
.fail{color:#d93025;font-weight:bold}

/* ===== CERTIFICATE ===== */
#certificateBox{
  margin-top:16px;
  border:3px solid #16a34a;
}

/* ===== TABLET+ ===== */
@media(min-width:768px){
  .container{max-width:900px;margin:auto}
  .module h2{font-size:18px}
}
</style>
</head>

<body oncontextmenu="return false">
<div class="container">

<div class="header">
  <h2>Management Course</h2>
  <p id="studentEmail"></p>
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill"></div>
  </div>
  <p id="progressText">0% Completed</p>
</div>

<div class="modules" id="modules"></div>

<div id="certificateBox" class="module" style="display:none">
  <h2>üéì Certificate</h2>
  <button onclick="generateCertificate()">Generate Certificate</button>
</div>

</div>

<script>
/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain:"students-login-29409.firebaseapp.com",
  projectId:"students-login-29409"
});
const auth=firebase.auth();
const db=firebase.firestore();

const COURSE_ID="management_course";
const PASS_MARK=60;
const QUESTION_TIME=20;

/* ===== AUTH ===== */
auth.onAuthStateChanged(async user=>{
  if(!user) return alert("Login required");
  studentEmail.innerText=user.email;
  await initStudent(user);
  loadModules(user);
});

/* ===== INIT ===== */
async function initStudent(user){
  const ref=db.collection("students").doc(user.uid);
  if(!(await ref.get()).exists){
    await ref.set({email:user.email,enrolledCourses:{}});
  }
}

/* ===== LOAD MODULES ===== */
async function loadModules(user){
  const mods=await db.collection("courses").doc(COURSE_ID)
    .collection("modules").where("status","==","published").get();

  const studentSnap=await db.collection("students").doc(user.uid).get();
  const course=studentSnap.data().enrolledCourses?.[COURSE_ID]||{};
  const completed=course.completedModules||{};

  modules.innerHTML="";
  let done=0,i=1;
  let prevPassed=true;

  mods.forEach(doc=>{
    const m=doc.data(),id=doc.id;
    const isDone=completed[id];
    const locked=!prevPassed;

    if(isDone) done++;
    if(!isDone) prevPassed=false;

    const div=document.createElement("div");
    div.className="module"+(locked?" locked":"");
    div.innerHTML=`<h2>Module ${i}: ${m.title}</h2>${m.content}`;

    if(m.quizzes?.length){
      const box=document.createElement("div");
      box.className="quiz-box";

      if(locked){
        box.innerHTML="üîí Complete previous module first";
      }else if(isDone){
        box.innerHTML="<span class='pass'>Completed</span>";
      }else{
        box.innerHTML=`<button onclick="startQuiz('${id}')">Start Quiz</button>`;
      }
      div.appendChild(box);
    }

    modules.appendChild(div);
    i++;
  });

  updateProgress(done,mods.size);
  if(done===mods.size) certificateBox.style.display="block";
}

/* ===== QUIZ ENGINE ===== */
let currentQuiz=[],qIndex=0,score=0,timer,intUser;

async function startQuiz(moduleId){
  intUser=auth.currentUser;
  const snap=await db.collection("courses").doc(COURSE_ID)
    .collection("modules").doc(moduleId).get();
  currentQuiz=snap.data().quizzes;
  qIndex=0;score=0;
  showQuestion(moduleId);
}

function showQuestion(moduleId){
  const q=currentQuiz[qIndex];
  let time=QUESTION_TIME;

  const box=document.querySelector(".quiz-box");
  box.innerHTML=`
    <div class="timer">‚è± ${time}s</div>
    <p>${q.question}</p>
    ${q.options.map(o=>`
      <label><input type="radio" name="ans" value="${o}"> ${o}</label>
    `).join("")}
    <button id="nextBtn">Submit</button>
  `;

  timer=setInterval(()=>{
    time--;
    box.querySelector(".timer").innerText=`‚è± ${time}s`;
    if(time<=0) next(moduleId);
  },1000);

  document.getElementById("nextBtn").onclick=()=>next(moduleId);
}

async function next(moduleId){
  clearInterval(timer);
  const sel=document.querySelector("input[name='ans']:checked");
  if(sel&&sel.value===currentQuiz[qIndex].answer) score++;
  qIndex++;
  qIndex<currentQuiz.length?showQuestion(moduleId):finishQuiz(moduleId);
}

async function finishQuiz(moduleId){
  const percent=Math.round((score/currentQuiz.length)*100);
  const passed=percent>=PASS_MARK;

  await db.collection("students").doc(intUser.uid).set({
    enrolledCourses:{
      [COURSE_ID]:{
        completedModules:{[moduleId]:passed},
        quizResults:{[moduleId]:{percent,passed}}
      }
    }
  },{merge:true});

  alert(passed?`PASSED ${percent}%`:`FAILED ${percent}%`);
  loadModules(intUser);
}

/* ===== PROGRESS ===== */
function updateProgress(d,t){
  const p=t?Math.round(d/t*100):0;
  progressFill.style.width=p+"%";
  progressText.innerText=p+"% Completed";
}

/* ===== CERTIFICATE ===== */
function generateCertificate(){
  alert("Certificate unlocked ‚úî");
}

/* ===== ANTI-CHEAT ===== */
document.addEventListener("copy",e=>e.preventDefault());
document.addEventListener("keydown",e=>{
  if(e.key==="PrintScreen") alert("Screenshots disabled");
});
</script>
</body>
</html>
