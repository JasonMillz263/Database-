<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Course</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;padding:0;width:100%;overflow-x:hidden}
body{background:#f4f6fb;font-family:Inter,Segoe UI,sans-serif}

.container{padding:12px}
img{max-width:100%;height:auto}

.lesson-content img{
  max-width:100%;
  border-radius:12px;
  display:block;
  margin:12px auto;
}

.header{
  background:linear-gradient(135deg,#5b5fff,#7a7eff);
  color:#fff;
  padding:16px;
  border-radius:16px
}

.nav-buttons{display:flex;gap:10px;margin:10px 0}
.nav-buttons button{
  flex:1;background:#fff;color:#5b5fff;border:none;
  padding:10px;border-radius:10px;font-weight:600;cursor:pointer
}

.progress-bar{height:10px;background:rgba(255,255,255,.3);border-radius:10px}
.progress-fill{height:100%;background:#fff;width:0}

.modules{margin-top:16px;display:flex;flex-direction:column;gap:14px}

.module{
  background:#fff;border:3px solid #5b5fff;
  border-radius:16px;padding:14px
}

.locked{opacity:.5}

.quiz-box{
  margin-top:12px;padding:12px;
  border:2px dashed #5b5fff;border-radius:12px
}

button{
  width:100%;padding:14px;margin-top:8px;
  border:none;border-radius:12px;
  background:#5b5fff;color:#fff;font-weight:600;cursor:pointer
}

button:disabled{background:#aaa}
.pass{color:#16a34a;font-weight:bold}
.fail{color:#dc2626;font-weight:bold}
.score-tag{background:#16a34a;color:#fff;padding:4px 10px;border-radius:12px;font-size:13px}
.timer{text-align:center;color:#dc2626;font-weight:700}

/* CERTIFICATE */
.certificate-box{
  margin-top:30px;
  background:#fff;
  padding:20px;
  border-radius:16px;
  border:3px solid #16a34a;
  display:none;
}

.certificate{
  margin-top:20px;
  padding:30px;
  border:2px solid #ddd;
  text-align:center;
}

.cert-logos{
  display:flex;
  justify-content:space-between;
  margin-bottom:20px;
}

.cert-logos img{height:60px}

input{
  width:calc(50% - 8px);
  padding:12px;
  margin:4px;
  border-radius:8px;
  border:1px solid #ccc;
}

.certificate-box button{
  width:100%;
  margin-top:12px;
}
</style>
</head>

<body>
<div class="container">

<div class="header">
  <h2>Management Course</h2>
  <p>Email: <span id="studentEmail"></span></p>
  <p>ID: <span id="studentId"></span></p>

  <div class="nav-buttons">
    <button onclick="location.href='student.html'">‚¨Ö Courses</button>
    <button onclick="location.href='student.html'">üè† Dashboard</button>
  </div>

  <div class="progress-bar">
    <div class="progress-fill" id="progressFill"></div>
  </div>
  <p id="progressText">0% Completed</p>
</div>

<div class="modules" id="modules"></div>

<!-- CERTIFICATE SECTION -->
<div class="certificate-box" id="certificateBox">
  <h2>üéâ Congratulations!</h2>
  <p>You have completed all modules. Enter your name to generate your certificate.</p>

  <input id="fname" placeholder="First Name">
  <input id="lname" placeholder="Surname">
  <button onclick="generateCertificate()">Generate Certificate</button>

  <div id="certificate" class="certificate" style="display:none;">
    <div class="cert-logos">
      <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjxMsFTTcGbD2cXWdxIuETewXRpnOyFdmg6EyFu4z7veTIxf5dWbjRYvW8CYzay30IX9kkgbfwzgPkjQf64XZGTkmOTzak6LnjOgCL1o4kBvwZl0TRlH1bAS_KhsHCA9_5PsgppQQs9A2DR-ynbj3-DwfYS1gxCYzhRGVOliLI2BQs0s9PG3_oa4yzXjj/s1600/Lumii_20251221_225044758.png">
      <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhnNFRpSiba0ztBBehfuW2MWV7LjXfqoVWvjiHT_gLRNgmSSOQv74I5h9gVCyAF4RBjpeMbAYKSfmhpyE2v2ihNRlt4rC63vA0KIdHH0ZEkidtlm37CLrNV0Ty_vBfvQgRnfCmsGycBGwCE_sNedqdNStWhLbntzKfIVx6RFkNU6YIyRBplI0S-NODhKRNa/s1600/IMG-20251223-WA0001.jpg">
    </div>

    <h1 id="certName"></h1>
    <p>has successfully completed</p>
    <h3>Management Course</h3>
    <p>Awarded by <strong>FOODPRENEUR BUSINESS ACADEMY</strong></p>
    <p id="certDate"></p>

    <button onclick="window.print()">Print / Save PDF</button>
  </div>
</div>

</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain:"students-login-29409.firebaseapp.com",
  projectId:"students-login-29409"
});

const auth = firebase.auth();
const db = firebase.firestore();

const COURSE_ID = "management_course";
const PASS_MARK = 60;
const QUESTION_TIME = 20;

let activeModuleId=null;
let currentQuiz=[];
let currentQuestionIndex=0;
let currentScore=0;
let quizBox=null;
let quizTimer=null;
let timeLeft=QUESTION_TIME;

auth.onAuthStateChanged(async user=>{
  if(!user) return alert("Login required");

  studentEmail.innerText=user.email;
  studentId.innerText=user.uid;

  const ref=db.collection("students").doc(user.uid);
  if(!(await ref.get()).exists){
    await ref.set({email:user.email,enrolledCourses:{}});
  }
  loadModules(user);
});

async function loadModules(user){
  const modsSnap=await db.collection("courses")
    .doc(COURSE_ID)
    .collection("modules")
    .where("status","==","published")
    .get();

  const snap=await db.collection("students").doc(user.uid).get();
  const completed=snap.data()?.enrolledCourses?.[COURSE_ID]?.completedModules||{};

  modules.innerHTML="";
  let done=0,prev=true,index=1;

  modsSnap.forEach(doc=>{
    const m=doc.data(),id=doc.id;
    const passed=completed[id]===true;
    if(passed) done++;
    const locked=index>1&&!prev;
    prev=passed;

    const div=document.createElement("div");
    div.className="module"+(locked?" locked":"");
    div.innerHTML=`
      <h3>Module ${index}: ${m.title} ${passed?'<span class="score-tag">‚úì</span>':''}</h3>
      <div class="lesson-content">${m.content}</div>
    `;

    const box=document.createElement("div");
    box.className="quiz-box";

    if(locked){
      box.innerHTML="üîí Complete previous module first";
    }else if(passed){
      box.innerHTML="<span class='pass'>Completed</span>";
    }else{
      box.innerHTML=`<button onclick="startQuiz('${id}',this)">Start Quiz</button>`;
    }

    div.appendChild(box);
    modules.appendChild(div);
    index++;
  });

  updateProgress(done,modsSnap.size);
  checkCertificateEligibility();
}

async function startQuiz(moduleId,btn){
  btn.disabled=true;
  activeModuleId=moduleId;
  currentQuestionIndex=0;
  currentScore=0;

  const snap=await db.collection("courses")
    .doc(COURSE_ID).collection("modules")
    .doc(moduleId).get();

  currentQuiz=snap.data().quizzes;
  quizBox=btn.closest(".quiz-box");

  const moduleDiv=quizBox.closest(".module");
  moduleDiv.querySelector(".lesson-content").style.display="none"; 

  clearInterval(quizTimer);
  timeLeft=QUESTION_TIME;

  quizTimer=setInterval(()=>{
    timeLeft--;
    const t=document.getElementById("timeLeft");
    if(t) t.innerText=timeLeft;
    if(timeLeft<=0){
      clearInterval(quizTimer);
      finishQuiz(); 
    }
  },1000);

  renderQuestion();
}

function renderQuestion(){
  const q=currentQuiz[currentQuestionIndex];
  const isLast=currentQuestionIndex===currentQuiz.length-1;

  quizBox.innerHTML=`
    <div class="timer">‚è± <span id="timeLeft">${timeLeft}</span>s</div>
    <p><strong>${q.question}</strong></p>
    <div class="options-group">
      ${q.options.map(o=>`
        <label><input type="radio" name="ans" value="${o}"> ${o}</label>
      `).join("")}
    </div>
    <button onclick="processSubmission()">${isLast?"Finish Quiz":"Next Question"}</button>
  `;
}

function processSubmission(){
  const sel=quizBox.querySelector("input[name='ans']:checked");
  if(!sel) return alert("Select an answer");

  const clean=s=>String(s).replace(/\s+/g," ").trim();
  if(clean(sel.value)===clean(currentQuiz[currentQuestionIndex].answer)){
    currentScore++;
  }

  currentQuestionIndex++;
  
  if(currentQuestionIndex<currentQuiz.length){
    renderQuestion();
  }else{
    clearInterval(quizTimer); 
    quizBox.innerHTML=`
      <h3>Quiz Completed!</h3>
      <p>Processing results...</p>
    `;
    finishQuiz(); 
  }
}

async function finishQuiz(){
  clearInterval(quizTimer); 

  const percent=Math.round((currentScore/currentQuiz.length)*100);
  const passed=percent>=PASS_MARK;

  const user = auth.currentUser;

  if (user) {
      const ref=db.collection("students").doc(user.uid);
      try {
          await ref.set({
            enrolledCourses:{
              [COURSE_ID]:{
                completedModules:{[activeModuleId]:passed}
              }
            }
          },{merge:true});
      } catch (e) {
          console.error("Failed to save progress:", e);
      }
  }

  quizBox.innerHTML=`
    <h3>Results</h3>
    <p>Total Score: <strong>${currentScore}/${currentQuiz.length}</strong> (${percent}%)</p>
    ${passed?'<p class="pass">‚úÖ PASSED</p>':'<p class="fail">‚ùå FAILED</p>'}
    <button onclick="loadModules(auth.currentUser)">Continue</button>
  `;

  const moduleDiv=quizBox.closest(".module");
  if (moduleDiv) moduleDiv.querySelector(".lesson-content").style.display="block";
}

function updateProgress(done,total){
  const p=total?Math.round(done/total*100):0;
  progressFill.style.width=p+"%";
  progressText.innerText=p+"% Completed";
}

function checkCertificateEligibility(){
  const modulesDivs=document.querySelectorAll(".module");
  let completed=0;
  modulesDivs.forEach(m=>{
    if(m.querySelector(".pass")) completed++;
  });
  if(completed===modulesDivs.length && modulesDivs.length>0){
    document.getElementById("certificateBox").style.display="block";
  }
}

function generateCertificate(){
  const f=fname.value.trim();
  const l=lname.value.trim();
  if(!f||!l) return alert("Enter full name");

  certName.innerText=f+" "+l;
  certDate.innerText="Completed on "+new Date().toDateString();
  certificate.style.display="block";
}
</script>
</body>
</html>
