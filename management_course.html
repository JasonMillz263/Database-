<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Course</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;padding:0;width:100%;overflow-x:hidden}
body{background:#f4f6fb;font-family:Inter,Segoe UI,sans-serif}

/* Image size fix */
img{max-width:100%;height:auto;object-fit:contain;display:block;margin:12px auto}

/* Layout */
.container{width:100%;padding:12px}
.header{background:linear-gradient(135deg,#5b5fff,#7a7eff);color:#fff;padding:16px;border-radius:16px}
.progress-bar{height:10px;background:rgba(255,255,255,.3);border-radius:10px}
.progress-fill{height:100%;background:#fff}

.modules{margin-top:16px;display:flex;flex-direction:column;gap:14px}
.module{background:#fff;border:3px solid #5b5fff;border-radius:16px;padding:14px}
.locked{opacity:.5}

.quiz-box{margin-top:12px;padding:12px;border:2px dashed #5b5fff;border-radius:12px}
.quiz-box label{display:block;padding:10px;margin:6px 0;background:#eef2ff;border-radius:10px}

button{width:100%;padding:14px;margin-top:10px;border:none;border-radius:12px;background:#5b5fff;color:#fff;font-weight:600}
button:disabled{background:#aaa}

.pass{color:#16a34a;font-weight:bold}
.fail{color:#dc2626;font-weight:bold}
.score-tag{background:#16a34a;color:#fff;padding:4px 10px;border-radius:12px;font-size:13px;margin-left:6px}
.listen-btn{background:#ffb700;color:#000;font-weight:600;margin-top:8px}
</style>
</head>

<body>
<div class="container">

<div class="header">
  <h2>Management Course</h2>
  <p id="studentEmail"></p>
  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  <p id="progressText">0% Completed</p>
</div>

<div class="modules" id="modules"></div>

<div id="certificateBox" class="module" style="display:none">
  <h2>üéì Certificate</h2>
  <button onclick="generateCertificate()">Generate Certificate</button>
</div>

</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain:"students-login-29409.firebaseapp.com",
  projectId:"students-login-29409"
});
const auth=firebase.auth();
const db=firebase.firestore();

const COURSE_ID="management_course";
const PASS_MARK=60;
const QUESTION_TIME=20;

let activeModuleId = null;
let currentQuiz = [];
let currentQuestionIndex = 0;
let currentScore = 0;
let quizBox = null;
let quizTimer = null;

// Text-to-Speech
let ttsUtter = null;
let ttsPaused = false;

/* ===== AUTH ===== */
auth.onAuthStateChanged(async user=>{
  if(!user) return alert("Login required");
  studentEmail.innerText=user.email;
  await initStudent(user);
  loadModules(user);
});

async function initStudent(user){
  const ref=db.collection("students").doc(user.uid);
  if(!(await ref.get()).exists){
    await ref.set({email:user.email,enrolledCourses:{}});
  }
}

/* ===== LOAD MODULES ===== */
async function loadModules(user){
  const mods=await db.collection("courses").doc(COURSE_ID)
    .collection("modules").where("status","==","published").get();

  const student=(await db.collection("students").doc(user.uid).get()).data();
  const course=student.enrolledCourses?.[COURSE_ID]||{};
  const completed=course.completedModules||{};

  modules.innerHTML="";
  let done = 0;
  let prevPassed = true;
  let i = 1;

  mods.forEach(doc=>{
    const m = doc.data(), id = doc.id;
    const passed = completed[id] === true;
    const locked = !prevPassed;

    if(passed) done++;
    prevPassed = passed || i === 1;

    const div = document.createElement("div");
    div.className = "module" + (locked ? " locked" : "");
    div.innerHTML = `<h2>Module ${i}: ${m.title} ${passed?'<span class="score-tag">‚úì</span>':''}</h2>${m.content}`;

    const box = document.createElement("div");
    box.className = "quiz-box";

    if(locked){
      box.innerHTML = "üîí Complete previous module first";
    }else if(passed){
      box.innerHTML = "<span class='pass'>Completed</span>";
    }else{
      box.innerHTML = `
        <button onclick="startQuiz('${id}', this)">Start Quiz</button>
        <button class="listen-btn" onclick="readAloud(this)">üîä Listen</button>
        <button class="listen-btn" onclick="pauseTTS()">‚è∏ Pause/Resume</button>
      `;
    }

    div.appendChild(box);
    modules.appendChild(div);
    i++;
  });

  updateProgress(done,mods.size);
  if(done===mods.size) certificateBox.style.display="block";
}

/* ===== QUIZ ENGINE ===== */
async function startQuiz(moduleId, btn){
  btn.disabled = true;
  activeModuleId = moduleId;
  const snap = await db.collection("courses").doc(COURSE_ID)
    .collection("modules").doc(moduleId).get();
  currentQuiz = snap.data().quizzes;
  currentQuestionIndex = 0;
  currentScore = 0;

  quizBox = btn.closest(".quiz-box");
  renderQuestion();
}

function renderQuestion(){
  clearInterval(quizTimer);
  const q = currentQuiz[currentQuestionIndex];
  let time = QUESTION_TIME;

  quizBox.innerHTML = `
    <div class="timer">‚è± ${time}s</div>
    <p>${q.question}</p>
    ${q.options.map(o=>`<label><input type="radio" name="ans" value="${o}"> ${o}</label>`).join("")}
    <button id="submitBtn">Submit</button>
  `;

  quizTimer = setInterval(()=>{
    time--;
    quizBox.querySelector(".timer").innerText = `‚è± ${time}s`;
    if(time <= 0) submitAnswer();
  },1000);

  quizBox.querySelector("#submitBtn").onclick = submitAnswer;
}

function submitAnswer(){
  clearInterval(quizTimer);
  const sel = quizBox.querySelector("input[name='ans']:checked");
  if(sel && sel.value === currentQuiz[currentQuestionIndex].answer) currentScore++;
  currentQuestionIndex++;
  if(currentQuestionIndex < currentQuiz.length){
    renderQuestion();
  } else {
    finishQuiz();
  }
}

/* ===== FINISH QUIZ + RETRY ===== */
async function finishQuiz(){
  const percent = Math.round((currentScore / currentQuiz.length) * 100);
  const passed = percent >= PASS_MARK;

  const studentRef = db.collection("students").doc(auth.currentUser.uid);
  await studentRef.set({
    enrolledCourses:{
      [COURSE_ID]:{
        completedModules:{
          [activeModuleId]: passed ? true : false
        },
        quizResults:{
          [activeModuleId]:{
            percent,
            passed,
            lastAttempt: firebase.firestore.FieldValue.serverTimestamp()
          }
        }
      }
    }
  },{ merge:true });

  if(passed){
    quizBox.innerHTML = `<p class="pass">‚úÖ PASSED ‚Äî ${percent}%</p>`;
    alert(`PASSED ‚Äî ${percent}%`);
  } else {
    quizBox.innerHTML = `
      <p class="fail">‚ùå FAILED ‚Äî ${percent}%</p>
      <p><strong>üìñ Please review the lesson before retrying.</strong></p>
      <button onclick="retryQuiz()">Retry Quiz</button>
    `;
    alert(`FAILED ‚Äî ${percent}%`);
  }

  loadModules(auth.currentUser);
}

function retryQuiz(){
  currentQuestionIndex = 0;
  currentScore = 0;
  renderQuestion();
}

/* ===== TEXT-TO-SPEECH ===== */
function readAloud(button){
  const moduleDiv = button.closest(".module");
  const text = moduleDiv.innerText
                .replaceAll("Start Quiz","")
                .replaceAll("Retry Quiz","")
                .replaceAll("Listen","")
                .replaceAll("PASSED","")
                .replaceAll("FAILED","");
  if(ttsUtter) speechSynthesis.cancel();
  ttsUtter = new SpeechSynthesisUtterance(text);
  ttsUtter.rate = 1;
  ttsUtter.pitch = 1;
  speechSynthesis.speak(ttsUtter);
  ttsPaused = false;
}

function pauseTTS(){
  if(speechSynthesis.speaking && !speechSynthesis.paused){
    speechSynthesis.pause();
    ttsPaused = true;
  } else if(speechSynthesis.paused){
    speechSynthesis.resume();
    ttsPaused = false;
  }
}

/* ===== PROGRESS ===== */
function updateProgress(d,t){
  const p = t ? Math.round(d/t*100) : 0;
  progressFill.style.width = p+"%";
  progressText.innerText = p+"% Completed";
}

/* ===== CERTIFICATE ===== */
function generateCertificate(){
  alert("Certificate unlocked üéâ");
}

/* ===== ANTI-CHEAT ===== */
document.addEventListener("copy",e=>e.preventDefault());
document.addEventListener("keydown",e=>{
  if(e.key==="PrintScreen") alert("Screenshots disabled");
});
</script>
</body>
</html>
