<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Course</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#f7f9fc;
  font-family:Inter,system-ui,sans-serif;
  color:#1f2937;
}

.container{max-width:1100px;margin:auto;padding:20px}

/* HEADER */
.header{
  background:#fff;
  padding:20px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.06);
  position:sticky;
  top:0;
  z-index:10;
}

.progress-wrap{margin-top:10px}
.progress-bar{height:8px;background:#e5e7eb;border-radius:8px;overflow:hidden}
.progress-fill{height:100%;background:#6366f1;width:0}

/* MODULES */
.modules{margin-top:24px;display:grid;gap:20px}

.module-card{
  background:#fff;
  border-radius:18px;
  box-shadow:0 10px 25px rgba(0,0,0,.06);
  padding:20px;
  position:relative;
  overflow:hidden;
}

.module-card.locked::after{
  content:"üîí Locked";
  position:absolute;
  inset:0;
  background:rgba(255,255,255,.9);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  font-weight:700;
}

.module-title{
  font-size:20px;
  font-weight:700;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.lesson-content{margin:14px 0;line-height:1.7}

/* QUIZ */
.quiz-box{
  border-top:1px dashed #e5e7eb;
  margin-top:16px;
  padding-top:16px;
}

.quiz-timer{
  font-weight:600;
  margin-bottom:10px;
}

.quiz-option{
  display:block;
  padding:12px;
  border-radius:10px;
  background:#f1f5f9;
  margin-bottom:10px;
  cursor:pointer;
}

.quiz-option input{margin-right:8px}

/* BUTTONS */
button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
  background:#6366f1;
  color:#fff;
}

button.secondary{background:#fbbf24;color:#000}
button.danger{background:#ef4444}
button:disabled{opacity:.6;cursor:not-allowed}

.pass{color:#16a34a;font-weight:700}
.fail{color:#dc2626;font-weight:700}
</style>
</head>

<body>
<div class="container">

<div class="header">
  <h2>Management Course</h2>
  <p id="studentEmail"></p>
  <div class="progress-wrap">
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <small id="progressText">0% completed</small>
  </div>
</div>

<div class="modules" id="modules"></div>

</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain:"students-login-29409.firebaseapp.com",
  projectId:"students-login-29409"
});

const auth=firebase.auth();
const db=firebase.firestore();

const COURSE_ID="management_course";
const PASS_MARK=60;
const QUESTION_TIME=20;

/* QUIZ STATE */
let quizState="idle"; // idle | running | finished
let quizTimer=null;
let quizBox=null;
let quizData=[];
let qIndex=0;
let score=0;
let activeModule=null;

/* AUTH */
auth.onAuthStateChanged(async user=>{
  if(!user) return alert("Login required");
  studentEmail.innerText=user.email;
  loadModules(user);
});

/* LOAD MODULES */
async function loadModules(user){
  const mods=await db.collection("courses").doc(COURSE_ID)
    .collection("modules").where("status","==","published").get();

  const snap=await db.collection("students").doc(user.uid).get();
  const data=snap.data()||{};
  const completed=data.enrolledCourses?.[COURSE_ID]?.completedModules||{};

  modules.innerHTML="";
  let done=0;
  let prevPassed=true;
  let i=1;

  mods.forEach(doc=>{
    const m=doc.data(),id=doc.id;
    const passed=completed[id]===true;
    const locked=i>1 && !prevPassed;

    if(passed) done++;
    prevPassed=passed;

    const card=document.createElement("div");
    card.className="module-card"+(locked?" locked":"");
    card.innerHTML=`
      <div class="module-title">
        <span>Module ${i}: ${m.title}</span>
        ${passed?"‚úÖ":""}
      </div>
      <div class="lesson-content">${m.content}</div>
      <div class="quiz-box">
        ${passed
          ? "<p class='pass'>Completed</p>"
          : `<button onclick="startQuiz('${id}',this)">Start Quiz</button>`}
      </div>
    `;
    modules.appendChild(card);
    i++;
  });

  updateProgress(done,mods.size);
}

/* START QUIZ */
async function startQuiz(id,btn){
  if(quizState==="running") return;

  quizState="running";
  btn.disabled=true;

  const snap=await db.collection("courses").doc(COURSE_ID)
    .collection("modules").doc(id).get();

  quizData=snap.data().quizzes;
  qIndex=0;
  score=0;
  activeModule=id;
  quizBox=btn.closest(".quiz-box");

  showQuestion();
}

/* SHOW QUESTION */
function showQuestion(){
  clearInterval(quizTimer);

  if(qIndex>=quizData.length){
    finishQuiz();
    return;
  }

  let time=QUESTION_TIME;
  const q=quizData[qIndex];

  quizBox.innerHTML=`
    <div class="quiz-timer">‚è± ${time}s</div>
    <p><strong>${q.question}</strong></p>
    ${q.options.map(o=>`
      <label class="quiz-option">
        <input type="radio" name="ans" value="${o}"> ${o}
      </label>`).join("")}
    <button id="submitBtn">Submit</button>
  `;

  quizTimer=setInterval(()=>{
    time--;
    quizBox.querySelector(".quiz-timer").innerText=`‚è± ${time}s`;
    if(time<=0){
      clearInterval(quizTimer);
      submitAnswer();
    }
  },1000);

  quizBox.querySelector("#submitBtn").onclick=submitAnswer;
}

/* SUBMIT ANSWER */
function submitAnswer(){
  if(quizState!=="running") return;

  clearInterval(quizTimer);
  quizState="processing";

  const sel=quizBox.querySelector("input[name='ans']:checked");
  if(sel && sel.value===quizData[qIndex].answer) score++;

  qIndex++;
  quizState="running";
  showQuestion();
}

/* FINISH QUIZ ‚Äî GUARANTEED EXECUTION */
async function finishQuiz(){
  quizState="finished";
  clearInterval(quizTimer);

  const percent=Math.round(score/quizData.length*100);
  const passed=percent>=PASS_MARK;

  const ref=db.collection("students").doc(auth.currentUser.uid);
  const snap=await ref.get();
  const data=snap.data()||{};
  const course=data.enrolledCourses?.[COURSE_ID]||{};
  const completed=course.completedModules||{};

  completed[activeModule]=passed;

  await ref.set({
    enrolledCourses:{
      [COURSE_ID]:{completedModules:completed}
    }
  },{merge:true});

  quizBox.innerHTML=passed
    ? `<p class="pass">‚úÖ PASSED ‚Äî ${percent}%</p>`
    : `<p class="fail">‚ùå FAILED ‚Äî ${percent}%</p>
       <button class="danger" onclick="retryQuiz()">Retry Quiz</button>`;

  loadModules(auth.currentUser);
}

/* RETRY */
function retryQuiz(){
  quizState="idle";
  qIndex=0;
  score=0;
  showQuestion();
}

/* PROGRESS */
function updateProgress(d,t){
  const p=t?Math.round(d/t*100):0;
  progressFill.style.width=p+"%";
  progressText.innerText=p+"% completed";
}
</script>
</body>
</html>
