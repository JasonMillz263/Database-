<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>Student Course</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>

/* ========= RESET & THEME ========= */
*{box-sizing:border-box;margin:0;padding:0}

body{
  font-family: Inter, Segoe UI, sans-serif;
  background:#f5f5f7;
  transition: background .3s, color .3s;
}

body.dark{
  background:#0d1117;
  color:#e6e6e6;
}

.container{
  padding:14px;
  max-width:1100px;
  margin:auto;
}

img{
  max-width:100%;
  height:auto;
  border-radius:14px;
}

/* ========= HEADER ========= */

.header{
  padding:18px;
  margin-bottom:14px;
  border-radius:18px;
  background:#ffffff;
  box-shadow:0 10px 22px rgba(0,0,0,.08);
}

body.dark .header{
  background:#161b22;
}

.header h2{
  font-size:22px;
  font-weight:700;
  color:#111;
}

body.dark .header h2{
  color:#fff;
}

/* COURSE NAME TOP */
.course-title{
  font-size:24px;
  font-weight:700;
  margin-bottom:12px;
}

/* INFO CARDS */
.info-row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin:10px 0;
}

.info-card{
  background:#f0f2ff;
  padding:10px;
  border-radius:12px;
  font-size:14px;
}

body.dark .info-card{
  background:#1d2635;
}

/* ACTION BAR */

.action-row{
  display:flex;
  gap:10px;
  margin-top:6px;
}

.action-box{
  flex:1;
  background:#fff3d9;
  padding:10px;
  border-radius:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:14px;
}

body.dark .action-box{
  background:#2a1f00;
}

.action-box button{
  background:#5b5fff;
  color:#fff;
  padding:8px 14px;
  border:none;
  border-radius:10px;
  cursor:pointer;
}

.toggle-theme{
  background:#000;
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:10px;
  cursor:pointer;
}

body.dark .toggle-theme{
  background:#fff;
  color:#000;
}

/* Progress */
.progress-bar{
  height:10px;
  background:#dcdcdc;
  border-radius:12px;
  margin-top:14px;
}

.progress-fill{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#f5a623,#ffd700);
  border-radius:12px;
}

/* ========= MODULE LUXURY STYLE ========= */

.modules{
  margin-top:14px;
  display:flex;
  flex-direction:column;
  gap:14px;
}

.module{
  width:100%;
  background:#ffffff;
  border-radius:18px;
  padding:16px;
  box-shadow:0 8px 16px rgba(0,0,0,.08);
}

body.dark .module{
  background:#0f172a;
}

.module h3{
  font-size:18px;
  margin-bottom:6px;
}

.module .preview{
  margin:10px 0;
}

.read-more{
  background:#f7931e;
  color:#fff;
  padding:10px;
  border:none;
  border-radius:10px;
  cursor:pointer;
}

/* FULL MODULE VIEW */
.full-module{
  display:none;
}

/* ========= CERTIFICATE NEW DESIGN ========= */

#certificateSection{
  display:none;
}

#certificateContainer{
  display:none;
}

.certificate{
    width:100%;
    max-width:794px;
    margin:auto;
    background:#ffffff;
    border:14px solid #f7931e;
}

@media(max-width:900px){
  .certificate{border-width:8px}
}

.top-band{
  height:160px;
  background:linear-gradient(135deg,#f7931e 60%,#cfcfcf 60%);
  padding:20px;
  display:flex;
  align-items:center;
}

.logos{
  width:100%;
  background:#fff;
  padding:14px;
  display:flex;
  justify-content:space-between;
  border-radius:6px;
}

.content{padding:50px 20px;text-align:center}

/* ========= MOBILE FIX ========= */

.lesson-content img{
  width:100%;
  height:auto;
}

/* ========= QUIZ ========= */

.quiz-box{margin-top:14px}

/* ========= PLAY / PAUSE TTS ========= */

.listen-btn{
  background:#ffb700;
  color:#000;
  margin-top:6px;
}

</style>
</head>

<body>
<div class="container">

<div class="header">

  <div class="course-title">Management Course</div>

  <div class="info-row">
    <div class="info-card">Email: <span id="studentEmail"></span></div>
    <div class="info-card">ID: <span id="studentId"></span></div>
  </div>

  <div class="action-row">
    <div class="action-box">
        Dashboard
        <button onclick="location.href='https://jasonmillz263.github.io/Database-/student.html'">Open</button>
    </div>

    <div class="action-box">
        Theme
        <button class="toggle-theme" onclick="toggleTheme()">Light / Dark</button>
    </div>
  </div>

  <div class="progress-bar">
    <div class="progress-fill" id="progressFill"></div>
  </div>

  <p id="progressText">0% Completed</p>

</div>

<div id="modules" class="modules"></div>

<div id="certificateSection">
  <!-- FORM will remain, certificate will show when ready -->
  <div id="nameInput"></div>
  <div id="certificateContainer"></div>
</div><script>

firebase.initializeApp({
  apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain:"students-login-29409.firebaseapp.com",
  projectId:"students-login-29409"
});

const auth = firebase.auth();
const db = firebase.firestore();

const COURSE_ID = "management_course";
const PASS_MARK = 60;
const QUESTION_TIME = 20;

let activeModuleId=null;
let currentQuiz=[];
let currentQuestionIndex=0;
let currentScore=0;
let quizBox=null;
let quizTimer=null;
let timeLeft=QUESTION_TIME;
let ttsUtter=null;
let totalModuleCount=0;

/* ==== THEME ==== */
function toggleTheme(){
  document.body.classList.toggle("dark");
  localStorage.setItem("theme",
    document.body.classList.contains("dark") ? "dark" : "light");
}

if(localStorage.getItem("theme")==="dark"){
  document.body.classList.add("dark");
}

/* ==== AUTH ==== */

auth.onAuthStateChanged(async user=>{
if(!user) return;

studentEmail.innerText=user.email;
studentId.innerText=user.uid;

const ref=db.collection("students").doc(user.uid);
if(!(await ref.get()).exists){
await ref.set({email:user.email,enrolledCourses:{}});
}

loadModules(user);
});

/* ==== TTS PLAY / PAUSE (REAL RESUME) ==== */

function toggleTTS(btn){
  const content = btn.closest(".module").querySelector(".lesson-content");

  if(!content) return;

  // resume
  if(speechSynthesis.paused){
    speechSynthesis.resume();
    btn.innerText="⏸ Pause";
    return;
  }

  // pause while speaking
  if(speechSynthesis.speaking){
    speechSynthesis.pause();
    btn.innerText="▶ Play";
    return;
  }

  // start fresh
  if(ttsUtter) speechSynthesis.cancel();

  ttsUtter = new SpeechSynthesisUtterance(content.innerText);
  ttsUtter.rate=.95;
  ttsUtter.pitch=1;
  speechSynthesis.speak(ttsUtter);
  btn.innerText="⏸ Pause";
}

/* ==== LOAD MODULES (SUMMARY MODE) ==== */

async function loadModules(user){

document.getElementById('certificateSection').style.display = 'none';

const modsSnap=await db.collection("courses")
.doc(COURSE_ID)
.collection("modules")
.where("status","==","published")
.get();

totalModuleCount = modsSnap.size;

const snap=await db.collection("students").doc(user.uid).get();
const completed=snap.data()?.enrolledCourses?.[COURSE_ID]?.completedModules||{};

modules.innerHTML="";
let done=0,index=1;

modsSnap.forEach(doc=>{
const m=doc.data(),id=doc.id;
const passed=completed[id]===true;
if(passed) done++;

const div=document.createElement("div");
div.className="module";

div.innerHTML=`
  <h3>${m.title} ${passed?'<span style="color:green">✓</span>':''}</h3>

  <div class="preview">
    ${m.image?`<img src="${m.image}">`:''}
    <p>${(m.content||"").slice(0,120)}...</p>
  </div>

  <button class="read-more" onclick="openModule('${id}', this)">Read More</button>
`;

modules.appendChild(div);
index++;
});

updateProgress(done,modsSnap.size);

if(done===totalModuleCount && totalModuleCount>0){
  showCertificateInput();
}
}

/* ==== OPEN FULL MODULE ==== */

async function openModule(moduleId, btn){

const parent = btn.closest(".module");

modules.querySelectorAll(".module").forEach(m=>{
  if(m!==parent) m.style.display="none";
});

const snap=await db.collection("courses")
.doc(COURSE_ID)
.collection("modules")
.doc(moduleId).get();

const m=snap.data();

parent.innerHTML=`
  <h3>${m.title}</h3>

  <div class="lesson-content">${m.content}</div>

  <button class="listen-btn" onclick="toggleTTS(this)">▶ Play</button>

  <div class="quiz-box">
      <button onclick="startQuiz('${moduleId}', this)">Start Quiz</button>
  </div>

  <button onclick="loadModules(auth.currentUser)" style="margin-top:10px;background:#555">Back</button>
`;
}

/* ==== QUIZ ==== */

async function startQuiz(moduleId,btn){
btn.disabled=true;
activeModuleId=moduleId;
currentQuestionIndex=0;
currentScore=0;

const snap=await db.collection("courses")
.doc(COURSE_ID).collection("modules")
.doc(moduleId).get();

currentQuiz=snap.data().quizzes;
quizBox=btn.closest(".quiz-box");

clearInterval(quizTimer);
timeLeft=QUESTION_TIME;

quizTimer=setInterval(()=>{
timeLeft--;
const t=document.getElementById("timeLeft");
if(t) t.innerText=timeLeft;
if(timeLeft<=0){
clearInterval(quizTimer);
finishQuiz();
}
},1000);

renderQuestion();
}

function renderQuestion(){
const q=currentQuiz[currentQuestionIndex];
const isLast=currentQuestionIndex===currentQuiz.length-1;

quizBox.innerHTML=
`
<div class="timer">⏱ <span id="timeLeft">${timeLeft}</span>s</div>
<p><strong>${q.question}</strong></p>

${q.options.map(o=>`
<label><input type="radio" name="ans" value="${o}"> ${o}</label>
`).join("")}

<button onclick="processSubmission()">${isLast?"Finish Quiz":"Next"}</button>
`;
}

function processSubmission(){
const sel=quizBox.querySelector("input[name='ans']:checked");
if(!sel) return alert("Select an answer");

if(sel.value.trim()==currentQuiz[currentQuestionIndex].answer.trim()){
currentScore++;
}

currentQuestionIndex++;

if(currentQuestionIndex<currentQuiz.length){
renderQuestion();
}else{
clearInterval(quizTimer);
finishQuiz();
}
}

async function finishQuiz(){
clearInterval(quizTimer);

const percent=Math.round((currentScore/currentQuiz.length)*100);
const passed=percent>=PASS_MARK;

const user=auth.currentUser;

if(user){
await db.collection("students").doc(user.uid).set({
enrolledCourses:{
[COURSE_ID]:{
completedModules:{[activeModuleId]:passed}
}
}
},{merge:true});
}

quizBox.innerHTML=
`
<h3>Results</h3>
<p>${currentScore}/${currentQuiz.length} (${percent}%)</p>
${passed?'<p style="color:green">PASSED</p>':'<p style="color:red">FAILED</p>'}
<button onclick="loadModules(auth.currentUser)">Continue</button>
`;

loadModules(user);
}

/* ==== PROGRESS ==== */

function updateProgress(done,total){
const p=total?Math.round(done/total*100):0;
progressFill.style.width=p+"%";
progressText.innerText=p+"% Completed";
}

/* ==== CERT ==== */

function showCertificateInput(){
document.getElementById('modules').style.display='none';
document.getElementById('certificateSection').style.display='block';

document.getElementById('nameInput').innerHTML=`
  <h3>Congratulations! Enter your name</h3>
  <input id="certName" placeholder="Full Name" style="width:100%;padding:10px;margin:10px 0">
  <button onclick="generateCertificate()">Generate</button>
`;

}

function generateCertificate(){

const name=document.getElementById("certName").value.toUpperCase();

document.getElementById('certificateContainer').style.display='block';

document.getElementById('certificateContainer').innerHTML=
`
<div class="certificate">

<div class="top-band">
<div class="logos">
<img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhnNFRpSiba0ztBBehfuW2MWV7LjXfqoVWvjiHT_gLRNgmSSOQv74I5h9gVCyAF4RBjpeMbAYKSfmhpyE2v2ihNRlt4rC63vA0KIdHH0ZEkidtlm37CLrNV0Ty_vBfvQgRnfCmsGycBGwCE_sNedqdNStWhLbntzKfIVx6RFkNU6YIyRBplI0S-NODhKRNa/s1600/IMG-20251223-WA0001.jpg">
<img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhIuGx_Tl93TWp5OZYxIn7iCPb3FhwXGTZTr_xVjfUAOy4dt2YzXq0c7H4VizrvCBNkCO12IlSymo4R-7Nq9mSffdpB9w6Yge3O2i0UovqE45XIW1jEyvZJg6sOjDfUUhdRJs2x_Bqui6goNnXmcV8hguXwcIUqsvMv5-kY-yNeo-Onr9TVspl88fBfiEsV/s1600/IMG-20251223-WA0001.png">
</div>
</div>

<div class="content">
<div class="title">Certificate of Completion</div>
<div class="subtitle">This is to certify that</div>
<div class="name">${name}</div>
<div class="divider"></div>
<div class="description">has successfully completed</div>
<div class="course">Management Course</div>
</div>

</div>

<button onclick="window.print()">Print / Save PDF</button>
`;
}

</script></div>
</body>
  </html>
