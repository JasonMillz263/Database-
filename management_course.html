<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Management Course</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* ================= ROOT THEME ================= */
:root {
  --bg: #f6f7fb;
  --card: #ffffff;
  --text: #1f2937;
  --muted: #6b7280;
  --primary: #4f46e5;
  --accent: #f7931e;
  --border: #e5e7eb;
}

[data-theme="dark"] {
  --bg: #0f172a;
  --card: #111827;
  --text: #e5e7eb;
  --muted: #9ca3af;
  --border: #1f2937;
}

/* ================= BASE ================= */
* { box-sizing: border-box }
body {
  margin: 0;
  font-family: Inter, Segoe UI, sans-serif;
  background: var(--bg);
  color: var(--text);
  transition: background .3s, color .3s;
}

.container {
  max-width: 1100px;
  margin: auto;
  padding: 20px;
}

/* ================= HEADER ================= */
.header {
  background: linear-gradient(135deg, #4f46e5, #6366f1);
  color: #fff;
  border-radius: 18px;
  padding: 22px 28px;
  box-shadow: 0 10px 30px rgba(0,0,0,.15);
  animation: fadeSlide .6s ease;
}

@keyframes fadeSlide {
  from { opacity: 0; transform: translateY(-12px); }
  to { opacity: 1; transform: translateY(0); }
}

.header-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.academy {
  font-size: 15px;
  opacity: .9;
}

.course-title {
  font-size: 26px;
  font-weight: 700;
  margin: 6px 0;
}

.header-actions {
  display: flex;
  gap: 10px;
}

.header-actions button {
  background: rgba(255,255,255,.15);
  border: none;
  color: #fff;
  padding: 8px 14px;
  border-radius: 10px;
  cursor: pointer;
}

/* ================= PROGRESS ================= */
.progress-wrap {
  margin-top: 16px;
}

.progress-bar {
  height: 8px;
  background: rgba(255,255,255,.3);
  border-radius: 999px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  width: 0;
  background: #fff;
  transition: width .4s ease;
}

.progress-text {
  font-size: 13px;
  margin-top: 6px;
  opacity: .9;
}

/* ================= MODULES (UDEMY STYLE) ================= */
.modules {
  margin-top: 28px;
  background: var(--card);
  border-radius: 16px;
  overflow: hidden;
  border: 1px solid var(--border);
}

.module {
  border-bottom: 1px solid var(--border);
  padding: 18px 22px;
}

.module:last-child { border-bottom: none }

.module-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
}

.module-title {
  font-weight: 600;
}

.module-status {
  font-size: 13px;
  color: var(--muted);
}

.lesson-content {
  display: none;
  margin-top: 14px;
  line-height: 1.6;
}

.module.active .lesson-content {
  display: block;
}

/* ================= QUIZ / BUTTONS ================= */
.quiz-box button {
  margin-top: 10px;
  width: 100%;
  background: var(--primary);
  color: #fff;
  border: none;
  padding: 12px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
}

.listen-btn {
  background: var(--accent);
  color: #000;
}

/* ================= DARK MODE SWITCH ================= */
.theme-switch {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
}

.theme-switch input {
  width: 40px;
  height: 20px;
}

/* ================= CERTIFICATE ================= */
#certificateSection { display:none }

/* ================= RESPONSIVE ================= */
@media(max-width:768px){
  .course-title { font-size: 22px }
}
</style>
</head>

<body>
<div class="container">

<!-- ===== HEADER ===== -->
<div class="header">
  <div class="header-top">
    <div>
      <div class="academy">FoodPreneur Business Academy</div>
      <div class="course-title">Management Course</div>
    </div>

    <div class="header-actions">
      <div class="theme-switch">
        üåô <input type="checkbox" id="themeToggle">
      </div>
      <button onclick="location.href='student.html'">Dashboard</button>
    </div>
  </div>

  <div class="progress-wrap">
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <div class="progress-text" id="progressText">0% Completed</div>
  </div>
</div>

<!-- ===== MODULES ===== -->
<div class="modules" id="modules"></div>

<!-- CERTIFICATE SECTION (hidden, injected later) -->
<div id="certificateSection"></div>

<script>
/* THEME */
const toggle = document.getElementById('themeToggle');
const saved = localStorage.getItem('theme');
if(saved){
  document.documentElement.dataset.theme = saved;
  toggle.checked = saved === 'dark';
}
toggle.onchange = () => {
  const t = toggle.checked ? 'dark' : 'light';
  document.documentElement.dataset.theme = t;
  localStorage.setItem('theme', t);
};
</script>


<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain:"students-login-29409.firebaseapp.com",
  projectId:"students-login-29409"
});

const auth = firebase.auth();
const db = firebase.firestore();

const COURSE_ID = "management_course";
const PASS_MARK = 60;
const QUESTION_TIME = 20;

/* ================= STATE ================= */
let activeModuleId = null;
let currentQuiz = [];
let currentQuestionIndex = 0;
let currentScore = 0;
let quizBox = null;
let quizTimer = null;
let timeLeft = QUESTION_TIME;

/* ================= ANDROID TTS ================= */
let ttsUtterance = null;

function setupMediaSession() {
  if (!('mediaSession' in navigator)) return;

  navigator.mediaSession.metadata = new MediaMetadata({
    title: 'Course Lesson Audio',
    artist: 'FoodPreneur Business Academy',
    album: 'Management Course'
  });

  navigator.mediaSession.setActionHandler('play', () => {
    speechSynthesis.resume();
  });

  navigator.mediaSession.setActionHandler('pause', () => {
    speechSynthesis.pause();
  });

  navigator.mediaSession.setActionHandler('stop', () => {
    speechSynthesis.cancel();
  });
}

function playLessonAudio(moduleEl) {
  const text = moduleEl.querySelector('.lesson-content')?.innerText;
  if (!text) return;

  speechSynthesis.cancel();

  const voices = speechSynthesis.getVoices();
  const voice = voices.find(v => v.lang.startsWith("en")) || voices[0];

  ttsUtterance = new SpeechSynthesisUtterance(text);
  ttsUtterance.voice = voice;
  ttsUtterance.rate = 0.95;

  setupMediaSession();
  speechSynthesis.speak(ttsUtterance);
}

/* ================= AUTH ================= */
auth.onAuthStateChanged(async user => {
  if (!user) return alert("Login required");
  loadModules(user);
});

/* ================= LOAD MODULES ================= */
async function loadModules(user) {
  const modulesEl = document.getElementById('modules');
  modulesEl.innerHTML = "";

  const modsSnap = await db.collection("courses")
    .doc(COURSE_ID)
    .collection("modules")
    .where("status","==","published")
    .get();

  const studentSnap = await db.collection("students").doc(user.uid).get();
  const completed = studentSnap.data()?.enrolledCourses?.[COURSE_ID]?.completedModules || {};

  let done = 0;
  let index = 1;
  let prevPassed = true;

  modsSnap.forEach(doc => {
    const m = doc.data();
    const id = doc.id;
    const passed = completed[id] === true;
    const locked = index > 1 && !prevPassed;

    if (passed) done++;
    prevPassed = passed;

    const module = document.createElement("div");
    module.className = "module";

    module.innerHTML = `
      <div class="module-header">
        <div class="module-title">Module ${index}: ${m.title}</div>
        <div class="module-status">
          ${locked ? "üîí Locked" : passed ? "‚úÖ Completed" : "‚ñ∂ Start"}
        </div>
      </div>

      <div class="lesson-content">
        ${m.content}

        <div class="quiz-box">
          ${locked ? "" : passed ? "" : `
            <button onclick="startQuiz('${id}', this)">Start Quiz</button>
            <button class="listen-btn" onclick="playLessonAudio(this.closest('.module'))">
              üîä Listen
            </button>
          `}
        </div>
      </div>
    `;

    module.querySelector(".module-header").onclick = () => {
      document.querySelectorAll(".module").forEach(m => {
        if (m !== module) m.classList.remove("active");
      });
      module.classList.toggle("active");
    };

    modulesEl.appendChild(module);
    index++;
  });

  updateProgress(done, modsSnap.size);

  if (done === modsSnap.size && modsSnap.size > 0) {
    showCertificateInput();
  }
}

/* ================= QUIZ ================= */
async function startQuiz(moduleId, btn) {
  btn.disabled = true;
  activeModuleId = moduleId;
  currentScore = 0;
  currentQuestionIndex = 0;

  const snap = await db.collection("courses")
    .doc(COURSE_ID)
    .collection("modules")
    .doc(moduleId)
    .get();

  currentQuiz = snap.data().quizzes;
  quizBox = btn.closest(".quiz-box");

  clearInterval(quizTimer);
  timeLeft = QUESTION_TIME;

  quizTimer = setInterval(() => {
    timeLeft--;
    const t = document.getElementById("timeLeft");
    if (t) t.innerText = timeLeft;
    if (timeLeft <= 0) finishQuiz();
  }, 1000);

  renderQuestion();
}

function renderQuestion() {
  const q = currentQuiz[currentQuestionIndex];

  quizBox.innerHTML = `
    <div class="timer">‚è± <span id="timeLeft">${timeLeft}</span>s</div>
    <p><strong>${q.question}</strong></p>
    ${q.options.map(o => `
      <label>
        <input type="radio" name="ans" value="${o}"> ${o}
      </label>
    `).join("")}
    <button onclick="submitAnswer()">Next</button>
  `;
}

function submitAnswer() {
  const sel = quizBox.querySelector("input[name='ans']:checked");
  if (!sel) return alert("Select an answer");

  if (sel.value.trim() === currentQuiz[currentQuestionIndex].answer.trim()) {
    currentScore++;
  }

  currentQuestionIndex++;
  currentQuestionIndex < currentQuiz.length ? renderQuestion() : finishQuiz();
}

async function finishQuiz() {
  clearInterval(quizTimer);

  const percent = Math.round((currentScore / currentQuiz.length) * 100);
  const passed = percent >= PASS_MARK;

  const user = auth.currentUser;
  if (user) {
    await db.collection("students").doc(user.uid).set({
      enrolledCourses: {
        [COURSE_ID]: {
          completedModules: { [activeModuleId]: passed }
        }
      }
    }, { merge: true });
  }

  quizBox.innerHTML = `
    <p><strong>${percent}%</strong></p>
    ${passed ? "‚úÖ PASSED" : "‚ùå FAILED"}
    <button onclick="loadModules(auth.currentUser)">Continue</button>
  `;
}

/* ================= PROGRESS ================= */
function updateProgress(done, total) {
  const p = total ? Math.round(done / total * 100) : 0;
  document.getElementById("progressFill").style.width = p + "%";
  document.getElementById("progressText").innerText = p + "% Completed";
}
</script>

<!-- ================= CERTIFICATE SECTION ================= -->
<div id="certificateSection">

  <!-- NAME INPUT -->
  <div id="nameInput" style="max-width:520px;margin:40px auto;background:var(--card);padding:24px;border-radius:16px;">
    <h2>üéâ Course Completed</h2>
    <p>Enter your name exactly as it should appear on your certificate.</p>

    <form id="certForm">
      <input id="firstName" placeholder="First Name" required
        style="width:100%;padding:12px;margin-bottom:12px;border-radius:10px;border:1px solid var(--border)">
      <input id="lastName" placeholder="Last Name" required
        style="width:100%;padding:12px;margin-bottom:12px;border-radius:10px;border:1px solid var(--border)">
      <button type="submit">Generate Certificate</button>
    </form>
  </div>

  <!-- CERTIFICATE -->
  <div class="certificate" id="certificate" style="display:none">

    <div class="top-band">
      <div class="logos">
        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhnNFRpSiba0ztBBehfuW2MWV7LjXfqoVWvjiHT_gLRNgmSSOQv74I5h9gVCyAF4RBjpeMbAYKSfmhpyE2v2ihNRlt4rC63vA0KIdHH0ZEkidtlm37CLrNV0Ty_vBfvQgRnfCmsGycBGwCE_sNedqdNStWhLbntzKfIVx6RFkNU6YIyRBplI0S-NODhKRNa/s1600/IMG-20251223-WA0001.jpg">
        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhIuGx_Tl93TWp5OZYxIn7iCPb3FhwXGTZTr_xVjfUAOy4dt2YzXq0c7H4VizrvCBNkCO12IlSymo4R-7Nq9mSffdpB9w6Yge3O2i0UovqE45XIW1jEyvZJg6sOjDfUUhdRJs2x_Bqui6goNnXmcV8hguXwcIUqsvMv5-kY-yNeo-Onr9TVspl88fBfiEsV/s1600/IMG-20251223-WA0001.png">
      </div>
    </div>

    <div class="content">
      <div class="title">Certificate of Completion</div>
      <div class="subtitle">This is to certify that</div>

      <div class="name" id="certName"></div>
      <div class="divider"></div>

      <div class="description">has successfully completed the course entitled</div>

      <div class="course" id="certCourse">Management Course</div>

      <div class="award">
        This certificate is awarded by <strong>FoodPreneur Business Academy</strong>,
        in partnership with <strong>RHAC</strong>, in recognition of dedication and
        successful completion of all course requirements.
      </div>
    </div>

    <div class="footer">
      <div>
        <strong>Certificate No:</strong> <span id="certNo"></span><br>
        <strong>Date of Completion:</strong> <span id="certDate"></span>
      </div>

      <div class="signature">
        <img src="#TEMPORARY_SIGNATURE">
        <div class="signature-name">Academy Director</div>
        <div class="signature-title">FoodPreneur Business Academy</div>
      </div>
    </div>

  </div>

  <div style="text-align:center;margin-top:20px">
    <button onclick="window.print()">üñ® Print / Save as PDF</button>
  </div>
</div>

<style>
/* ===== CERTIFICATE STYLES ===== */
.certificate {
  width: 794px;
  height: 1123px;
  background: #fff;
  border: 14px solid #f7931e;
  margin: 30px auto;
  position: relative;
}
.top-band {
  height: 190px;
  background: linear-gradient(135deg,#f7931e 60%,#cfcfcf 60%);
  padding: 30px 40px;
}
.logos {
  background:#fff;
  padding:18px 30px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.logos img { height:65px }
.content {
  padding: 90px;
  text-align: center;
}
.title { font-size:46px;font-weight:700 }
.subtitle { color:#555;margin-bottom:30px }
.name {
  font-size:38px;
  font-weight:700;
  letter-spacing:1px;
}
.divider {
  width:60%;
  height:2px;
  background:#000;
  margin:16px auto 40px;
}
.course {
  font-size:32px;
  font-weight:700;
  color:#f7931e;
  margin-bottom:40px;
}
.footer {
  position:absolute;
  bottom:60px;
  width:100%;
  padding:0 90px;
  display:flex;
  justify-content:space-between;
}
.signature img { width:180px;opacity:.6 }

@media print {
  body * { visibility: hidden }
  .certificate, .certificate * {
    visibility: visible;
  }
}
</style>

<script>
/* ================= CERTIFICATE LOGIC ================= */

function showCertificateInput() {
  document.getElementById('modules').style.display = 'none';
  document.getElementById('certificateSection').style.display = 'block';
}

document.getElementById("certForm").onsubmit = e => {
  e.preventDefault();

  const name = (
    document.getElementById("firstName").value +
    " " +
    document.getElementById("lastName").value
  ).toUpperCase();

  document.getElementById("certName").innerText = name;
  document.getElementById("certDate").innerText =
    new Date().toLocaleDateString("en-GB",{day:"numeric",month:"long",year:"numeric"});

  document.getElementById("certNo").innerText =
    "FPBA-" + new Date().getFullYear() + "-" + Math.floor(Math.random()*10000);

  document.getElementById("nameInput").style.display = "none";
  document.getElementById("certificate").style.display = "block";
};
</script>
