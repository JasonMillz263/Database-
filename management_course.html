<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>All Courses</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:Poppins;background:#f4f4f4}
header{background:#111;color:#fff;padding:15px}
.container{max-width:1000px;margin:auto;padding:20px}
.card{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px}
iframe{width:100%;height:320px;border-radius:10px;margin-top:10px}
button{padding:10px 18px;border:none;border-radius:6px;cursor:pointer;margin-top:10px}
.complete{background:#4CAF50;color:#fff}
.quiz{background:#fafafa;padding:10px;border-radius:8px;margin-top:10px}
</style>
</head>

<body>

<header>
  <h2>Available Courses</h2>
</header>

<div class="container" id="courseContainer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, doc, setDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import {
  getAuth, signInAnonymously, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain: "students-login-29409.firebaseapp.com",
  projectId: "students-login-29409",
  storageBucket: "students-login-29409.appspot.com",
  messagingSenderId: "634331456872",
  appId: "1:634331456872:web:6dae360c5e28d8356562dd"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let userId = null;

signInAnonymously(auth);

onAuthStateChanged(auth, user => {
  if(!user) return alert("Auth failed");
  userId = user.uid;
  loadPublishedCourses();
});

async function loadPublishedCourses(){
  const snap = await getDocs(collection(db,"courses"));

  snap.forEach(docSnap=>{
    const course = docSnap.data();
    if(course.status !== "published") return;

    const courseDiv = document.createElement("div");
    courseDiv.className = "card";

    courseDiv.innerHTML = `<h2>${course.courseTitle}</h2>`;

    course.modules.forEach((mod,index)=>{
      const modDiv = document.createElement("div");

      modDiv.innerHTML = `
        <h3>${mod.moduleTitle}</h3>
        <div>${mod.content}</div>
        ${mod.videoUrl ? `<iframe src="${mod.videoUrl.replace("watch?v=","embed/")}" allowfullscreen></iframe>` : ""}
        <button class="complete" onclick="completeModule('${docSnap.id}',${index})">✔ Mark Complete</button>
        <div id="quiz-${docSnap.id}-${index}"></div>
      `;

      courseDiv.appendChild(modDiv);

      if(mod.quizzes){
        const quizDiv = document.getElementById(`quiz-${docSnap.id}-${index}`);
        mod.quizzes.forEach((q,i)=>{
          quizDiv.innerHTML += `
            <p><strong>${q.question}</strong></p>
            ${q.options.map(opt=>`
              <label>
                <input type="radio" name="q-${docSnap.id}-${index}-${i}" value="${opt}"> ${opt}
              </label><br>
            `).join("")}
          `;
        });
      }
    });

    document.getElementById("courseContainer").appendChild(courseDiv);
  });
}

// Save student progress
window.completeModule = async function(courseId,moduleIndex){
  if(!userId) return alert("No user ID");
  
  await setDoc(doc(db,"students",userId),{
    completedModules: { [courseId]: moduleIndex + 1 },
    lastAccessed: serverTimestamp()
  }, { merge:true });

  alert("✅ Module completed & progress saved");
};
</script>

</body>
</html>
