<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Course</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Segoe UI,sans-serif;background:#f4f6fb}

.container{padding:12px}

.header{
  background:linear-gradient(135deg,#5b5fff,#7a7eff);
  color:#fff;
  padding:16px;
  border-radius:16px
}

.header small{opacity:.9}

.nav-buttons{
  display:flex;
  gap:10px;
  margin-top:10px
}

.nav-buttons button{
  flex:1;
  background:#fff;
  color:#5b5fff;
  border:none;
  padding:10px;
  border-radius:10px;
  font-weight:600;
  cursor:pointer
}

.progress-bar{height:10px;background:rgba(255,255,255,.3);border-radius:10px;margin-top:10px}
.progress-fill{height:100%;background:#fff;width:0}

.modules{margin-top:16px;display:flex;flex-direction:column;gap:14px}

.module{
  background:#fff;
  border:3px solid #5b5fff;
  border-radius:16px;
  padding:14px
}

.locked{opacity:.5}

.quiz-box{
  margin-top:12px;
  padding:12px;
  border:2px dashed #5b5fff;
  border-radius:12px
}

button{
  width:100%;
  padding:14px;
  margin-top:8px;
  border:none;
  border-radius:12px;
  background:#5b5fff;
  color:#fff;
  font-weight:600;
  cursor:pointer
}

button:disabled{background:#aaa}

.timer{
  font-weight:700;
  color:#dc2626;
  text-align:center;
  margin-bottom:10px
}

.pass{color:#16a34a;font-weight:bold}
.fail{color:#dc2626;font-weight:bold}

.options-group label{
  display:block;
  padding:8px;
  border:1px solid #ddd;
  border-radius:8px;
  margin-bottom:6px;
  cursor:pointer
}
</style>
</head>

<body>
<div class="container">

<div class="header">
  <h2>Management Course</h2>
  <small>Email: <span id="studentEmail"></span></small><br>
  <small>ID: <span id="studentId"></span></small>

  <div class="nav-buttons">
    <button onclick="location.href='https://jasonmillz263.github.io/Database-/student.html'">‚¨Ö Courses Offered</button>
    <button onclick="location.href='https://jasonmillz263.github.io/Database-/student.html'">üè† Dashboard</button>
  </div>

  <div class="progress-bar">
    <div class="progress-fill" id="progressFill"></div>
  </div>
  <p id="progressText">0% Completed</p>
</div>

<div class="modules" id="modules"></div>

</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain:"students-login-29409.firebaseapp.com",
  projectId:"students-login-29409"
});

const auth = firebase.auth();
const db = firebase.firestore();

const COURSE_ID = "management_course";
const PASS_MARK = 60;
const QUIZ_TIME = 60; // seconds

let quizTimer = null;
let timeLeft = QUIZ_TIME;

auth.onAuthStateChanged(async user=>{
  if(!user) return alert("Login required");

  studentEmail.innerText = user.email;
  studentId.innerText = user.uid;

  const ref = db.collection("students").doc(user.uid);
  if(!(await ref.get()).exists){
    await ref.set({email:user.email,enrolledCourses:{}});
  }

  loadModules(user);
});

async function loadModules(user){
  const mods = await db.collection("courses")
    .doc(COURSE_ID)
    .collection("modules")
    .where("status","==","published")
    .get();

  const snap = await db.collection("students").doc(user.uid).get();
  const completed = snap.data()?.enrolledCourses?.[COURSE_ID]?.completedModules || {};

  modules.innerHTML="";
  let done=0, index=1, prev=true;

  mods.forEach(doc=>{
    const m=doc.data(), id=doc.id;
    const passed = completed[id]===true;
    const locked = index>1 && !prev;
    if(passed) done++;
    prev=passed;

    const div=document.createElement("div");
    div.className="module"+(locked?" locked":"");
    div.innerHTML=`
      <h3>Module ${index}: ${m.title}</h3>
      <div class="lesson-content">${m.content}</div>
      <div class="quiz-box">${
        locked ? "üîí Complete previous module"
        : passed ? "<span class='pass'>Completed</span>"
        : `<button onclick="startQuiz('${id}',this)">Start Quiz</button>`
      }</div>
    `;
    modules.appendChild(div);
    index++;
  });

  updateProgress(done,mods.size);
}

async function startQuiz(moduleId,btn){
  btn.disabled=true;
  const moduleDiv=btn.closest(".module");
  moduleDiv.querySelector(".lesson-content").style.display="none";

  const snap=await db.collection("courses")
    .doc(COURSE_ID).collection("modules")
    .doc(moduleId).get();

  const quiz=snap.data().quizzes;
  let i=0, score=0;
  const box=moduleDiv.querySelector(".quiz-box");

  startTimer(box,()=>finish());

  function render(){
    if(i>=quiz.length) return finish();
    const q=quiz[i];
    box.innerHTML=`
      <div class="timer">‚è± ${timeLeft}s</div>
      <p><b>${q.question}</b></p>
      <div class="options-group">
        ${q.options.map(o=>`
          <label><input type="radio" name="ans"> ${o}</label>
        `).join("")}
      </div>
      <button onclick="next()">Next</button>
    `;
  }

  function next(){
    const sel=box.querySelector("input:checked");
    if(!sel) return alert("Select answer");
    if(sel.parentElement.innerText.trim()===quiz[i].answer.trim()) score++;
    i++; render();
  }

  async function finish(){
    clearInterval(quizTimer);
    const percent=Math.round(score/quiz.length*100);
    const passed=percent>=PASS_MARK;

    await db.collection("students").doc(auth.currentUser.uid).set({
      enrolledCourses:{
        [COURSE_ID]:{
          completedModules:{[moduleId]:passed}
        }
      }
    },{merge:true});

    box.innerHTML=`
      <h3>Result</h3>
      <p>${score}/${quiz.length} (${percent}%)</p>
      ${passed?'<p class="pass">PASSED</p>':'<p class="fail">FAILED</p>'}
      <button onclick="loadModules(auth.currentUser)">Continue</button>
    `;
  }

  render();
}

function startTimer(box,timeout){
  timeLeft=QUIZ_TIME;
  clearInterval(quizTimer);
  quizTimer=setInterval(()=>{
    timeLeft--;
    const t=box.querySelector(".timer");
    if(t) t.innerText=`‚è± ${timeLeft}s`;
    if(timeLeft<=0){
      clearInterval(quizTimer);
      timeout();
    }
  },1000);
}

function updateProgress(done,total){
  const p=Math.round(done/total*100);
  progressFill.style.width=p+"%";
  progressText.innerText=p+"% Completed";
}
</script>
</body>
</html>
