<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Course Page</title>

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      margin: 0;
      background: #f4f6fb;
      font-family: "Inter", sans-serif;
    }

    .container {
      max-width: 1100px;
      margin: auto;
      padding: 30px;
    }

    .header {
      background: linear-gradient(135deg, #5b5fff, #7a7eff);
      color: white;
      padding: 25px;
      border-radius: 18px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }

    .progress-bar {
      height: 10px;
      background: rgba(255,255,255,0.3);
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
    }

    .progress-fill {
      height: 100%;
      background: white;
    }

    .modules {
      margin-top: 30px;
      display: grid;
      gap: 22px;
    }

    .module {
      background: white;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.08);
    }

    .quiz button {
      margin-top: 10px;
      padding: 10px 18px;
      border: none;
      background: #5b5fff;
      color: white;
      border-radius: 8px;
      cursor: pointer;
    }

    .pass { color: #1e8e3e; font-weight: bold; }
    .fail { color: #d93025; font-weight: bold; }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Management Course</h1>
      <p><b>Student ID:</b> <span id="studentId"></span></p>
      <p><b>Email:</b> <span id="studentEmail"></span></p>

      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <p id="progressText">0% Completed</p>
    </div>

    <div class="modules" id="modules"></div>
  </div>

<script>
/* ================= FIREBASE CONFIG ================= */
firebase.initializeApp({
  apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain: "students-login-29409.firebaseapp.com",
  projectId: "students-login-29409"
});

const auth = firebase.auth();
const db = firebase.firestore();

const COURSE_ID = "management_course";
const PASS_MARK = 60;

/* ================= AUTH ================= */
auth.onAuthStateChanged(async (user) => {
  if (!user) {
    alert("Please login first");
    return;
  }

  document.getElementById("studentId").innerText = user.uid;
  document.getElementById("studentEmail").innerText = user.email;

  await initStudent(user);
  loadModules(user);
});

/* ================= INIT STUDENT ================= */
async function initStudent(user) {
  const ref = db.collection("students").doc(user.uid);
  const snap = await ref.get();

  if (!snap.exists) {
    await ref.set({
      email: user.email,
      enrolledCourses: {},
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
}

/* ================= LOAD MODULES ================= */
async function loadModules(user) {
  const moduleSnap = await db
    .collection("courses")
    .doc(COURSE_ID)
    .collection("modules")
    .where("status", "==", "published")
    .get();

  const studentRef = db.collection("students").doc(user.uid);
  const studentSnap = await studentRef.get();
  const studentData = studentSnap.data();

  const courseData = studentData.enrolledCourses?.[COURSE_ID] || {
    completedModules: {},
    quizResults: {}
  };

  const modulesDiv = document.getElementById("modules");
  modulesDiv.innerHTML = "";

  let completedCount = 0;

  moduleSnap.forEach(doc => {
    const m = doc.data();
    const moduleId = doc.id;

    if (courseData.completedModules?.[moduleId]) completedCount++;

    const moduleDiv = document.createElement("div");
    moduleDiv.className = "module";

    moduleDiv.innerHTML = `
      <h2>${m.title}</h2>
      <div>${m.content}</div>
    `;

    if (m.quizzes && m.quizzes.length) {
      const quizDiv = document.createElement("div");
      quizDiv.className = "quiz";

      m.quizzes.forEach((q, i) => {
        quizDiv.innerHTML += `
          <p>${q.question}</p>
          ${q.options.map(o => `
            <label>
              <input type="radio" name="${moduleId}-${i}" value="${o}">
              ${o}
            </label><br>
          `).join("")}
        `;
      });

      const btn = document.createElement("button");
      btn.innerText = "Submit Quiz";
      btn.onclick = () => submitQuiz(user, moduleId, m.quizzes);

      quizDiv.appendChild(btn);
      moduleDiv.appendChild(quizDiv);
    }

    modulesDiv.appendChild(moduleDiv);
  });

  updateProgress(completedCount, moduleSnap.size);
}

/* ================= QUIZ SUBMIT ================= */
async function submitQuiz(user, moduleId, quizzes) {
  let correct = 0;

  quizzes.forEach((q, i) => {
    const selected = document.querySelector(`input[name="${moduleId}-${i}"]:checked`);
    if (selected && selected.value === q.answer) correct++;
  });

  const score = Math.round((correct / quizzes.length) * 100);
  const passed = score >= PASS_MARK;

  const ref = db.collection("students").doc(user.uid);

  await ref.set({
    enrolledCourses: {
      [COURSE_ID]: {
        completedModules: { [moduleId]: passed },
        quizResults: {
          [moduleId]: { score, passed }
        }
      }
    }
  }, { merge: true });

  alert(passed ? `PASSED (${score}%)` : `FAILED (${score}%)`);
  loadModules(user);
}

/* ================= PROGRESS ================= */
function updateProgress(done, total) {
  const percent = total ? Math.round((done / total) * 100) : 0;
  document.getElementById("progressFill").style.width = percent + "%";
  document.getElementById("progressText").innerText = percent + "% Completed";
}
</script>
</body>
</html>
