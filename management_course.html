<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Course</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* Reset and Base Styles */
*{box-sizing:border-box}
html,body{margin:0;padding:0;width:100%;overflow-x:hidden}
body{background:#f4f6fb;font-family:Inter,Segoe UI,sans-serif}
img{max-width:100%;height:auto;display:block;margin:12px auto}
.container{padding:12px}

/* Header and Progress */
.header{background:linear-gradient(135deg,#5b5fff,#7a7eff);color:#fff;padding:16px;border-radius:16px}
.progress-bar{height:10px;background:rgba(255,255,255,.3);border-radius:10px}
.progress-fill{height:100%;background:#fff;width:0}

/* Navigation Group */
.nav-group{display:flex;gap:10px;margin-bottom:12px;}
.nav-group button{padding:8px 12px;width:auto;margin-top:0;border-radius:8px;}
.back-btn{background:#aaa;color:#fff;}
.dashboard-btn{background:#ffb700;color:#000;}

/* Quiz Container (Security/Focus View) */
#quizContainer {
    display: none; /* Initially hidden */
    background: #fff;
    padding: 20px;
    border-radius: 16px;
    margin-top: 16px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
#timerDisplay {
    font-size: 1.5em;
    font-weight: bold;
    color: #dc2626; /* Red for emphasis */
    margin-bottom: 15px;
    text-align: center;
}

/* Modules and Lessons */
.modules{margin-top:16px;display:flex;flex-direction:column;gap:14px}
.module{background:#fff;border:3px solid #5b5fff;border-radius:16px;padding:14px}
.locked{opacity:.5}
.lesson-content{margin-top:10px}
.quiz-box{margin-top:12px;padding:12px;border:2px dashed #5b5fff;border-radius:12px}

/* Buttons and Status */
button{width:100%;padding:14px;margin-top:8px;border:none;border-radius:12px;background:#5b5fff;color:#fff;font-weight:600; cursor:pointer;}
button:disabled{background:#aaa}
.listen-btn{background:#ffb700;color:#000}
.pass{color:#16a34a;font-weight:bold}
.fail{color:#dc2626;font-weight:bold}
.score-tag{background:#16a34a;color:#fff;padding:4px 10px;border-radius:12px;font-size:13px}

/* Quiz Options */
.options-group label{display:block;margin-bottom:6px;cursor:pointer;padding:8px;border:1px solid #ddd;border-radius:8px;}
.options-group input[type="radio"]{margin-right:8px;}
</style>
</head>

<body>
<div class="container">

<div class="header">
  <div class="nav-group">
    <button class="back-btn" onclick="goToPage('https://jasonmillz263.github.io/Database-/student.html')">‚Üê Courses Offered</button>
    <button class="dashboard-btn" onclick="goToPage('https://jasonmillz263.github.io/Database-/student.html')">Dashboard</button>
  </div>
  
  <h2>Management Course</h2>
  <p id="studentInfo"></p>
  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  <p id="progressText">0% Completed</p>
</div>

<div id="mainContent">
  <div class="modules" id="modules"></div>
</div>

<div id="quizContainer">
    <div id="timerDisplay">Time Left: <span id="timeValue"></span> seconds</div>
    <div id="quizContent"></div>
</div>

</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain:"students-login-29409.firebaseapp.com",
  projectId:"students-login-29409"
});

const auth = firebase.auth();
const db = firebase.firestore();

const COURSE_ID = "management_course";
const PASS_MARK = 60;
const QUESTION_TIME = 20; // Timer set to 20 seconds per question

let activeModuleId = null;
let currentQuiz = [];
let currentQuestionIndex = 0;
let currentScore = 0;
let quizBox = null;
let ttsUtter = null;
let timerInterval = null;

/* AUTH (MODIFIED: Added error handling and displays Email + UID) */
auth.onAuthStateChanged(async user=>{
  if(!user) {
    console.error("Authentication required. Redirecting or waiting for login.");
    return alert("Login required");
  }

  try {
    const studentInfo = document.getElementById("studentInfo");
    if (studentInfo) {
        studentInfo.innerText = `${user.email} (ID: ${user.uid})`;
    }

    const ref = db.collection("students").doc(user.uid);
    if(!(await ref.get()).exists){
      await ref.set({email:user.email,enrolledCourses:{}});
    }

    loadModules(user);
  } catch (error) {
    console.error("Error during authentication state change or initial setup:", error);
    alert("An error occurred during student setup. Check console for details.");
  }
});

/* LOAD MODULES (MODIFIED: Added try/catch and view switching) */
async function loadModules(user){
  // 1. Set View State: Show Modules, Hide Quiz
  document.getElementById('mainContent').style.display = 'block';
  document.getElementById('quizContainer').style.display = 'none';
  
  try {
    // 2. Fetch course modules
    const modsSnap = await db.collection("courses")
      .doc(COURSE_ID)
      .collection("modules")
      .where("status","==","published")
      .get();
    
    if (modsSnap.empty) {
        modules.innerHTML = "<p>No published modules found for this course.</p>";
        updateProgress(0, 0);
        return;
    }

    // 3. Fetch student progress
    const studentSnap = await db.collection("students").doc(user.uid).get();
    const data = studentSnap.data() || {};
    const course = data.enrolledCourses?.[COURSE_ID] || {};
    const completed = course.completedModules || {};

    modules.innerHTML = "";

    let completedCount = 0;
    let previousPassed = true;
    let index = 1;

    // 4. Render modules
    modsSnap.forEach(doc=>{
      const m = doc.data();
      const id = doc.id;
      const passed = completed[id] === true;
      const locked = index > 1 && !previousPassed;

      if(passed) completedCount++;
      previousPassed = passed;

      const div = document.createElement("div");
      div.className = "module" + (locked ? " locked" : "");
      div.innerHTML = `
        <h2>Module ${index}: ${m.title} ${passed?'<span class="score-tag">‚úì</span>':''}</h2>
        <div class="lesson-content">${m.content}</div>
      `;

      const box = document.createElement("div");
      box.className = "quiz-box";

      if(locked){
        box.innerHTML = "üîí Complete previous module first";
      } else if(passed){
        box.innerHTML = "<span class='pass'>Completed</span>";
      } else {
        box.innerHTML = `
          <button onclick="startQuiz('${id}', this)">Start Quiz</button>
          <button class="listen-btn" onclick="readAloud(this)">üîä Listen</button>
          <button class="listen-btn" onclick="pauseTTS()">‚è∏ Pause / Resume</button>
        `;
      }

      div.appendChild(box);
      modules.appendChild(div);
      index++;
    });

    updateProgress(completedCount, modsSnap.size);

  } catch (error) {
    console.error("Error loading modules or student data:", error);
    modules.innerHTML = `<p style="color: red;">Failed to load course modules. Please check the console for Firebase errors.</p>`;
    updateProgress(0, 0);
  }
}

// --- QUIZ TIMER FUNCTIONS ---

function startTimer() {
  clearInterval(timerInterval);
  let timeLeft = QUESTION_TIME;
  const timeValue = document.getElementById('timeValue');

  timeValue.innerText = timeLeft;

  timerInterval = setInterval(() => {
    timeLeft--;
    timeValue.innerText = timeLeft;

    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      processSubmission(true); // Auto-submit if time runs out
    }
  }, 1000);
}

function stopTimer() {
  clearInterval(timerInterval);
}

/* START QUIZ (Sets up dedicated quiz view) */
async function startQuiz(moduleId, btn){
  if (btn) btn.disabled = true;
  stopTimer();

  // Switch to quiz view
  document.getElementById('mainContent').style.display = 'none';
  document.getElementById('quizContainer').style.display = 'block';
  quizBox = document.getElementById('quizContent'); 

  activeModuleId = moduleId;
  currentQuestionIndex = 0;
  currentScore = 0;
  
  try {
    const snap = await db.collection("courses")
      .doc(COURSE_ID)
      .collection("modules")
      .doc(moduleId)
      .get();

    currentQuiz = snap.data().quizzes;
    
    if (currentQuiz && currentQuiz.length > 0) {
      renderQuestion();
    } else {
      quizBox.innerHTML = "<p>No quizzes found for this module.</p>";
    }
  } catch (error) {
      console.error("Error fetching quiz data:", error);
      quizBox.innerHTML = `<p style="color: red;">Failed to load quiz. Check Firebase connection.</p>`;
  }
}

/* RENDER QUESTION (Starts Timer) */
function renderQuestion(){
  if(currentQuestionIndex >= currentQuiz.length){
    finishQuiz();
    return;
  }

  const q = currentQuiz[currentQuestionIndex];
  
  const isLastQuestion = (currentQuestionIndex === currentQuiz.length - 1);
  const buttonText = isLastQuestion ? "See My Results" : "Next Question";

  quizBox.innerHTML = `
    <p>Question ${currentQuestionIndex + 1} of ${currentQuiz.length}</p>
    <p><strong>${q.question}</strong></p>
    <div class="options-group">
      ${q.options.map((o, i) =>`
        <label><input type="radio" name="ans" value="${o}" required> ${o}</label>
      `).join("")}
    </div>
    <button id="nextBtn">${buttonText}</button>
  `;

  quizBox.querySelector("#nextBtn").onclick = processSubmission;
  startTimer();
}

/* PROCESS SUBMISSION (Stops Timer, checks answer, advances) */
function processSubmission(timedOut = false){
    stopTimer();

    const sel = quizBox.querySelector("input[name='ans']:checked");
    
    if (!sel && !timedOut) {
        alert("Please select an answer before proceeding.");
        startTimer(); // Restart timer
        return;
    }

    if (sel) {
        const cleanString = (str) => {
            if (!str) return '';
            let cleaned = String(str).replace(/\s/g, ' ').replace(/\u00A0/g, ' ').replace(/\s\s+/g, ' ');
            return cleaned.trim();
        };

        const studentAnswer = cleanString(sel.value);
        const correctAnswer = cleanString(currentQuiz[currentQuestionIndex].answer);

        if (studentAnswer === correctAnswer) {
            currentScore++;
        }
    }

    currentQuestionIndex++;

    if (currentQuestionIndex < currentQuiz.length) {
        renderQuestion();
    } else {
        quizBox.innerHTML = `
            <h3>Quiz Completed!</h3>
            <p>You have answered all ${currentQuiz.length} questions.</p>
            <button id="seeResultsBtn">See My Final Score</button>
        `;
        
        const resultsBtn = quizBox.querySelector("#seeResultsBtn");
        if (resultsBtn) {
            resultsBtn.onclick = finishQuiz;
        }
    }
}

/* FINISH QUIZ (Saves results and prepares continuation) */
async function finishQuiz(){
  stopTimer();

  const percent = Math.round((currentScore / currentQuiz.length) * 100);
  const passed = percent >= PASS_MARK;
  const user = auth.currentUser;

  // 1. Update Firestore
  if (user) {
    try {
        const ref = db.collection("students").doc(user.uid);
        const snap = await ref.get();
        const data = snap.data() || {};
        const course = data.enrolledCourses?.[COURSE_ID] || {};

        const completedModules = course.completedModules || {};
        const quizResults = course.quizResults || {};

        completedModules[activeModuleId] = passed; 
        
        quizResults[activeModuleId] = {
          percent,
          passed,
          date: firebase.firestore.FieldValue.serverTimestamp(),
          score: `${currentScore}/${currentQuiz.length}`
        };

        await ref.set({
          enrolledCourses:{
            [COURSE_ID]:{
              completedModules,
              quizResults
            }
          }
        },{merge:true});
    } catch (error) {
        console.error("Error saving quiz results:", error);
        alert("Warning: Quiz results could not be saved to the database.");
    }
  }

  // 2. Display Result
  quizBox.innerHTML = `
    <h3>Results for Module Quiz</h3>
    <p>Total Score: <strong>${currentScore} / ${currentQuiz.length}</strong></p>
    <p>Percentage: <strong>${percent}%</strong></p>
    ${passed
      ? `<p class="pass">‚úÖ PASSED ‚Äî Congratulations! You can now continue.</p>`
      : `<p class="fail">‚ùå FAILED ‚Äî Keep trying! (Required: ${PASS_MARK}%)</p>
         <button onclick="retryQuiz('${activeModuleId}')">Retry Quiz</button>`
    }
    <button id="continueBtn" style="margin-top: 20px;">Continue to Modules</button>
  `;

  // 3. Set the Continue button to trigger the module reload
  document.getElementById('continueBtn').onclick = () => {
      loadModules(user); 
  };
}

function retryQuiz(moduleId){
  activeModuleId = moduleId;
  currentQuestionIndex = 0;
  currentScore = 0;
  startQuiz(moduleId, null); 
}

/* TTS (UNCHANGED) */
function readAloud(btn){
  const content = btn.closest(".module").querySelector(".lesson-content");
  if(!content) return;

  if(ttsUtter) speechSynthesis.cancel();

  const voices = speechSynthesis.getVoices();
  const voice = voices.find(v=>v.lang.startsWith("en")) || voices[0];

  ttsUtter = new SpeechSynthesisUtterance(content.innerText);
  ttsUtter.voice = voice;
  ttsUtter.rate = 0.95;
  ttsUtter.pitch = 1.05;

  speechSynthesis.speak(ttsUtter);
}

function pauseTTS(){
  if(speechSynthesis.speaking && !speechSynthesis.paused) speechSynthesis.pause();
  else if(speechSynthesis.paused) speechSynthesis.resume();
}


/* PROGRESS (UNCHANGED) */
function updateProgress(done,total){
  const p = total ? Math.round(done/total*100) : 0;
  progressFill.style.width = p+"%";
  progressText.innerText = p+"% Completed";
}

/* NAVIGATION FUNCTION (UNCHANGED) */
function goToPage(url) {
  // Use the built-in device action to open the URL
  device_actions:open_url(url: url);
}
</script>
</body>
</html>
