<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Ticket System</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 1rem;
    }

    h2 {
      text-align: center;
    }

    .card {
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    input, textarea, button, select {
      width: 100%;
      margin-top: 0.5rem;
      padding: 0.6rem;
      font-size: 1rem;
    }

    button {
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .ticket {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 0.5rem;
      margin-top: 0.5rem;
    }

    .status {
      font-weight: bold;
      text-transform: uppercase;
    }

    img {
      max-width: 100%;
      border-radius: 5px;
      margin-top: 0.5rem;
    }
  </style>
</head>

<body>

<h2>Submit Payment Ticket</h2>

<div class="card">
  <input id="email" type="email" placeholder="Your email" required />
  <textarea id="description" placeholder="Ticket description"></textarea>
  <input id="image" type="file" accept="image/*"/>
  <button id="submit">Submit Ticket</button>
</div>

<h2>Your Ticket History</h2>
<div id="tickets"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
    authDomain: "students-login-29409.firebaseapp.com",
    projectId: "students-login-29409",
    storageBucket: "students-login-29409.firebasestorage.app",
    messagingSenderId: "634331456872",
    appId: "1:634331456872:web:6dae360c5e28d8356562dd",
    measurementId: "G-96XXYG1VR2"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const emailEl = document.getElementById("email");
  const descEl = document.getElementById("description");
  const imgEl = document.getElementById("image");
  const ticketsEl = document.getElementById("tickets");

  document.getElementById("submit").onclick = () => {
    if (!imgEl.files[0]) {
      alert("Please upload proof of payment");
      return;
    }

    const reader = new FileReader();
    reader.onload = async () => {
      await addDoc(collection(db, "tickets"), {
        userEmail: emailEl.value,
        description: descEl.value,
        imageBase64: reader.result,
        status: "open",
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        history: [
          {
            status: "open",
            changedBy: "student",
            changedAt: new Date()
          }
        ]
      });

      alert("Ticket submitted successfully");
    };
    reader.readAsDataURL(imgEl.files[0]);
  };

  emailEl.addEventListener("input", () => {
    ticketsEl.innerHTML = "";

    const q = query(
      collection(db, "tickets"),
      where("userEmail", "==", emailEl.value)
    );

    onSnapshot(q, snap => {
      ticketsEl.innerHTML = "";
      snap.forEach(doc => {
        const t = doc.data();
        ticketsEl.innerHTML += `
          <div class="ticket">
            <div class="status">Status: ${t.status}</div>
            <p>${t.description}</p>
            <img src="${t.imageBase64}">
          </div>
        `;
      });
    });
  });
</script>

</body>
</html>
