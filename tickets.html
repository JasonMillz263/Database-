<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Student Support</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root { --primary:#6d28d9; --secondary:#2563eb; --bg:#f8fafc; --card:#ffffff; --text:#1e293b; --yellow:#f59e0b; --green:#10b981; --red:#ef4444; }

body { margin:0; font-family:'Poppins',sans-serif; background:var(--bg); color:var(--text); padding-bottom:80px; }

.app-container { max-width:600px; margin:0 auto; padding:20px; }

header { display:flex; align-items:center; justify-content:space-between; margin-bottom:25px; }
h1 { margin:0; color:var(--primary); }

.card { background:#fff; border-radius:20px; padding:20px; box-shadow:0 4px 20px rgba(0,0,0,0.05); margin-bottom:20px; }

.form-group { margin-bottom:15px; }
label { display:block; font-size:13px; color:#64748b; margin-bottom:6px; }

input, select, textarea { width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:12px; box-sizing:border-box; }

.btn-main { width:100%; padding:14px; border:none; border-radius:14px; background:linear-gradient(135deg,var(--primary),var(--secondary)); color:#fff; font-weight:600; cursor:pointer; }

.ticket-card { background:white; border-radius:16px; padding:18px; margin-bottom:15px; border-left:5px solid #ccc; box-shadow:0 4px 6px rgba(0,0,0,0.05); }
.ticket-card.open { border-left-color:var(--yellow); }
.ticket-card.replied { border-left-color:var(--green); }
.ticket-card.closed { border-left-color:var(--red); }

.badge { padding:4px 10px; border-radius:20px; font-size:11px; color:white; float:right; }
.bg-open { background:var(--yellow); }
.bg-replied { background:var(--green); }
.bg-closed { background:var(--red); }

.ticket-img-preview { width:100%; max-height:200px; object-fit:cover; border-radius:8px; margin-top:10px; border:1px solid #eee; }
</style>
</head>

<body>

<div class="app-container">
    <header>
        <h1>Academy Help</h1>
        <div id="userInfo" style="font-weight:600;"></div>
    </header>

    <div class="card">
        <h3>‚ú® Create Ticket</h3>

        <div class="form-group">
            <label>Topic</label>
            <select id="category">
                <option value="Payment">üí∞ Proof of Payment / Issue</option>
                <option value="Course">üìö Course Content</option>
                <option value="Technical">‚öôÔ∏è Technical Error</option>
                <option value="Other">‚ùì Other</option>
            </select>
        </div>

        <div class="form-group">
            <label>Subject</label>
            <input id="subject" type="text" placeholder="Brief summary..." />
        </div>

        <div class="form-group">
            <label>Message</label>
            <textarea id="message" rows="3" placeholder="Describe the issue..."></textarea>
        </div>

        <div class="form-group">
            <label>Attachment (Image only)</label>
            <input type="file" id="attachment" accept="image/*" />
        </div>

        <button class="btn-main" id="submitBtn" onclick="createTicket()">Submit Ticket</button>
    </div>

    <h3>My Tickets</h3>
    <div id="ticketList"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain:"students-login-29409.firebaseapp.com",
  projectId:"students-login-29409",
  storageBucket:"students-login-29409.firebasestorage.app",
  messagingSenderId:"634331456872",
  appId:"1:634331456872:web:6dae360c5e28d8356562dd",
  measurementId:"G-96XXYG1VR2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// üëâ Replace this with your REAL logged-in student data
const student = {
  id: "STUDENT_ID_HERE",
  name: "Student Name",
  email: "student@email.com"
};

document.getElementById("userInfo").innerText = student.name;

// compress image
const compressImage = (file) =>
  new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (e) => {
      const img = new Image();
      img.src = e.target.result;
      img.onload = () => {
        const canvas = document.createElement("canvas");
        const MAX_WIDTH = 800;
        const scale = MAX_WIDTH / img.width;
        canvas.width = MAX_WIDTH;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        resolve(canvas.toDataURL("image/jpeg", 0.7));
      };
    };
    reader.onerror = reject;
  });

window.createTicket = async () => {
  const subject = subjectInput.value = document.getElementById("subject").value;
  const category = document.getElementById("category").value;
  const message = document.getElementById("message").value;
  const fileInput = document.getElementById("attachment");
  const btn = document.getElementById("submitBtn");

  if (!subject || !message) return alert("Please fill in subject and message.");

  btn.disabled = true;
  btn.innerText = "Sending...";

  try {
    let base64Image = null;

    if (fileInput.files.length) {
      btn.innerText = "Compressing image...";
      base64Image = await compressImage(fileInput.files[0]);
    }

    await addDoc(collection(db, "tickets"), {
      studentId: student.id,
      studentName: student.name,
      studentEmail: student.email,
      subject,
      category,
      message,
      attachment: base64Image,
      status: "Open",
      createdAt: serverTimestamp(),
      adminResponse: ""
    });

    alert("Ticket Sent!");
    document.getElementById("subject").value = "";
    document.getElementById("message").value = "";
    document.getElementById("attachment").value = "";

  } catch (e) {
    alert(e.message);
  } finally {
    btn.disabled = false;
    btn.innerText = "Submit Ticket";
  }
};

function loadTickets() {
  const q = query(
    collection(db, "tickets"),
    where("studentId", "==", student.id),
    orderBy("createdAt", "desc")
  );

  onSnapshot(q, (snapshot) => {
    const list = document.getElementById("ticketList");

    if (snapshot.empty) {
      list.innerHTML = "<p style='text-align:center;color:#999'>No tickets yet.</p>";
      return;
    }

    list.innerHTML = snapshot.docs
      .map((doc) => {
        const t = doc.data();
        const cls = t.status === "Open" ? "open" : t.status === "Replied" ? "replied" : "closed";

        return `
        <div class="ticket-card ${cls}">
            <span class="badge bg-${cls}">${t.status}</span>
            <strong>${t.subject}</strong>
            <small>${t.category} ‚Ä¢ ${t.createdAt?.toDate().toLocaleDateString?.() || ""}</small>
            <p>${t.message}</p>
            ${t.attachment ? `<img src="${t.attachment}" class="ticket-img-preview" />` : ""}
            ${t.adminResponse ? `<div style="background:#f1f5f9;padding:10px;border-radius:8px;margin-top:10px;"><strong>üëÆ Admin:</strong> ${t.adminResponse}</div>` : ""}
        </div>`;
      })
      .join("");
  });
}

loadTickets();
</script>
</body>
</html>
