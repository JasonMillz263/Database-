<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Help Desk</title>

<style>
:root { --primary:#2563eb; --primary-dark:#1e40af; --bg:#f8fafc; --white:#fff; --text:#0f172a; }
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);margin:0;padding-bottom:60px}

.container{max-width:600px;margin:auto;padding:20px}
header{display:flex;justify-content:space-between;align-items:center;background:#fff;padding:15px 20px;border-radius:12px;margin-bottom:20px}
.user-badge{font-size:13px;font-weight:600;background:#f1f5f9;padding:6px 12px;border-radius:20px}

.tabs{display:flex;gap:10px;margin-bottom:20px}
.tab-btn{flex:1;padding:12px;border:none;border-radius:8px;font-weight:600;cursor:pointer}
.tab-btn.active{background:var(--primary);color:#fff}

.view-section{display:none}
.view-section.active{display:block}

.card{background:#fff;border-radius:16px;padding:24px}
.form-group{margin-bottom:16px}
input,select,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid #cbd5e1}
.btn-main{width:100%;padding:14px;border:none;border-radius:12px;background:var(--primary);color:#fff;font-weight:700;cursor:pointer}

.ticket-card{background:#fff;border-radius:12px;margin-bottom:20px;border:1px solid #e2e8f0}
.t-header{padding:15px;border-bottom:1px solid #f1f5f9;display:flex;justify-content:space-between}
.badge{padding:4px 10px;border-radius:12px;font-size:11px;font-weight:800}
.st-open{background:#dbeafe;color:#1e40af}
.st-in_review{background:#ffedd5;color:#9a3412}
.st-closed{background:#f1f5f9;color:#475569}

.chat-area{height:300px;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:12px;background:#f8fafc}
.msg{max-width:85%;padding:10px 14px;border-radius:12px;font-size:14px}
.msg-me{align-self:flex-end;background:var(--primary);color:#fff}
.msg-admin{align-self:flex-start;background:#fff;border:1px solid #e2e8f0}
.msg-time{font-size:10px;opacity:.7;text-align:right}

.reply-bar{display:flex;gap:10px;padding:10px;border-top:1px solid #e2e8f0}
.reply-input{flex:1;padding:10px 15px;border-radius:25px;border:1px solid #cbd5e1}
.btn-send{width:40px;height:40px;border-radius:50%;border:none;background:var(--primary);color:#fff;font-size:18px;cursor:pointer}

#authOverlay{position:fixed;inset:0;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:99}
</style>
</head>

<body>

<div id="authOverlay">
<h2>ðŸŽ“ Student Support</h2>
<button class="btn-main" style="width:220px" onclick="login()">Login with Google</button>
</div>

<div class="container">
<header>
<h3>Help Desk</h3>
<div id="userInfo" class="user-badge">Guest</div>
</header>

<div class="tabs">
<button class="tab-btn active" onclick="switchTab('new')">âž• New Ticket</button>
<button class="tab-btn" onclick="switchTab('history')">ðŸ“‚ My History</button>
</div>

<div id="view-new" class="view-section active">
<div class="card">
<div class="form-group">
<label>Category</label>
<select id="category">
<option>Payment</option>
<option>Course Content</option>
<option>Technical</option>
<option>Other</option>
</select>
</div>
<div class="form-group">
<label>Subject</label>
<input id="subject">
</div>
<div class="form-group">
<label>Description</label>
<textarea id="message" rows="4"></textarea>
</div>
<button class="btn-main" onclick="createTicket()">Create Ticket</button>
</div>
</div>

<div id="view-history" class="view-section">
<div id="ticketList"></div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
 apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
 authDomain:"students-login-29409.firebaseapp.com",
 projectId:"students-login-29409",
 storageBucket:"students-login-29409.firebasestorage.app",
 messagingSenderId:"634331456872",
 appId:"1:634331456872:web:6dae360c5e28d8356562dd"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

window.login = () => signInWithPopup(auth,new GoogleAuthProvider());

onAuthStateChanged(auth,user=>{
 if(user){
  authOverlay.style.display="none";
  userInfo.innerText=user.displayName;
  loadTickets(user.uid);
 }else authOverlay.style.display="flex";
});

window.switchTab=tab=>{
 document.querySelectorAll('.view-section').forEach(v=>v.classList.remove('active'));
 document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
 document.getElementById(`view-${tab}`).classList.add('active');
};

window.createTicket=async()=>{
 const user=auth.currentUser;
 if(!user) return;
 await addDoc(collection(db,"tickets"),{
  studentId:user.uid,
  studentName:user.displayName,
  subject:subject.value,
  category:category.value,
  status:"open",
  messages:[{
    sender:"student",
    message:message.value,
    timestamp:serverTimestamp()
  }],
  createdAt:serverTimestamp(),
  lastUpdated:serverTimestamp()
 });
 switchTab('history');
};

function loadTickets(uid){
 const q=query(collection(db,"tickets"),where("studentId","==",uid),orderBy("lastUpdated","desc"));
 onSnapshot(q,snap=>{
  ticketList.innerHTML=snap.docs.map(d=>{
   const t=d.data();
   const msgs=t.messages.map(m=>{
    const ts=m.timestamp?.toDate?m.timestamp.toDate():new Date(m.timestamp);
    return `<div class="msg ${m.sender==='student'?'msg-me':'msg-admin'}">
      ${m.message}
      <div class="msg-time">${ts.toLocaleTimeString()}</div>
    </div>`;
   }).join("");
   return `<div class="ticket-card">
    <div class="t-header">
     <strong>${t.subject}</strong>
     <span class="badge st-${t.status}">${t.status}</span>
    </div>
    <div class="chat-area">${msgs}</div>
    ${t.status!=='closed'?`
    <div class="reply-bar">
     <input class="reply-input" id="r-${d.id}">
     <button class="btn-send" onclick="reply('${d.id}')">âž¤</button>
    </div>`:''}
   </div>`;
  }).join("");
 });
}

window.reply=async(id)=>{
 const inp=document.getElementById(`r-${id}`);
 if(!inp.value) return;
 await updateDoc(doc(db,"tickets",id),{
  messages:arrayUnion({
   sender:"student",
   message:inp.value,
   timestamp:serverTimestamp()
  }),
  lastUpdated:serverTimestamp()
 });
 inp.value="";
};
</script>

</body>
</html>
