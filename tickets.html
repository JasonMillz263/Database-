<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Student Support</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:Poppins,sans-serif;background:#f8fafc}
.container{max-width:600px;margin:auto;padding:20px}
.card{background:white;border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:0 4px 20px rgba(0,0,0,.05)}
input,select,textarea{width:100%;padding:12px;border-radius:12px;border:2px solid #e5e7eb}
button{width:100%;padding:14px;border:none;border-radius:14px;background:#6d28d9;color:white;font-weight:600}
.ticket{background:white;border-left:5px solid #f59e0b;border-radius:14px;padding:15px;margin-bottom:12px}
.replied{border-color:#10b981}
.closed{border-color:#ef4444}
img{max-width:100%;border-radius:8px;margin-top:10px}
</style>
</head>

<body>
<div class="container">
<h2>ðŸŽ“ Student Support</h2>

<div class="card">
<select id="cat">
<option>Payment</option>
<option>Course</option>
<option>Technical</option>
<option>Other</option>
</select><br><br>

<input id="sub" placeholder="Subject"><br><br>
<textarea id="msg" placeholder="Message"></textarea><br><br>
<input type="file" id="file" accept="image/*"><br><br>
<button onclick="send()">Submit Ticket</button>
</div>

<h3>My Tickets</h3>
<div id="list"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const app = initializeApp({
 apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
 authDomain:"students-login-29409.firebaseapp.com",
 projectId:"students-login-29409"
});
const db = getFirestore(app);

// âš ï¸ replace with real logged user
const student={id:"STUDENT_ID",name:"Student Name",email:"student@email.com"};

async function send(){
 if(!sub.value||!msg.value) return alert("Fill all fields");

 let img=null;
 if(file.files[0]){
  const r=new FileReader();
  r.onload=e=>img=e.target.result;
  r.readAsDataURL(file.files[0]);
  await new Promise(res=>r.onloadend=res);
 }

 await addDoc(collection(db,"tickets"),{
  studentId:student.id,
  studentName:student.name,
  studentEmail:student.email,
  subject:sub.value,
  message:msg.value,
  category:cat.value,
  attachment:img,
  status:"Open",
  createdAt:serverTimestamp(),
  adminResponse:""
 });

 sub.value=msg.value="";
 alert("Ticket sent");
}

const q=query(
 collection(db,"tickets"),
 where("studentId","==",student.id),
 orderBy("createdAt","desc")
);

onSnapshot(q,s=>{
 list.innerHTML=s.docs.map(d=>{
  const t=d.data();
  const cls=t.status==="Replied"?"replied":t.status==="Closed"?"closed":"";
  return `
   <div class="ticket ${cls}">
    <strong>${t.subject}</strong><br>
    <small>${t.status}</small>
    <p>${t.message}</p>
    ${t.attachment?`<img src="${t.attachment}">`:""}
    ${t.adminResponse?`<p><b>Admin:</b> ${t.adminResponse}</p>`:""}
   </div>`;
 }).join("")||"<p>No tickets</p>";
});
</script>
</body>
</html>
