<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Manage Students | Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
  margin: 0;
  background: #f5f7ff;
  font-family: 'Poppins', sans-serif;
}

.container {
  max-width: 1100px;
  margin: 20px auto;
  background: #fff;
  padding: 20px;
  border-radius: 14px;
}

h1 {
  margin-bottom: 16px;
}

/* TABLE (DESKTOP) */
table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: 12px;
  border-bottom: 1px solid #e5e7eb;
  text-align: left;
}

th {
  background: #2563eb;
  color: #fff;
}

/* ACTION BUTTONS */
.actions button {
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  margin-right: 6px;
}

.delete { background: #ef4444; color: #fff; }
.reset { background: #6366f1; color: #fff; }

/* MOBILE CARDS */
@media (max-width: 768px) {
  table, thead { display: none; }

  .card {
    background: #f9fafb;
    border-radius: 12px;
    padding: 14px;
    margin-bottom: 14px;
  }

  .card h3 {
    margin: 0 0 6px;
  }

  .meta {
    font-size: 14px;
    color: #555;
  }

  .card-actions {
    margin-top: 10px;
  }

  .card-actions button {
    width: 100%;
    margin-bottom: 8px;
  }
}
</style>
</head>

<body>

<div class="container">
  <h1>Manage Students</h1>

  <!-- DESKTOP TABLE -->
  <table id="desktopTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Status</th>
        <th>Courses</th>
        <th>Progress</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="studentsTable"></tbody>
  </table>

  <!-- MOBILE CARDS -->
  <div id="mobileCards"></div>
</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain: "students-login-29409.firebaseapp.com",
  projectId: "students-login-29409"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* ADMIN GUARD */
auth.onAuthStateChanged(async user => {
  if (!user) return location.replace("../index.html");

  const adminDoc = await db.collection("admins").doc(user.uid).get();
  if (!adminDoc.exists) {
    alert("Admins only");
    auth.signOut();
    return location.replace("../index.html");
  }

  loadStudents();
});

/* LOAD STUDENTS */
function loadStudents() {
  db.collection("students").onSnapshot(snapshot => {
    const table = document.getElementById("studentsTable");
    const cards = document.getElementById("mobileCards");
    table.innerHTML = "";
    cards.innerHTML = "";

    snapshot.forEach(doc => {
      const s = doc.data();
      const courses = (s.coursesPaid || []).join(", ");
      const progress = s.progress
        ? Object.values(s.progress).join("%, ") + "%"
        : "—";

      /* DESKTOP ROW */
      table.innerHTML += `
        <tr>
          <td>${s.fullName || "—"}</td>
          <td>${s.email}</td>
          <td>${s.status || "active"}</td>
          <td>${courses}</td>
          <td>${progress}</td>
          <td class="actions">
            <button class="delete" onclick="deleteStudent('${doc.id}')">Delete</button>
            <button class="reset" onclick="resetPassword('${s.email}')">Reset</button>
          </td>
        </tr>
      `;

      /* MOBILE CARD */
      cards.innerHTML += `
        <div class="card">
          <h3>${s.fullName || "Student"}</h3>
          <div class="meta">Email: ${s.email}</div>
          <div class="meta">Status: ${s.status || "active"}</div>
          <div class="meta">Courses: ${courses || "—"}</div>
          <div class="meta">Progress: ${progress}</div>
          <div class="card-actions">
            <button class="delete" onclick="deleteStudent('${doc.id}')">Delete</button>
            <button class="reset" onclick="resetPassword('${s.email}')">Reset Password</button>
          </div>
        </div>
      `;
    });
  });
}

/* ACTIONS */
function deleteStudent(uid) {
  if (!confirm("Delete this student?")) return;
  db.collection("students").doc(uid).delete();
}

function resetPassword(email) {
  auth.sendPasswordResetEmail(email)
    .then(() => alert("Reset email sent"))
    .catch(err => alert(err.message));
}
</script>

</body>
</html>
