<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin â€“ Manage Payments</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#f4f6fb;
  --card:#ffffff;
  --blue:#2563eb;
  --green:#22c55e;
  --red:#ef4444;
  --orange:#f97316;
  --pending:#f59e0b;
  --text:#1f2937;
  --muted:#6b7280;
}

*{box-sizing:border-box;font-family:'Poppins',sans-serif}
body{margin:0;background:var(--bg)}

header{
  background:#fff;
  padding:20px 30px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 6px 20px rgba(0,0,0,.06);
}

header h1{margin:0;font-size:22px}

header button{
  padding:10px 16px;
  border:none;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
}

.main{padding:30px;max-width:1300px;margin:auto}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(360px,1fr));
  gap:24px;
}

.card{
  background:var(--card);
  border-radius:20px;
  padding:22px;
  box-shadow:0 12px 30px rgba(0,0,0,.08);
  position:relative;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}

.status{
  position:absolute;
  top:18px;
  right:18px;
  padding:6px 12px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
  color:#fff;
}
.pending{background:var(--pending)}
.paid{background:var(--green)}

.info{font-size:14px;color:var(--muted);margin-bottom:6px}
.course{font-weight:600;margin:10px 0}

.actions button{
  width:100%;
  padding:10px;
  border:none;
  border-radius:12px;
  font-weight:600;
  margin-top:8px;
  cursor:pointer;
}

.approve{background:var(--green);color:#fff}
.cancel{background:var(--orange);color:#fff}
.delete{background:var(--red);color:#fff}
.download{background:#0ea5e9;color:#fff}
</style>
</head>

<body>

<header>
  <h1>ðŸ’³ Manage Course Payments</h1>
</header>

<main class="main">
  <div class="grid" id="grid"></div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain: "students-login-29409.firebaseapp.com",
  projectId: "students-login-29409",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const grid = document.getElementById("grid");

/* Load all students and their courses */
async function loadPayments(){
  grid.innerHTML = "";
  const snap = await getDocs(collection(db, "students"));
  let anyRecord = false;

  snap.forEach(docSnap=>{
    const student = docSnap.data();
    if(!student.courses) return;

    Object.entries(student.courses).forEach(([courseName, info])=>{
      if(!info || !info.status) return;
      anyRecord = true;

      const statusClass = info.status === "paid" ? "paid" : "pending";

      grid.innerHTML += `
        <div class="card">
          <div class="status ${statusClass}">${info.status === "paid" ? "Paid" : "Pending"}</div>
          <h3>${student.name}</h3>
          <div class="info">ðŸ“§ ${student.email}</div>
          <div class="info">ðŸ“ž ${student.phone || 'N/A'}</div>
          <div class="info">ðŸ§¾ Invoice: ${info.invoiceNumber || 'N/A'}</div>
          <div class="info">ðŸ’³ Method: ${info.method || 'N/A'}</div>
          <div class="course">ðŸ“˜ ${courseName}</div>
          <div class="actions">
            ${info.status === "pending"
              ? `<button class="approve" onclick="approve('${docSnap.id}','${courseName}')">Approve</button>`
              : `<button class="cancel" onclick="cancel('${docSnap.id}','${courseName}')">Cancel</button>`}
            <button class="download" onclick="downloadInvoice('${info.invoiceNumber}','${student.name}','${courseName}','${info.price || 0}')">Download Invoice</button>
            <button class="delete" onclick="deleteCourse('${docSnap.id}','${courseName}')">Delete</button>
          </div>
        </div>
      `;
    });
  });

  if(!anyRecord){
    grid.innerHTML = "<p>No pending or paid courses found.</p>";
  }
}

/* Approve payment */
window.approve = async (studentId, courseName)=>{
  const ref = doc(db,"students",studentId);
  await updateDoc(ref,{[`courses.${courseName}.status`]:"paid"});
  loadPayments();
};

/* Cancel payment â†’ remove course to revert student to Pay to Start */
window.cancel = async (studentId, courseName)=>{
  const ref = doc(db,"students",studentId);
  await updateDoc(ref,{[`courses.${courseName}`]: deleteField()});
  loadPayments();
};

/* Delete course */
window.deleteCourse = async (studentId, courseName)=>{
  const ref = doc(db,"students",studentId);
  await updateDoc(ref,{[`courses.${courseName}`]: deleteField()});
  loadPayments();
};

/* Download invoice PDF */
window.downloadInvoice = (inv, name, course, price)=>{
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  pdf.text("Food Business Academy",20,20);
  pdf.text(`Invoice: ${inv}`,20,35);
  pdf.text(`Name: ${name}`,20,45);
  pdf.text(`Course: ${course}`,20,55);
  pdf.text(`Amount: $${price}`,20,65);
  pdf.save(`${inv}.pdf`);
};

loadPayments();
</script>
</body>
</html>
