<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin â€“ Manage Payments</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#f4f6fb;
  --card:#ffffff;
  --blue:#2563eb;
  --green:#22c55e;
  --red:#ef4444;
  --orange:#f97316;
  --pending:#f59e0b;
  --text:#1f2937;
  --muted:#6b7280;
}

*{box-sizing:border-box;font-family:'Poppins',sans-serif}
body{margin:0;background:var(--bg)}

header{
  background:#fff;
  padding:20px 30px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 6px 20px rgba(0,0,0,.06);
}

header h1{margin:0;font-size:22px}

header button{
  padding:10px 16px;
  border:none;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
}

.binBtn{background:#e5e7eb}
.adminBtn{background:var(--blue);color:#fff}

main{padding:30px;max-width:1300px;margin:auto}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(360px,1fr));
  gap:24px;
}

.card{
  background:var(--card);
  border-radius:20px;
  padding:22px;
  box-shadow:0 12px 30px rgba(0,0,0,.08);
  position:relative;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}

.status{
  position:absolute;
  top:18px;
  right:18px;
  padding:6px 12px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
  color:#fff;
}
.pending{background:var(--pending)}
.paid{background:var(--green)}

.info{font-size:14px;color:var(--muted);margin-bottom:6px}
.course{font-weight:600;margin:10px 0}

.actions button{
  width:100%;
  padding:10px;
  border:none;
  border-radius:12px;
  font-weight:600;
  margin-top:8px;
  cursor:pointer;
}

.approve{background:var(--green);color:#fff}
.cancel{background:var(--orange);color:#fff}
.delete{background:var(--red);color:#fff}
.restore{background:#0ea5e9;color:#fff}
.download{background:#0ea5e9;color:#fff}
</style>
</head>

<body>

<header>
  <h1>ðŸ’³ Manage Course Payments</h1>
  <div>
    <button class="binBtn" onclick="toggleBin()">ðŸ—‘ Recycle Bin</button>
    <button class="adminBtn">Admin Dashboard</button>
  </div>
</header>

<main class="main">
  <div class="grid" id="grid"></div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain: "students-login-29409.firebaseapp.com",
  projectId: "students-login-29409",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const grid = document.getElementById("grid");
let showBin = false;
let deletedPayments = []; // fresh recycle bin

/* Load all students and their courses */
async function loadPayments(){
  grid.innerHTML = "";
  const snap = await getDocs(collection(db, "students"));
  let records = [];

  snap.forEach(docSnap=>{
    const student = docSnap.data();
    if(!student.courses) return;

    Object.entries(student.courses).forEach(([courseName, info])=>{
      if(!info.status) return; // skip courses with no status
      records.push({
        studentId: docSnap.id,
        name: student.name,
        email: student.email,
        phone: student.phone || "N/A",
        course: courseName,
        ...info
      });
    });
  });

  if(records.length === 0){
    grid.innerHTML = "<p>No pending or paid courses found.</p>";
    return;
  }

  records.forEach((r, i)=>{
    const statusClass = r.status === "paid" ? "paid" : "pending";

    grid.innerHTML += `
      <div class="card">
        <div class="status ${statusClass}">${r.status === "paid" ? "Paid" : "Pending"}</div>
        <h3>${r.name}</h3>
        <div class="info">ðŸ“§ ${r.email}</div>
        <div class="info">ðŸ“ž ${r.phone}</div>
        <div class="info">ðŸ§¾ Invoice: ${r.invoiceNumber || 'N/A'}</div>
        <div class="info">ðŸ’³ Method: ${r.method || 'N/A'}</div>
        <div class="course">ðŸ“˜ ${r.course}</div>
        <div class="actions">
          ${r.status === "pending"
            ? `<button class="approve" onclick="approve('${r.studentId}','${r.course}')">Approve Payment</button>`
            : `<button class="cancel" onclick="cancel('${r.studentId}','${r.course}')">Cancel Payment</button>`}
          <button class="download" onclick="downloadInvoice('${r.invoiceNumber}','${r.name}','${r.course}','${r.price || 0}')">Download Invoice</button>
          <button class="delete" onclick="deletePayment('${r.studentId}','${r.course}')">Delete</button>
        </div>
      </div>
    `;
  });
}

/* Actions */
window.approve = async (studentId, course)=>{
  const ref = doc(db,"students",studentId);
  await updateDoc(ref, {[`courses.${course}.status`]:"paid"});
  loadPayments();
};

window.cancel = async (studentId, course)=>{
  const ref = doc(db,"students",studentId);
  await updateDoc(ref, {[`courses.${course}`]: deleteField()}); // revert to Pay to Start
  loadPayments();
};

window.deletePayment = async (studentId, course)=>{
  deletedPayments.push({studentId, course});
  const ref = doc(db,"students",studentId);
  await updateDoc(ref, {[`courses.${course}`]: deleteField()});
  loadPayments();
};

window.restorePayment = async (studentId, course)=>{
  const ref = doc(db,"students",studentId);
  await updateDoc(ref, {[`courses.${course}.status`]:"pending"});
  deletedPayments = deletedPayments.filter(d=>!(d.studentId===studentId && d.course===course));
  loadPayments();
};

/* PDF Download */
window.downloadInvoice = (inv, name, course, price)=>{
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  pdf.text("Food Business Academy",20,20);
  pdf.text(`Invoice: ${inv}`,20,35);
  pdf.text(`Name: ${name}`,20,45);
  pdf.text(`Course: ${course}`,20,55);
  pdf.text(`Amount: $${price}`,20,65);
  pdf.save(`${inv}.pdf`);
};

/* Recycle bin toggle */
window.toggleBin = ()=>{
  showBin = !showBin;
  if(showBin){
    grid.innerHTML = "";
    if(deletedPayments.length === 0){
      grid.innerHTML = "<p>Recycle bin is empty.</p>";
      return;
    }
    deletedPayments.forEach(d=>{
      grid.innerHTML += `
        <div class="card">
          <div class="info">Student ID: ${d.studentId}</div>
          <div class="info">Course: ${d.course}</div>
          <button class="restore" onclick="restorePayment('${d.studentId}','${d.course}')">Restore</button>
        </div>
      `;
    });
  } else {
    loadPayments();
  }
};

/* Initial load */
loadPayments();
</script>
</body>
</html>
