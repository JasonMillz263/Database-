<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Manage Payments</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#f4f6fb;
  --card:#fff;
  --blue:#2563eb;
  --green:#22c55e;
  --red:#ef4444;
  --pending:#f59e0b;
}

*{box-sizing:border-box;font-family:Poppins}
body{margin:0;background:var(--bg)}

header{
  background:#fff;
  padding:20px;
  display:flex;
  justify-content:space-between;
  box-shadow:0 6px 20px rgba(0,0,0,.06);
}

main{padding:30px;max-width:1200px;margin:auto}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:24px}

.card{
  background:var(--card);
  border-radius:20px;
  padding:22px;
  box-shadow:0 12px 30px rgba(0,0,0,.08);
  position:relative;
}

.status{
  position:absolute;
  top:18px;
  right:18px;
  padding:6px 12px;
  border-radius:999px;
  color:#fff;
  font-size:12px;
}

.pending{background:var(--pending)}
.paid{background:var(--green)}

.actions button{
  width:100%;
  margin-top:8px;
  padding:10px;
  border:none;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
}

.approve{background:var(--green);color:#fff}
.cancel{background:#f97316;color:#fff}
.delete{background:var(--red);color:#fff}
.restore{background:var(--blue);color:#fff}
.download{background:#0ea5e9;color:#fff}
</style>
</head>

<body>

<header>
  <h2>ðŸ’³ Manage Payments</h2>
  <button onclick="toggleBin()">ðŸ—‘ Recycle Bin</button>
</header>

<main>
  <div class="grid" id="grid"></div>
</main>

<script>
const grid=document.getElementById("grid");

let payments=JSON.parse(localStorage.getItem("payments"))||[];
let deleted=JSON.parse(localStorage.getItem("deletedPayments"))||[];
let statusData=JSON.parse(localStorage.getItem("courseStatus"))||{};
let showBin=false;

render();

function render(){
  grid.innerHTML="";
  const list=showBin?deleted:payments;
  if(list.length===0){grid.innerHTML="<p>No records found.</p>";return;}

  list.forEach((p,i)=>{
    const status=statusData[p.email]?.[p.course]||"pending";

    grid.innerHTML+=`
    <div class="card">
      <div class="status ${status}">${status.toUpperCase()}</div>
      <h3>${p.name}</h3>
      <p>${p.email}</p>
      <p>${p.course}</p>
      <p>Invoice: ${p.invoiceNumber}</p>
      <p>Method: ${p.method}</p>

      <div class="actions">
        ${!showBin && status==="pending"?`<button class="approve" onclick="approve('${p.email}','${p.course}')">Approve</button>`:""}
        ${!showBin && status==="paid"?`<button class="cancel" onclick="cancel('${p.email}','${p.course}')">Cancel Approval</button>`:""}
        ${!showBin?`<button class="download" onclick="download('${p.invoiceNumber}','${p.name}','${p.course}','${p.price}')">Invoice</button>`:""}
        ${!showBin?`<button class="delete" onclick="remove(${i})">Delete</button>`:`<button class="restore" onclick="restore(${i})">Restore</button>`}
      </div>
    </div>`;
  });
}

function approve(email,course){
  if(!statusData[email])statusData[email]={};
  statusData[email][course]="paid";
  localStorage.setItem("courseStatus",JSON.stringify(statusData));
  render();
}

function cancel(email,course){
  statusData[email][course]="pending";
  localStorage.setItem("courseStatus",JSON.stringify(statusData));
  render();
}

function remove(i){
  const p=payments[i];
  if(statusData[p.email]){
    delete statusData[p.email][p.course];
    if(Object.keys(statusData[p.email]).length===0) delete statusData[p.email];
  }
  deleted.push(p);
  payments.splice(i,1);
  localStorage.setItem("payments",JSON.stringify(payments));
  localStorage.setItem("deletedPayments",JSON.stringify(deleted));
  localStorage.setItem("courseStatus",JSON.stringify(statusData));
  render();
}

function restore(i){
  const p=deleted[i];
  if(!statusData[p.email])statusData[p.email]={};
  statusData[p.email][p.course]="pending";
  payments.push(p);
  deleted.splice(i,1);
  localStorage.setItem("payments",JSON.stringify(payments));
  localStorage.setItem("deletedPayments",JSON.stringify(deleted));
  localStorage.setItem("courseStatus",JSON.stringify(statusData));
  render();
}

function toggleBin(){showBin=!showBin;render();}

function download(inv,name,course,price){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  pdf.text("Food Business Academy",20,20);
  pdf.text(`Invoice: ${inv}`,20,35);
  pdf.text(`Name: ${name}`,20,45);
  pdf.text(`Course: ${course}`,20,55);
  pdf.text(`Amount: $${price}`,20,65);
  pdf.save(`${inv}.pdf`);
}
</script>

</body>
</html>
