<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin â€“ Manage Payments</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;background:#f4f6fb;font-family:Poppins}
header{
  background:#fff;padding:20px 30px;
  display:flex;justify-content:space-between;align-items:center;
  box-shadow:0 6px 20px rgba(0,0,0,.08)
}
.grid{
  padding:30px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(360px,1fr));
  gap:24px
}
.card{
  background:#fff;
  border-radius:20px;
  padding:22px;
  box-shadow:0 12px 30px rgba(0,0,0,.1);
  position:relative;
}
.status{
  position:absolute;top:18px;right:18px;
  padding:6px 14px;border-radius:999px;
  font-size:12px;font-weight:600;color:#fff
}
.pending{background:#f59e0b}
.paid{background:#22c55e}
.actions button{
  width:100%;
  padding:10px;
  border:none;
  border-radius:12px;
  font-weight:600;
  margin-top:8px;
  cursor:pointer
}
.approve{background:#22c55e;color:#fff}
.cancel{background:#f97316;color:#fff}
.delete{background:#ef4444;color:#fff}
.download{background:#0ea5e9;color:#fff}
</style>
</head>

<body>

<header>
  <h2>ðŸ’³ Admin â€“ Manage Course Payments</h2>
</header>

<div class="grid" id="grid"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc, deleteField } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain: "students-login-29409.firebaseapp.com",
  projectId: "students-login-29409"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const grid = document.getElementById("grid");

async function loadPayments(){
  grid.innerHTML = "";
  const snap = await getDocs(collection(db,"students"));

  snap.forEach(s=>{
    const d = s.data();
    if(!d.courses) return;

    Object.entries(d.courses).forEach(([course, info])=>{
      if(!info || !info.status) return;

      grid.innerHTML += `
        <div class="card">
          <div class="status ${info.status}">
            ${info.status.toUpperCase()}
          </div>

          <h3>${d.name || "Student"}</h3>
          <p>ðŸ“§ ${d.email}</p>
          <p>ðŸ“ž ${d.phone || "N/A"}</p>
          <p>ðŸ§¾ Invoice: ${info.invoiceNumber}</p>
          <p>ðŸ“˜ ${course}</p>

          <div class="actions">
            ${info.status === "pending"
              ? `<button class="approve"
                  onclick="approve('${s.id}','${course}')">
                  Approve Payment</button>`
              : `<button class="cancel"
                  onclick="cancel('${s.id}','${course}')">
                  Cancel Payment</button>`
            }

            <button class="download"
              onclick="invoice('${info.invoiceNumber}',
              '${d.name}','${course}','${info.price}')">
              Download Invoice
            </button>

            <button class="delete"
              onclick="cancel('${s.id}','${course}')">
              Delete Record
            </button>
          </div>
        </div>
      `;
    });
  });
}

window.approve = async (uid, course)=>{
  await updateDoc(doc(db,"students",uid),{
    [`courses.${course}.status`]:"paid"
  });
  loadPayments();
};

window.cancel = async (uid, course)=>{
  await updateDoc(doc(db,"students",uid),{
    [`courses.${course}`]: deleteField()
  });
  loadPayments();
};

window.invoice = (inv,name,course,price)=>{
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  pdf.text("Food Business Academy",20,20);
  pdf.text(`Invoice: ${inv}`,20,35);
  pdf.text(`Name: ${name}`,20,45);
  pdf.text(`Course: ${course}`,20,55);
  pdf.text(`Amount: $${price}`,20,65);
  pdf.save(`${inv}.pdf`);
};

loadPayments();
</script>

</body>
</html>
