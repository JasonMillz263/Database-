<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    :root { --primary: #4f46e5; --bg: #f3f4f6; --white: #ffffff; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 0; color: #1f2937; }
    
    /* Nav */
    .navbar { background: var(--primary); color: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 50; display: flex; justify-content: space-between; align-items: center; }
    .navbar h1 { margin: 0; font-size: 18px; font-weight: 600; }
    
    .container { max-width: 900px; margin: 30px auto; padding: 0 15px; }

    /* Ticket Card */
    .ticket-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: transform 0.2s; border-left: 5px solid #ccc; }
    
    /* Dynamic Borders */
    .border-open { border-left-color: #3b82f6; }
    .border-in_review { border-left-color: #f59e0b; }
    .border-closed { border-left-color: #10b981; opacity: 0.8; }

    .header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .user-info { font-weight: 700; color: #111827; }
    .user-email { font-weight: 400; color: #6b7280; font-size: 13px; display: block; }
    
    .ticket-body { background: #f9fafb; padding: 15px; border-radius: 8px; font-size: 14px; line-height: 1.5; color: #374151; margin-bottom: 15px; }
    
    /* Controls Area */
    .controls { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; border-top: 1px solid #e5e7eb; padding-top: 15px; align-items: center; }
    
    select { padding: 8px 12px; border-radius: 6px; border: 1px solid #d1d5db; background: white; cursor: pointer; font-weight: 500; }
    
    .reply-input { flex-grow: 1; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; min-width: 200px; }
    
    .btn-save { background: var(--primary); color: white; border: none; padding: 9px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .btn-save:hover { background: #4338ca; }

    /* Image Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; }
    .modal img { max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
    
    .view-proof-btn { color: var(--primary); text-decoration: underline; cursor: pointer; font-size: 13px; font-weight: 500; }
    
    #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; }
</style>
</head>
<body>

<div id="loginOverlay">
    <h2>üîí Admin Access</h2>
    <p>Please login to verify permissions</p>
    <button onclick="adminLogin()" class="btn-save" style="font-size:16px; padding:12px 24px;">Login as Admin</button>
</div>

<div class="navbar">
    <h1>üéüÔ∏è Admin Inbox</h1>
    <button onclick="logout()" style="background:none; border:none; color:white; cursor:pointer;">Logout</button>
</div>

<div class="container" id="inbox">
    <p style="text-align: center; color: #6b7280;">Loading tickets...</p>
</div>

<div class="modal" id="imgModal" onclick="this.style.display='none'">
    <img id="modalImg" src="">
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
      authDomain: "students-login-29409.firebaseapp.com",
      projectId: "students-login-29409",
      storageBucket: "students-login-29409.firebasestorage.app",
      messagingSenderId: "634331456872",
      appId: "1:634331456872:web:6dae360c5e28d8356562dd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Auth Logic ---
    window.adminLogin = () => signInWithPopup(auth, new GoogleAuthProvider());
    window.logout = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('loginOverlay').style.display = 'none';
            loadAllTickets();
        } else {
            document.getElementById('loginOverlay').style.display = 'flex';
        }
    });

    // --- Load Tickets ---
    function loadAllTickets() {
        const q = query(collection(db, "tickets"), orderBy("createdAt", "desc"));

        onSnapshot(q, (snapshot) => {
            const inbox = document.getElementById("inbox");
            if(snapshot.empty) {
                inbox.innerHTML = "<div style='text-align:center; padding:50px;'>üéâ All caught up! No tickets.</div>";
                return;
            }

            inbox.innerHTML = snapshot.docs.map(docSnap => {
                const t = docSnap.data();
                const id = docSnap.id;
                const date = t.createdAt ? t.createdAt.toDate().toLocaleString() : 'Pending...';
                
                return `
                <div class="ticket-card border-${t.status}">
                    <div class="header-row">
                        <div>
                            <span class="user-info">${t.studentName || 'Unknown Student'}</span>
                            <span class="user-email">${t.studentEmail}</span>
                        </div>
                        <div style="text-align:right">
                            <span style="font-size:12px; color:#9ca3af;">${date}</span><br>
                            <span style="font-size:12px; font-weight:bold; text-transform:uppercase; color:#4f46e5;">${t.category}</span>
                        </div>
                    </div>

                    <div class="ticket-body">
                        <strong>Subject: ${t.subject}</strong><br>
                        ${t.message}
                        ${t.attachment ? `<div style="margin-top:10px;"><span class="view-proof-btn" onclick="openImage('${t.attachment}')">üì∏ View Attachment</span></div>` : ''}
                    </div>

                    <div class="controls">
                        <select id="status-${id}">
                            <option value="open" ${t.status === 'open' ? 'selected' : ''}>üîµ Open</option>
                            <option value="in_review" ${t.status === 'in_review' ? 'selected' : ''}>üü† In Review</option>
                            <option value="closed" ${t.status === 'closed' ? 'selected' : ''}>üü¢ Closed</option>
                        </select>
                        
                        <input type="text" class="reply-input" id="reply-${id}" value="${t.adminResponse || ''}" placeholder="Type reply here...">
                        
                        <button class="btn-save" onclick="updateTicket('${id}')">Update</button>
                    </div>
                </div>`;
            }).join("");
        });
    }

    // --- Actions ---
    window.updateTicket = async (id) => {
        const newStatus = document.getElementById(`status-${id}`).value;
        const newReply = document.getElementById(`reply-${id}`).value;
        
        try {
            const ticketRef = doc(db, "tickets", id);
            await updateDoc(ticketRef, {
                status: newStatus,
                adminResponse: newReply
            });
            // Visual feedback not needed as onSnapshot updates UI automatically
        } catch (error) {
            alert("Error updating: " + error.message);
        }
    };

    window.openImage = (base64) => {
        document.getElementById('modalImg').src = base64;
        document.getElementById('imgModal').style.display = 'flex';
    };
</script>
</body>
</html>
