<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Management Course | Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<style>
body{margin:0;font-family:Poppins;background:#f4f4f4}
header{background:#111;color:#fff;padding:15px}
.container{max-width:1200px;margin:auto;padding:20px}
.panel{background:#fff;border-radius:12px;padding:20px}
button{padding:10px 16px;border:none;border-radius:6px;cursor:pointer}
.publish{background:#4B0E17;color:#fff}
.draft{background:#555;color:#fff}
.delete{background:#FF4136;color:#fff}
.view{background:#0074D9;color:#fff}
.module{border:1px solid #ddd;padding:12px;border-radius:8px;margin-top:10px}
.quiz{background:#fafafa;padding:8px;margin-top:6px;border-radius:6px}
input,textarea{width:100%;padding:8px;margin-top:6px}
#editor{height:200px;margin-bottom:10px}
.top-actions button{margin-right:8px}
</style>
</head>

<body>

<header>
  <h2>Management Course â€” Admin Panel</h2>
</header>

<div class="container">
<div class="panel">

<h3>Course Controls</h3>
<div class="top-actions">
  <button class="view" onclick="loadCourse('published')">Published</button>
  <button class="draft" onclick="loadCourse('draft')">Draft</button>
</div>

<hr>

<h3>Add / Edit Module</h3>
<input id="moduleTitle" placeholder="Module Title">
<div id="editor"></div>
<input id="videoUrl" placeholder="Video URL">

<h4>Quiz</h4>
<input id="question" placeholder="Question">
<input id="opt1" placeholder="Option A">
<input id="opt2" placeholder="Option B">
<input id="opt3" placeholder="Option C">
<input id="answer" placeholder="Correct Answer">
<button onclick="addQuiz()">Add Quiz</button>

<hr>

<button class="publish" onclick="saveModule('published')">Save & Publish</button>
<button class="draft" onclick="saveModule('draft')">Save Draft</button>

<hr>

<h3>Existing Modules</h3>
<div id="modulesList"></div>

</div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc,
  collection, getDocs, deleteDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

import {
  getAuth, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain: "students-login-29409.firebaseapp.com",
  projectId: "students-login-29409",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ðŸ” ADMIN AUTH CHECK */
onAuthStateChanged(auth, async user => {
  if (!user) return location.href="login.html";

  const adminSnap = await getDoc(doc(db,"admins",user.uid));
  if (!adminSnap.exists()) {
    alert("Access denied");
    location.href="index.html";
  }
});

/* ================= QUILL ================= */
const quill = new Quill('#editor',{theme:'snow'});

/* ================= STATE ================= */
let quizzes = [];
let editingModuleId = null;
const COURSE_ID = "management_course";

/* ================= QUIZ ================= */
window.addQuiz = () => {
  quizzes.push({
    question: question.value,
    options:[opt1.value,opt2.value,opt3.value],
    answer: answer.value
  });
  alert("Quiz added");
  question.value = opt1.value = opt2.value = opt3.value = answer.value = "";
};

/* ================= SAVE MODULE ================= */
window.saveModule = async status => {
  const courseRef = doc(db,"courses",COURSE_ID);

  await setDoc(courseRef,{
    title:"Management Course",
    status,
    updatedAt: serverTimestamp()
  },{merge:true});

  const moduleRef = doc(collection(courseRef,"modules"));
  await setDoc(moduleRef,{
    title: moduleTitle.value,
    content: quill.root.innerHTML,
    videoUrl: videoUrl.value,
    quizzes
  });

  alert("Saved");
  loadCourse(status);
};

/* ================= LOAD ================= */
window.loadCourse = async status => {
  modulesList.innerHTML = "";
  const courseRef = doc(db,"courses",COURSE_ID);
  const modulesSnap = await getDocs(collection(courseRef,"modules"));

  modulesSnap.forEach(m=>{
    const d = m.data();
    modulesList.innerHTML += `
      <div class="module">
        <strong>${d.title}</strong>
        <div>${d.content}</div>
        ${d.quizzes.map(q=>`<div class="quiz">${q.question}</div>`).join("")}
        <button class="delete" onclick="deleteModule('${m.id}')">Delete</button>
      </div>
    `;
  });
};

/* ================= DELETE ================= */
window.deleteModule = async id => {
  await deleteDoc(doc(db,"courses",COURSE_ID,"modules",id));
  loadCourse();
};
</script>

</body>
</html>
