<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin | Management Course</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<style>
body{margin:0;font-family:Poppins;background:#f4f4f4}
header{background:#111;color:#fff;padding:15px}
.container{max-width:1200px;margin:auto;padding:20px}
.panel{background:#fff;padding:20px;border-radius:12px}
button{padding:8px 14px;border:none;border-radius:6px;cursor:pointer;margin-right:6px}
.publish{background:#4B0E17;color:#fff}
.draft{background:#555;color:#fff}
.delete{background:#e53935;color:#fff}
.edit{background:#0074D9;color:#fff}
.module{border:1px solid #ddd;padding:12px;border-radius:8px;margin-top:10px;cursor:grab}
input,textarea{width:100%;padding:8px;margin-top:6px}
#editor{height:200px}
.quiz{background:#fafafa;padding:8px;border-radius:6px;margin-top:6px}
.small{font-size:13px;opacity:.8}
</style>
</head>

<body>

<header>
  <h2>Admin Panel â€” Management Course</h2>
</header>

<div class="container">
<div class="panel">

<h3>Add / Edit Module</h3>

<input id="moduleTitle" placeholder="Module title">
<input id="imageUrl" placeholder="Image URL (optional)">
<input id="videoUrl" placeholder="Video URL (YouTube embed)">

<div id="editor"></div>

<h4>Quiz</h4>
<input id="question" placeholder="Question">
<input id="opt1" placeholder="Option A">
<input id="opt2" placeholder="Option B">
<input id="opt3" placeholder="Option C">
<input id="answer" placeholder="Correct Answer">
<button onclick="addQuiz()">Add Quiz</button>

<div id="quizPreview"></div>

<hr>

<button class="publish" onclick="saveModule('published')">Publish Module</button>
<button class="draft" onclick="saveModule('draft')">Save as Draft</button>

<hr>

<h3>Modules (Drag to reorder)</h3>
<div id="modulesList"></div>

<hr>

<h3>Recycle Bin</h3>
<div id="recycleList"></div>

</div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, getDocs,
  collection, deleteDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

/* ================= FIREBASE ================= */
const app = initializeApp({
  apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain:"students-login-29409.firebaseapp.com",
  projectId:"students-login-29409"
});

const db = getFirestore(app);
const auth = getAuth(app);

/* ================= CONSTANTS ================= */
const COURSE_ID = "management_course";
let editingModuleId = null;
let quizzes = [];

/* ================= AUTH CHECK ================= */
onAuthStateChanged(auth, async user=>{
  if(!user) return location.href="login.html";

  const adminSnap = await getDoc(doc(db,"admins",user.uid));
  if(!adminSnap.exists()){
    alert("Access denied: Admins only");
    auth.signOut();
    return;
  }

  await ensureCourseExists();
  loadModules();
});

/* ================= ENSURE COURSE ================= */
async function ensureCourseExists(){
  const ref = doc(db,"courses",COURSE_ID);
  if(!(await getDoc(ref)).exists()){
    await setDoc(ref,{
      title:"Management Course",
      status:"published",
      createdAt:serverTimestamp()
    });
  }
}

/* ================= EDITOR ================= */
const quill = new Quill('#editor',{theme:'snow'});

/* ================= QUIZ ================= */
window.addQuiz = ()=>{
  quizzes.push({
    question:question.value,
    options:[opt1.value,opt2.value,opt3.value],
    answer:answer.value
  });

  quizPreview.innerHTML += `<div class="quiz">${question.value}</div>`;
  question.value=opt1.value=opt2.value=opt3.value=answer.value="";
};

/* ================= SAVE MODULE ================= */
window.saveModule = async status=>{
  const ref = editingModuleId
    ? doc(db,"courses",COURSE_ID,"modules",editingModuleId)
    : doc(collection(db,"courses",COURSE_ID,"modules"));

  await setDoc(ref,{
    title:moduleTitle.value,
    content:quill.root.innerHTML,
    imageUrl:imageUrl.value,
    videoUrl:videoUrl.value,
    quizzes,
    status,
    order:Date.now(),
    updatedAt:serverTimestamp()
  });

  resetEditor();
  loadModules();
};

/* ================= LOAD MODULES ================= */
async function loadModules(){
  modulesList.innerHTML="";
  const snap = await getDocs(collection(db,"courses",COURSE_ID,"modules"));

  snap.docs
    .sort((a,b)=>a.data().order-b.data().order)
    .forEach(d=>{
      const m=d.data();
      modulesList.innerHTML+=`
        <div class="module" data-id="${d.id}">
          <strong>${m.title}</strong>
          <div class="small">Status: ${m.status}</div>
          <button class="edit" onclick="editModule('${d.id}')">Edit</button>
          <button class="delete" onclick="deleteModule('${d.id}')">Delete</button>
        </div>`;
    });

  new Sortable(modulesList,{onEnd:updateOrder});
}

/* ================= EDIT MODULE ================= */
window.editModule = async id=>{
  const snap = await getDoc(doc(db,"courses",COURSE_ID,"modules",id));
  const m = snap.data();

  editingModuleId = id;
  moduleTitle.value = m.title;
  imageUrl.value = m.imageUrl || "";
  videoUrl.value = m.videoUrl || "";
  quill.root.innerHTML = m.content;
  quizzes = m.quizzes || [];
  quizPreview.innerHTML = quizzes.map(q=>`<div class="quiz">${q.question}</div>`).join("");
};

/* ================= ORDER ================= */
async function updateOrder(){
  [...modulesList.children].forEach(async(el,i)=>{
    await setDoc(
      doc(db,"courses",COURSE_ID,"modules",el.dataset.id),
      {order:i},
      {merge:true}
    );
  });
}

/* ================= DELETE ================= */
window.deleteModule = async id=>{
  const snap = await getDoc(doc(db,"courses",COURSE_ID,"modules",id));
  await setDoc(doc(db,"recycleBin",id), snap.data());
  await deleteDoc(doc(db,"courses",COURSE_ID,"modules",id));
  loadModules();
};

/* ================= RESET ================= */
function resetEditor(){
  editingModuleId=null;
  moduleTitle.value="";
  imageUrl.value="";
  videoUrl.value="";
  quill.root.innerHTML="";
  quizzes=[];
  quizPreview.innerHTML="";
}
</script>

</body>
</html>
