<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin – Management Course</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
body{margin:0;padding:12px;font-family:Segoe UI;background:#f1f5f9}
body.dark{background:#0f172a;color:#e5e7eb}
header{background:#4f46e5;color:#fff;padding:16px;border-radius:12px;display:flex;justify-content:space-between;align-items:center}
.card{background:#fff;padding:16px;border-radius:12px;margin-top:12px}
body.dark .card{background:#020617}
input,button{width:100%;padding:10px;margin:6px 0}
button{border:none;border-radius:6px;font-weight:bold;cursor:pointer}
.publish{background:#16a34a;color:#fff}
.draft{background:#f59e0b}
.delete{background:#dc2626;color:#fff}
.neutral{background:#e5e7eb}
.hidden{display:none}
.quiz{background:#eef2ff;padding:10px;border-radius:8px;margin:8px 0}
.notice{background:#e0f2fe;padding:8px;border-radius:6px}
.tabs{display:flex;gap:8px;margin-top:12px}
.tabs button.active{background:#4f46e5;color:#fff}
</style>
</head>

<body>

<header>
  <div style="display:flex;gap:10px;align-items:center">
    <button id="backBtn" class="neutral hidden">⬅ Back</button>
    <h3>Admin – Management Course</h3>
  </div>
  <span id="authStatus">Checking authentication...</span>
</header>

<div id="editor" class="card hidden">
  <h3>Module Editor</h3>
  <input id="title" placeholder="Module title">

  <div id="uploadNotice" class="notice hidden"></div>
  <div id="quill" style="height:240px"></div>

  <button class="draft" onclick="saveModule('draft')">Save Draft</button>
  <button class="publish" onclick="publish()">Publish</button>
</div>

<div id="tabsWrap" class="tabs hidden">
  <button id="pubBtn" class="active" onclick="showTab('published')">Published</button>
  <button onclick="showTab('draft')">Drafts</button>
</div>

<div id="published" class="card"></div>
<div id="draft" class="card hidden"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

const app = initializeApp({
  apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain:"students-login-29409.firebaseapp.com",
  projectId:"students-login-29409"
});

const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

signInWithEmailAndPassword(auth,"ADMIN_EMAIL","ADMIN_PASSWORD");

let editingId=null;
let uploading=false;
let dirty=false;

/* QUILL */
const quill = new Quill("#quill",{
  theme:"snow",
  modules:{toolbar:[["bold","italic","underline"],["image","link"]]}
});

quill.on("text-change",()=>dirty=true);
title.oninput=()=>dirty=true;

/* IMAGE UPLOAD */
quill.getModule("toolbar").addHandler("image",()=>{
  const input=document.createElement("input");
  input.type="file";input.accept="image/*";input.click();
  input.onchange=()=>{
    const file=input.files[0];
    if(!file) return;
    uploading=true;
    uploadNotice.classList.remove("hidden");
    const task=uploadBytesResumable(ref(storage,"quill/"+Date.now()+"_"+file.name),file);
    task.on("state_changed",s=>{
      uploadNotice.innerText=`Uploading image ${Math.round(s.bytesTransferred/s.totalBytes*100)}%`;
    },()=>{
      alert("Upload failed");
      uploading=false;
    },async()=>{
      const url=await getDownloadURL(task.snapshot.ref);
      quill.insertEmbed(quill.getSelection().index,"image",url);
      uploading=false;
      uploadNotice.classList.add("hidden");
    });
  };
});

/* AUTO DRAFT (BLOGGER STYLE) */
function autoDraft(){
  if(!dirty) return;
  if(!title.value && !quill.getText().trim()) return;
  saveModule("draft",true);
}
window.addEventListener("beforeunload",autoDraft);
window.addEventListener("offline",autoDraft);

backBtn.onclick=()=>{
  autoDraft();
  editor.classList.add("hidden");
  tabsWrap.classList.remove("hidden");
};

/* SAVE */
window.saveModule = async (status,silent=false)=>{
  if(status==="published"){
    if(!title.value.trim()) return alert("Module title is required");
    if(!quill.getText().trim()) return alert("Module content is required");
    if(uploading) return alert("Please wait for image upload to finish");
  }
  const data={
    title:title.value,
    content:quill.root.innerHTML,
    status,
    updatedAt:serverTimestamp()
  };
  if(editingId){
    await updateDoc(doc(db,"courses/management_course/modules",editingId),data);
  }else{
    await addDoc(collection(db,"courses/management_course/modules"),{...data,createdAt:serverTimestamp()});
  }
  dirty=false;
  if(!silent) alert(status==="published"?"Published successfully":"Draft saved");
  loadModules();
};

/* PUBLISH WRAPPER */
window.publish=()=>saveModule("published");

/* LOAD MODULES */
async function loadModules(){
  published.innerHTML=draft.innerHTML="";
  const snap=await getDocs(collection(db,"courses/management_course/modules"));
  snap.forEach(d=>{
    const m=d.data();
    const box=`<div class="quiz"><b>${m.title||"(Untitled)"}</b></div>`;
    if(m.status==="published") published.innerHTML+=box;
    if(m.status==="draft") draft.innerHTML+=box;
  });
}

/* TABS */
window.showTab=id=>{
  published.classList.toggle("hidden",id!=="published");
  draft.classList.toggle("hidden",id!=="draft");
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");
};

/* AUTH */
onAuthStateChanged(auth,u=>{
  if(!u){authStatus.innerText="❌ Not logged in";return;}
  authStatus.innerText="✅ Admin authenticated";
  tabsWrap.classList.remove("hidden");
  editor.classList.remove("hidden");
  loadModules();
});
</script>

</body>
  </html>
