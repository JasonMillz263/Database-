<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin – Management Course</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
/* ================= ROOT THEME ================= */
:root{
  --bg:#f1f5f9;
  --card:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --primary:#4f46e5;
  --success:#16a34a;
  --warning:#f59e0b;
  --danger:#dc2626;
}
body.dark{
  --bg:#0f172a;
  --card:#1e293b;
  --text:#f8fafc;
  --muted:#94a3b8;
}

/* ================= BASE ================= */
body{
  font-family:Segoe UI;
  background:var(--bg);
  color:var(--text);
  margin:0;
  padding:12px;
}
header{
  background:var(--primary);
  color:#fff;
  padding:16px;
  border-radius:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.card{
  background:var(--card);
  padding:16px;
  border-radius:12px;
  margin-top:12px;
}
input,button{
  width:100%;
  padding:10px;
  margin:6px 0;
}
button{
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
  transition:.15s;
}
button:active{transform:scale(.97)}
.publish{background:var(--success);color:#fff}
.draft{background:var(--warning)}
.delete{background:var(--danger);color:#fff}
.view{background:#0ea5e9;color:#fff}
.hidden{display:none}

/* ================= TABS ================= */
.tabs{
  display:flex;
  gap:8px;
  margin-top:12px;
}
.tabs button{
  flex:1;
  background:#e5e7eb;
}
.tabs button.active{
  background:var(--primary);
  color:#fff;
}

/* ================= MODULE CARD ================= */
.module{
  border-left:5px solid var(--primary);
  padding:12px;
  margin-bottom:10px;
}
.module small{color:var(--muted)}
.badge{
  font-size:12px;
  padding:2px 6px;
  border-radius:6px;
}
.badge.published{background:var(--success);color:#fff}
.badge.draft{background:var(--warning)}
.badge.deleted{background:var(--danger);color:#fff}

/* ================= STATUS OVERLAY ================= */
#status{
  position:fixed;
  top:16px;
  right:16px;
  background:var(--card);
  padding:12px 16px;
  border-radius:10px;
  box-shadow:0 10px 25px rgba(0,0,0,.2);
  display:none;
  align-items:center;
  gap:10px;
  z-index:999;
}
.spinner{
  width:18px;
  height:18px;
  border:3px solid #ddd;
  border-top:3px solid var(--primary);
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ================= VIEWER ================= */
#viewer h2{margin-top:0}

/* ================= MOBILE ================= */
@media(max-width:768px){
  .tabs{flex-direction:column}
}
</style>
</head>

<body>

<header>
  <h3><i class="fa fa-user-shield"></i> Admin – Management Course</h3>
  <button onclick="toggleTheme()"><i class="fa fa-moon"></i></button>
</header>

<div id="status">
  <div class="spinner"></div>
  <span id="statusText"></span>
</div>

<!-- ================= EDITOR ================= -->
<div class="card hidden" id="editor">
  <h3>Module Editor</h3>

  <input id="title" placeholder="Module title">
  <input id="imageUrl" placeholder="Cover Image URL">
  <input id="videoUrl" placeholder="Video URL">

  <div id="quill" style="height:220px"></div>

  <button class="draft" onclick="saveModule('draft')">Save Draft</button>
  <button class="publish" onclick="saveModule('published')">Publish</button>
</div>

<!-- ================= VIEWER ================= -->
<div class="card hidden" id="viewer"></div>

<!-- ================= TABS ================= -->
<div class="tabs">
  <button class="active" onclick="switchTab('published')">Published</button>
  <button onclick="switchTab('draft')">Drafts</button>
  <button onclick="switchTab('deleted')">Recycle Bin</button>
</div>

<div class="card" id="publishedTab"></div>
<div class="card hidden" id="draftTab"></div>
<div class="card hidden" id="deletedTab"></div>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, updateDoc,
  getDocs, getDoc, doc, query, orderBy, serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import {
  getAuth, signInWithEmailAndPassword, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getStorage, ref, uploadBytesResumable, getDownloadURL
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

const app = initializeApp({
  apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain:"students-login-29409.firebaseapp.com",
  projectId:"students-login-29409",
  storageBucket:"students-login-29409.appspot.com"
});

const db=getFirestore(app);
const auth=getAuth(app);
const storage=getStorage(app);

signInWithEmailAndPassword(auth,"ADMIN_EMAIL","ADMIN_PASSWORD");

/* ================= STATE ================= */
let editingId=null;
let autosaveTimer=null;

/* ================= STATUS ================= */
function showStatus(text){
  statusText.innerText=text;
  status.style.display="flex";
}
function hideStatus(){
  setTimeout(()=>status.style.display="none",1200);
}

/* ================= THEME ================= */
window.toggleTheme=()=>{
  document.body.classList.toggle("dark");
  localStorage.theme=document.body.classList.contains("dark")?"dark":"light";
};
if(localStorage.theme==="dark")document.body.classList.add("dark");

/* ================= QUILL WITH IMAGE UPLOAD ================= */
const quill=new Quill("#quill",{
  theme:"snow",
  modules:{
    toolbar:{
      container:[
        ["bold","italic","underline"],
        ["image","link"],
        [{list:"ordered"},{list:"bullet"}]
      ],
      handlers:{
        image:()=>{
          const input=document.createElement("input");
          input.type="file";
          input.accept="image/*";
          input.click();
          input.onchange=()=>{
            const file=input.files[0];
            const r=ref(storage,"modules/"+Date.now()+"_"+file.name);
            const task=uploadBytesResumable(r,file);
            showStatus("Uploading image...");
            task.on("state_changed",s=>{
              statusText.innerText="Uploading "+Math.round(s.bytesTransferred/s.totalBytes*100)+"%";
            },null,async()=>{
              const url=await getDownloadURL(task.snapshot.ref);
              const range=quill.getSelection();
              quill.insertEmbed(range.index,"image",url);
              hideStatus();
            });
          };
        }
      }
    }
  }
});

/* ================= AUTOSAVE DRAFT ================= */
function autoSave(){
  const data={
    title:title.value,
    imageUrl:imageUrl.value,
    videoUrl:videoUrl.value,
    content:quill.root.innerHTML
  };
  localStorage.autodraft=JSON.stringify(data);
}
autosaveTimer=setInterval(autoSave,10000);
window.addEventListener("offline",()=>showStatus("Offline – auto-saving draft"));

if(localStorage.autodraft){
  const d=JSON.parse(localStorage.autodraft);
  title.value=d.title||"";
  imageUrl.value=d.imageUrl||"";
  videoUrl.value=d.videoUrl||"";
  quill.root.innerHTML=d.content||"";
}

/* ================= SAVE MODULE ================= */
window.saveModule=async statusType=>{
  showStatus(statusType==="published"?"Publishing...":"Saving draft...");
  const refCol=collection(db,"courses","management_course","modules");
  const data={
    title:title.value,
    imageUrl:imageUrl.value,
    videoUrl:videoUrl.value,
    content:quill.root.innerHTML,
    status:statusType,
    updatedAt:serverTimestamp()
  };
  editingId
    ? await updateDoc(doc(refCol,editingId),data)
    : await addDoc(refCol,data);
  localStorage.removeItem("autodraft");
  editingId=null;
  hideStatus();
  loadModules();
};

/* ================= LOAD MODULES ================= */
async function loadModules(){
  publishedTab.innerHTML=draftTab.innerHTML=deletedTab.innerHTML="";
  const q=query(
    collection(db,"courses","management_course","modules"),
    orderBy("updatedAt","desc")
  );
  const snap=await getDocs(q);
  snap.forEach(d=>{
    const m=d.data();
    const el=`
    <div class="module">
      <b>${m.title}</b>
      <span class="badge ${m.status}">${m.status}</span><br>
      <small>${m.updatedAt?.toDate?.().toLocaleString()||""}</small><br>
      <button onclick="view('${d.id}')">View</button>
      <button onclick="edit('${d.id}')">Edit</button>
      <button class="delete" onclick="remove('${d.id}')">Delete</button>
    </div>`;
    if(m.status==="published")publishedTab.innerHTML+=el;
    if(m.status==="draft")draftTab.innerHTML+=el;
    if(m.status==="deleted")deletedTab.innerHTML+=el;
  });
}
loadModules();

/* ================= VIEW ================= */
window.view=async id=>{
  const s=await getDoc(doc(db,"courses","management_course","modules",id));
  const m=s.data();
  viewer.innerHTML=`
    <h2>${m.title}</h2>
    ${m.imageUrl?`<img src="${m.imageUrl}" width="100%">`:""}
    ${m.videoUrl?`<iframe src="${m.videoUrl}" width="100%" height="240"></iframe>`:""}
    <div>${m.content}</div>
    <button onclick="back()">Back</button>
  `;
  viewer.classList.remove("hidden");
  editor.classList.add("hidden");
};

/* ================= EDIT ================= */
window.edit=async id=>{
  const s=await getDoc(doc(db,"courses","management_course","modules",id));
  const m=s.data();
  title.value=m.title;
  imageUrl.value=m.imageUrl;
  videoUrl.value=m.videoUrl;
  quill.root.innerHTML=m.content;
  editingId=id;
  editor.classList.remove("hidden");
};

/* ================= DELETE ================= */
window.remove=async id=>{
  showStatus("Moving to recycle bin...");
  await updateDoc(doc(db,"courses","management_course","modules",id),{status:"deleted"});
  hideStatus();
  loadModules();
};

/* ================= NAV ================= */
window.switchTab=tab=>{
  ["published","draft","deleted"].forEach(t=>{
    document.getElementById(t+"Tab").classList.add("hidden");
  });
  document.getElementById(tab+"Tab").classList.remove("hidden");
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");
};
window.back=()=>{
  viewer.classList.add("hidden");
};
</script>

</body>
</html>
