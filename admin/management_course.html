
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin â€“ Management Course</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
/* --- GLOBAL STYLES --- */
*{box-sizing:border-box}
html,body{overflow-x:hidden}
body{
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: #f1f5f9;
  padding: 10px;
  margin: 0;
  color: #334155;
}
body.dark{background:#0f172a;color:#f1f5f9}

/* HEADER */
header{
  background: #4f46e5;
  color: #fff;
  padding: 16px;
  border-radius: 12px;
  margin-bottom: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.header-left{display: flex; gap: 10px; align-items: center; font-size: 18px;}
.header-right{display: flex; gap: 10px; align-items: center;}
.header-chip{
  background: rgba(255,255,255,0.2);
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 12px;
}
.theme-btn{
  background: rgba(255,255,255,0.2);
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  cursor: pointer;
  color: #fff;
}

/* CARDS & INPUTS */
.card{
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  margin-top: 15px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
body.dark .card{background: #1e293b; border: 1px solid #334155;}
.hidden{display:none}

input, button {
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  border-radius: 8px;
  font-size: 15px;
  outline: none;
}
input { border: 1px solid #cbd5e1; }
body.dark input {background: #0f172a; border-color: #334155; color: #fff;}

button { border: none; font-weight: 600; cursor: pointer; color:#fff; transition:0.2s; }
button:active {transform: scale(0.98);}
.publish{background:#16a34a}
.draft{background:#f59e0b;color:#000}
.delete{background:#ef4444}
.view{background:#0ea5e9}
.action-btn{background:#e2e8f0; color:#334155}
body.dark .action-btn{background:#334155; color:#fff}

/* TABS */
.tabs{display:flex; gap:10px; margin-top:15px;}
.tabs button{flex:1; background: #cbd5e1; color: #475569;}
.tabs button.active{background: #4f46e5; color: #fff;}

/* --- EDITOR STYLES --- */
#quill-container{
  position: relative;
  background: #fff;
  border-radius: 12px;
  margin-bottom: 20px;
}
body.dark #quill-container{background:#1e293b;}
#quill { height: 400px; border: none; }
.ql-toolbar { border-radius: 12px 12px 0 0; }

/* HTML CODE VIEW AREA */
.ql-html-textarea {
  width: 100%;
  height: 100%;
  background: #282c34;
  color: #abb2bf;
  font-family: monospace;
  padding: 15px;
  border: none;
  display: none;
  resize: none;
  position: absolute;
  top: 42px;
  left: 0;
  z-index: 10;
}

/* --- PDF IFRAME STYLING --- */
/* This ensures the iframe looks good even if Quill strips inline styles */
iframe {
  width: 100%;
  height: 600px; /* Requested height */
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  background: #f8fafc;
  display: block;
}
/* The container for the PDF and TTS button */
.pdf-container {
  margin: 15px 0;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  overflow: hidden;
}
.pdf-tts-bar {
  background: #f1f5f9;
  padding: 8px 12px;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid #e2e8f0;
}
.tts-btn {
  background: #4f46e5;
  color: white;
  border: none;
  padding: 5px 12px;
  border-radius: 4px;
  font-size: 13px;
  cursor: pointer;
  width: auto;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  margin: 0;
}
.tts-btn:hover { background: #4338ca; }

/* QUIZZES */
.quiz-item{
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 8px;
}
body.dark .quiz-item{background: #0f172a; border-color: #334155;}

/* TOAST */
#toast{
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: #1e293b;
  color: #fff;
  padding: 12px 20px;
  border-radius: 30px;
  z-index: 9999;
}

@media(min-width:768px){ body{max-width:800px;margin:20px auto} }
</style>
</head>

<body>

<header>
  <div class="header-left">
    <i class="fa fa-shield-halved"></i> <b>Admin Panel</b>
  </div>
  <div class="header-right">
    <div id="authStatus" class="header-chip">Checking...</div>
    <button class="theme-btn" onclick="toggleTheme()">ðŸŒ“</button>
  </div>
</header>

<div id="toast" class="hidden"><i class="fa fa-spinner fa-spin"></i> <span id="toastText"></span></div>

<div class="card hidden" id="addModuleCard">
  <button class="publish" onclick="openEditor()">âž• Create New Module</button>
</div>

<div class="tabs">
  <button class="active" onclick="showTab('publishedTab',this)">Published</button>
  <button onclick="showTab('draftTab',this)">Drafts</button>
  <button onclick="showTab('binTab',this)">Recycle Bin</button>
</div>

<div class="card" id="publishedTab"></div>
<div class="card hidden" id="draftTab"></div>
<div class="card hidden" id="binTab"></div>

<div class="card hidden" id="editor">
  <h3>Module Editor</h3>
  <input id="title" placeholder="Module Title">
  <input id="videoUrl" placeholder="Video URL (Optional)">
  
  <div id="quill-container">
    <div id="quill"></div>
    </div>

  <h4>Quiz Builder</h4>
  <input id="q" placeholder="Question">
  <input id="o1" placeholder="Option 1">
  <input id="o2" placeholder="Option 2">
  <input id="o3" placeholder="Option 3">
  <input id="o4" placeholder="Option 4">
  <input id="a" placeholder="Correct Answer">
  <button class="action-btn" onclick="addQuiz()">Add Question</button>
  <div id="quizList" style="margin-top:10px"></div>
  
  <div style="display:flex; gap:10px; margin-top:20px">
    <button class="draft" onclick="saveModule('draft')">Save Draft</button>
    <button class="publish" onclick="saveModule('published')">Publish</button>
  </div>
</div>

<div class="card hidden viewer" id="viewer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, doc, addDoc, getDocs, updateDoc, getDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const app = initializeApp({
  apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain:"students-login-29409.firebaseapp.com",
  projectId:"students-login-29409"
});

const db = getFirestore(app);
const auth = getAuth(app);
signInWithEmailAndPassword(auth,"ADMIN_EMAIL","ADMIN_PASSWORD").catch(e=>console.log(e));

onAuthStateChanged(auth, async user=>{
  if(!user){authStatus.innerText="Not Logged In";return;}
  authStatus.innerText="Admin Verified";
  addModuleCard.classList.remove("hidden");
  loadModules();
});

/* --- 1. QUILL CONFIGURATION --- */

// Custom Icons
const icons = Quill.import('ui/icons');
icons['html'] = '<i class="fa fa-code"></i>';
icons['pdf'] = '<i class="fa fa-file-pdf"></i>'; // PDF Icon

const quill = new Quill("#quill", {
  theme: "snow",
  modules: {
    toolbar: {
      container: [
        [{ header: [1, 2, 3, false] }],
        ["bold", "italic", "underline"],
        [{ list: "ordered" }, { list: "bullet" }],
        ["link", "image"],
        ["pdf"], // <--- PDF BUTTON
        ["html"] // <--- HTML CODE BUTTON
      ],
      handlers: {
        image: imageHandler,
        html: htmlHandler,
        pdf: pdfHandler
      }
    }
  }
});

// HTML Code View Textarea
const qContainer = document.querySelector("#quill-container");
const txtArea = document.createElement('textarea');
txtArea.className = 'ql-html-textarea';
qContainer.appendChild(txtArea);

/* --- 2. HANDLERS --- */

// PDF Handler: Uses EXACT iframe template requested + TTS Button
function pdfHandler() {
  const url = prompt("Paste your PDF Link:");
  if (!url) return;
  
  const desc = prompt("Enter a short description (This will be read by Text-to-Speech):") || "PDF Document";

  const range = quill.getSelection(true);
  
  // This HTML block includes the Text-to-Speech button AND your requested iframe
  const html = `
    <div class="pdf-container">
      <div class="pdf-tts-bar">
        <button class="tts-btn" onclick="speak('${desc}')">
          <i class="fa fa-volume-high"></i> Read Info
        </button>
        <small style="margin-left:auto; color:#666">PDF Preview</small>
      </div>
      <iframe src="${url}" width="100%" height="600px" allow="autoplay" title="${desc}"></iframe>
    </div>
    <p><br></p>
  `;

  quill.clipboard.dangerouslyPasteHTML(range.index, html);
}

// Global Text-to-Speech Function
window.speak = (text) => {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance("Document Info: " + text);
    window.speechSynthesis.speak(utterance);
  } else {
    alert("TTS not supported.");
  }
};

// HTML Toggle
function htmlHandler(){
  const editorArea = qContainer.querySelector('.ql-editor');
  if(txtArea.style.display === 'block'){
    quill.clipboard.dangerouslyPasteHTML(txtArea.value);
    txtArea.style.display = 'none';
    editorArea.style.display = 'block';
  } else {
    txtArea.value = quill.root.innerHTML;
    editorArea.style.display = 'none';
    txtArea.style.display = 'block';
  }
}

// Image Upload
function imageHandler(){
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.click();
  input.onchange = () => {
    const file = input.files[0];
    if(!file) return;
    toastText.innerText = "Uploading...";
    toast.classList.remove("hidden");
    const reader = new FileReader();
    reader.onload = () => {
      const range = quill.getSelection(true);
      quill.insertEmbed(range.index, "image", reader.result);
      toast.classList.add("hidden");
    };
    reader.readAsDataURL(file);
  };
}

/* --- 3. APP LOGIC --- */
let quizzes=[], editingId=null;

window.addQuiz = () => {
  const qVal = document.getElementById('q').value;
  if(!qVal) return alert("Enter question");
  const quiz = {
    question: qVal,
    options: [o1.value, o2.value, o3.value, o4.value],
    answer: a.value
  };
  quizzes.push(quiz);
  document.getElementById('q').value = o1.value = o2.value = o3.value = o4.value = a.value = "";
  renderQuizzes();
};

function renderQuizzes(){
  quizList.innerHTML = "";
  quizzes.forEach((x, i) => {
    quizList.innerHTML += `
      <div class="quiz-item">
        <b>${i+1}. ${x.question}</b>
        <button class="delete" style="width:auto; float:right; padding:5px 10px" onclick="deleteQuiz(${i})">Delete</button>
      </div>`;
  });
}
window.deleteQuiz = i => { quizzes.splice(i, 1); renderQuizzes(); };

window.saveModule = async status => {
  if(txtArea.style.display === 'block') quill.clipboard.dangerouslyPasteHTML(txtArea.value);
  
  toastText.innerText = "Saving...";
  toast.classList.remove("hidden");
  
  const refc = collection(db, "courses", "management_course", "modules");
  const data = {
    title: title.value, 
    videoUrl: videoUrl.value, 
    content: quill.root.innerHTML, 
    quizzes, 
    status, 
    updatedAt: serverTimestamp()
  };
  
  if(editingId) await updateDoc(doc(refc, editingId), data);
  else await addDoc(refc, data);
  
  toast.classList.add("hidden");
  openTab('publishedTab');
  loadModules();
};

async function loadModules(){
  publishedTab.innerHTML = draftTab.innerHTML = binTab.innerHTML = "";
  const snap = await getDocs(query(collection(db,"courses","management_course","modules"), orderBy("updatedAt","desc")));
  
  snap.forEach(d => {
    const m = d.data();
    if(m.status === 'deleted' && binTab.classList.contains('hidden')) return; // Simple filter

    const html = `
      <div class="quiz-item" style="background:#fff">
        <div style="display:flex; justify-content:space-between">
          <b>${m.title}</b>
          <small>${m.status}</small>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px">
          <button class="view" onclick="viewModule('${d.id}')">View</button>
          <button class="action-btn" onclick="edit('${d.id}')">Edit</button>
          <button class="delete" onclick="softDelete('${d.id}')">Delete</button>
        </div>
      </div>`;
      
    if(m.status === "published") publishedTab.innerHTML += html;
    else if(m.status === "draft") draftTab.innerHTML += html;
    else binTab.innerHTML += html;
  });
}

window.viewModule = async id => {
  history.pushState({page:"viewer"},"");
  const s = await getDoc(doc(db,"courses","management_course","modules",id));
  const m = s.data();
  viewer.innerHTML = `<h3>${m.title}</h3>${m.content}<button class="action-btn" onclick="history.back()">Back</button>`;
  toggleViews('viewer');
};

window.edit = async id => {
  history.pushState({page:"editor"},"");
  const s = await getDoc(doc(db,"courses","management_course","modules",id));
  const m = s.data();
  title.value = m.title;
  videoUrl.value = m.videoUrl;
  quill.root.innerHTML = m.content;
  quizzes = m.quizzes || [];
  editingId = id;
  renderQuizzes();
  toggleViews('editor');
};

window.softDelete = async id => {
  await updateDoc(doc(db,"courses","management_course","modules",id),{status:"deleted"});
  loadModules();
};

window.openEditor = () => {
  title.value = videoUrl.value = "";
  quill.root.innerHTML = "";
  quizzes = [];
  editingId = null;
  renderQuizzes();
  history.pushState({page:"editor"},"");
  toggleViews('editor');
};

window.showTab = (id, btn) => {
  openTab(id);
  document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
};

function openTab(id){
  ["publishedTab","draftTab","binTab"].forEach(t => document.getElementById(t).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

function toggleViews(viewId){
  addModuleCard.classList.add("hidden");
  document.querySelector('.tabs').classList.add("hidden");
  publishedTab.classList.add("hidden");
  draftTab.classList.add("hidden");
  binTab.classList.add("hidden");
  editor.classList.add("hidden");
  viewer.classList.add("hidden");
  document.getElementById(viewId).classList.remove("hidden");
}

window.onpopstate = () => {
  toggleViews('publishedTab');
  addModuleCard.classList.remove("hidden");
  document.querySelector('.tabs').classList.remove("hidden");
};

window.toggleTheme = () => document.body.classList.toggle("dark");
</script>
</body>
</html>
