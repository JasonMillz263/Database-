<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin – Management Course</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
:root{
--primary:#4f46e5;--success:#16a34a;--warning:#f59e0b;--danger:#dc2626;--bg:#f1f5f9;
}
body{font-family:Segoe UI;background:var(--bg);margin:0;padding:20px;}
header{background:var(--primary);color:#fff;padding:20px;border-radius:12px;margin-bottom:15px;}
.tabs{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:15px;}
.tabs button{padding:12px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;}
.tabs .active{background:var(--primary);color:#fff;}
section{display:none;} section.active{display:block;}
.card{background:#fff;border-radius:12px;padding:20px;margin-bottom:15px;}
input,button{width:100%;padding:10px;margin:6px 0;}
button{border:none;border-radius:6px;font-weight:bold;}
.publish{background:var(--success);color:#fff;}
.draft{background:var(--warning);}
.delete{background:var(--danger);color:#fff;}
.view{background:#0ea5e9;color:#fff;}
.quiz-item{background:#eef2ff;padding:8px;border-radius:6px;margin-bottom:5px;}
</style>
</head>

<body>

<header>
<h1><i class="fa fa-graduation-cap"></i> Admin – Management Course</h1>
</header>

<div class="tabs">
<button onclick="activate('editor')" class="active">Editor</button>
<button onclick="activate('published')">Published</button>
<button onclick="activate('drafts')">Drafts</button>
<button onclick="activate('recycle')">Recycle Bin</button>
<button onclick="activate('student')">Student View</button>
</div>

<!-- ================= EDITOR ================= -->
<section id="editor" class="active">
<div class="card">
<h2>Module Editor</h2>

<input id="title" placeholder="Module Title">
<input id="imageUrl" placeholder="Image URL">
<input id="videoUrl" placeholder="Video Embed URL">

<div id="quillEditor" style="height:200px"></div>

<h3>Quizzes</h3>
<input id="question" placeholder="Question">
<input id="opt1" placeholder="Option 1">
<input id="opt2" placeholder="Option 2">
<input id="opt3" placeholder="Option 3">
<input id="answer" placeholder="Correct Answer">

<button onclick="addQuiz()">Add Quiz</button>

<div id="quizList"></div>

<br>
<button class="draft" onclick="saveModule('draft')">Save Draft</button>
<button class="publish" onclick="saveModule('published')">Publish</button>
</div>
</section>

<section id="published"><div class="card"><h2>Published</h2><div id="publishedList"></div></div></section>
<section id="drafts"><div class="card"><h2>Drafts</h2><div id="draftList"></div></div></section>
<section id="recycle"><div class="card"><h2>Recycle Bin</h2><div id="recycleList"></div></div></section>

<section id="student">
<div class="card"><h2>Student View</h2><div id="studentModules"></div></div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, doc, addDoc, getDocs, updateDoc, deleteDoc, setDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain:"students-login-29409.firebaseapp.com",
  projectId:"students-login-29409"
});
const db = getFirestore(app);

const quill = new Quill('#quillEditor',{theme:'snow'});

let quizzes=[], editingId=null, editQuizIndex=null;

/* ---------- UI ---------- */
window.activate = id =>{
document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
document.getElementById(id).classList.add("active");
document.querySelector(`.tabs button[onclick="activate('${id}')"]`).classList.add("active");
};

/* ---------- QUIZ ---------- */
window.addQuiz = ()=>{
if(editQuizIndex!==null){
quizzes[editQuizIndex]={question:question.value,options:[opt1.value,opt2.value,opt3.value],answer:answer.value};
editQuizIndex=null;
}else{
quizzes.push({question:question.value,options:[opt1.value,opt2.value,opt3.value],answer:answer.value});
}
question.value=opt1.value=opt2.value=opt3.value=answer.value="";
renderQuizzes();
};

function renderQuizzes(){
quizList.innerHTML="";
quizzes.forEach((q,i)=>{
quizList.innerHTML+=`
<div class="quiz-item">
<strong>${i+1}. ${q.question}</strong>
<button onclick="editQuiz(${i})">Edit</button>
<button onclick="removeQuiz(${i})">Remove</button>
</div>`;
});
}

window.editQuiz=i=>{
const q=quizzes[i];
question.value=q.question; opt1.value=q.options[0]; opt2.value=q.options[1]; opt3.value=q.options[2]; answer.value=q.answer;
editQuizIndex=i;
};

window.removeQuiz=i=>{quizzes.splice(i,1);renderQuizzes();};

/* ---------- SAVE ---------- */
window.saveModule = async status =>{
const data={
title:title.value,imageUrl:imageUrl.value,videoUrl:videoUrl.value,
content:quill.root.innerHTML,quizzes,status,updatedAt:new Date()
};
const ref=collection(db,"courses","management_course","modules");
if(editingId){await updateDoc(doc(ref,editingId),data);}
else{data.order=(await getDocs(ref)).size;await addDoc(ref,data);}
reset(); refreshAll();
};

/* ---------- LOADERS ---------- */
async function refreshAll(){
loadList("published","publishedList");
loadList("draft","draftList");
loadStudent();
}

async function loadList(status,target){
const q=query(collection(db,"courses","management_course","modules"),where("status","==",status));
const snap=await getDocs(q);
document.getElementById(target).innerHTML="";
snap.forEach(d=>{
const m=d.data();
document.getElementById(target).innerHTML+=`
<div class="card">
<strong>${m.title}</strong><br>
<button onclick="editModule('${d.id}')">Edit</button>
${status==="published"?`<button class="view" onclick="viewStudent('${d.id}')">View</button>`:""}
<button class="delete" onclick="trash('${d.id}')">Delete</button>
</div>`;
});
}

window.viewStudent=id=>{activate("student");loadStudent(id);};

async function loadStudent(scrollId=null){
const q=query(collection(db,"courses","management_course","modules"),where("status","==","published"),orderBy("order"));
const snap=await getDocs(q);
studentModules.innerHTML="";
snap.forEach(d=>{
const m=d.data();
studentModules.innerHTML+=`
<div class="card" id="s-${d.id}">
<h3>${m.title}</h3>
${m.imageUrl?`<img src="${m.imageUrl}" style="width:100%">`:""}
${m.videoUrl?`<iframe src="${m.videoUrl}" style="width:100%;height:300px"></iframe>`:""}
${m.content}
</div>`;
});
if(scrollId) document.getElementById("s-"+scrollId)?.scrollIntoView({behavior:"smooth"});
}

window.editModule=async id=>{
const snap=await getDocs(collection(db,"courses","management_course","modules"));
snap.forEach(d=>{
if(d.id===id){
const m=d.data();
title.value=m.title; imageUrl.value=m.imageUrl; videoUrl.value=m.videoUrl;
quill.root.innerHTML=m.content; quizzes=m.quizzes||[]; editingId=id; renderQuizzes();
activate("editor");
}});
};

window.trash=async id=>{
const snap=await getDocs(collection(db,"courses","management_course","modules"));
snap.forEach(async d=>{
if(d.id===id){
await setDoc(doc(db,"recycleBin",id),d.data());
await deleteDoc(doc(db,"courses","management_course","modules",id));
refreshAll();
}});
};

function reset(){
title.value=imageUrl.value=videoUrl.value="";
quill.root.innerHTML=""; quizzes=[]; editingId=null; renderQuizzes();
}

refreshAll();
</script>

</body>
</html>
