<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin – Management Course</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
/* ===== BASE ===== */
body{
  font-family:Segoe UI;
  background:#f1f5f9;
  padding:12px;
  margin:0;
  transition:.3s;
}
body.dark{
  background:#0f172a;
  color:#e5e7eb;
}
header{
  background:#4f46e5;
  color:#fff;
  padding:16px;
  border-radius:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.card{
  background:#fff;
  padding:16px;
  border-radius:12px;
  margin-top:12px;
  animation:fadeSlide .25s ease;
}
body.dark .card{background:#020617}

@keyframes fadeSlide{
  from{opacity:0;transform:translateY(8px)}
  to{opacity:1;transform:none}
}

input,button{
  width:100%;
  padding:10px;
  margin:6px 0;
}
button{
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
}
.publish{background:#16a34a;color:#fff}
.draft{background:#f59e0b}
.delete{background:#dc2626;color:#fff}
.view{background:#0ea5e9;color:#fff}
.quiz{background:#eef2ff;padding:8px;border-radius:6px;margin:5px 0}
.hidden{display:none}

/* ===== TABS ===== */
.tabs{
  display:flex;
  gap:8px;
  margin-top:12px;
}
.tabs button{
  flex:1;
  background:#e5e7eb;
}
.tabs button.active{
  background:#4f46e5;
  color:#fff;
}

/* ===== STATUS OVERLAY ===== */
#statusOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999;
}
#statusOverlay.hidden{display:none}
.statusBox{
  background:#fff;
  padding:24px;
  border-radius:12px;
  text-align:center;
}
body.dark .statusBox{background:#020617}

/* ===== MOBILE ===== */
@media(max-width:768px){
  .tabs{flex-direction:column}
}
</style>
</head>

<body>

<header>
  <h2><i class="fa fa-user-shield"></i> Admin – Management Course</h2>
  <div>
    <button onclick="toggleTheme()"><i class="fa fa-moon"></i></button>
    <span id="authStatus"></span>
  </div>
</header>

<div class="card hidden" id="editor">
  <h3>Module Editor</h3>

  <input id="title" placeholder="Module title">
  <input id="imageUrl" placeholder="Image URL">
  <input type="file" id="imageFile" accept="image/*">
  <div id="uploadProgress" class="hidden"></div>
  <input id="videoUrl" placeholder="Video URL">

  <div id="quill" style="height:200px"></div>

  <h4>Quizzes</h4>
  <input id="q" placeholder="Question">
  <input id="o1" placeholder="Option 1">
  <input id="o2" placeholder="Option 2">
  <input id="o3" placeholder="Option 3">
  <input id="o4" placeholder="Option 4">
  <input id="a" placeholder="Correct answer">

  <button onclick="addQuiz()">Add / Update Quiz</button>
  <div id="quizList"></div>

  <button class="draft" onclick="saveModule('draft')">Save Draft</button>
  <button class="publish" onclick="saveModule('published')">Publish</button>
</div>

<div class="tabs">
  <button class="active" onclick="showTab('publishedTab')">Published</button>
  <button onclick="showTab('draftTab')">Drafts</button>
  <button onclick="showTab('binTab')">Recycle Bin</button>
</div>

<div class="card" id="publishedTab"></div>
<div class="card hidden" id="draftTab"></div>
<div class="card hidden" id="binTab"></div>

<div class="card hidden" id="viewer"></div>

<div id="statusOverlay" class="hidden">
  <div class="statusBox">
    <i id="statusIcon" class="fa fa-spinner fa-spin"></i>
    <p id="statusText"></p>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, doc, addDoc, getDocs,
  updateDoc, getDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import {
  getAuth, signInWithEmailAndPassword, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getStorage, ref, uploadBytesResumable, getDownloadURL
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

/* ===== FIREBASE ===== */
const app = initializeApp({
  apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain: "students-login-29409.firebaseapp.com",
  projectId: "students-login-29409"
});
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

signInWithEmailAndPassword(auth,"ADMIN_EMAIL","ADMIN_PASSWORD");

/* ===== AUTH ===== */
let editingId=null, quizzes=[], editingQuiz=null;

onAuthStateChanged(auth, async user=>{
  if(!user) return authStatus.innerText="❌ Not logged in";
  authStatus.innerText="✅ Admin authenticated";
  editor.classList.remove("hidden");
  loadModules();
});

/* ===== QUILL ===== */
const quill=new Quill("#quill",{theme:"snow"});

/* ===== STATUS ===== */
function showStatus(t,i="spinner"){
  statusText.innerText=t;
  statusIcon.className=i==="success"?"fa fa-check-circle":"fa fa-spinner fa-spin";
  statusOverlay.classList.remove("hidden");
}
function hideStatus(){statusOverlay.classList.add("hidden");}

/* ===== IMAGE UPLOAD ===== */
imageFile.onchange=()=>{
  const f=imageFile.files[0];
  const r=ref(storage,"modules/"+Date.now()+f.name);
  const t=uploadBytesResumable(r,f);
  uploadProgress.classList.remove("hidden");

  t.on("state_changed",s=>{
    uploadProgress.innerText=`Uploading ${Math.round((s.bytesTransferred/s.totalBytes)*100)}%`;
  },null,async()=>{
    imageUrl.value=await getDownloadURL(t.snapshot.ref);
    uploadProgress.innerText="Upload complete ✅";
  });
};

/* ===== QUIZZES ===== */
window.addQuiz=()=>{
  const quiz={question:q.value,options:[o1.value,o2.value,o3.value,o4.value],answer:a.value};
  editingQuiz!==null?quizzes[editingQuiz]=quiz:quizzes.push(quiz);
  editingQuiz=null;
  q.value=o1.value=o2.value=o3.value=o4.value=a.value="";
  renderQuizzes();
};

function renderQuizzes(){
  quizList.innerHTML="";
  quizzes.forEach((x,i)=>{
    quizList.innerHTML+=`
      <div class="quiz">${x.question}
        <button onclick="editQuiz(${i})">Edit</button>
        <button class="delete" onclick="deleteQuiz(${i})">Delete</button>
      </div>`;
  });
}
window.editQuiz=i=>{
  const x=quizzes[i];
  q.value=x.question;o1.value=x.options[0];o2.value=x.options[1];
  o3.value=x.options[2];o4.value=x.options[3];a.value=x.answer;
  editingQuiz=i;
};
window.deleteQuiz=i=>{quizzes.splice(i,1);renderQuizzes();};

/* ===== SAVE MODULE ===== */
window.saveModule=async status=>{
  showStatus(status==="published"?"Publishing...":"Saving draft...");
  const refCol=collection(db,"courses","management_course","modules");
  const data={
    title:title.value,
    imageUrl:imageUrl.value,
    videoUrl:videoUrl.value,
    content:quill.root.innerHTML,
    quizzes,
    status,
    updatedAt:serverTimestamp()
  };
  editingId?await updateDoc(doc(refCol,editingId),data):await addDoc(refCol,{...data,createdAt:serverTimestamp()});
  hideStatus();reset();loadModules();
};

/* ===== LOAD MODULES ===== */
async function loadModules(){
  publishedTab.innerHTML=draftTab.innerHTML=binTab.innerHTML="";
  const snap=await getDocs(collection(db,"courses","management_course","modules"));
  const arr=[];
  snap.forEach(d=>arr.push({id:d.id,...d.data()}));
  arr.sort((a,b)=>b.updatedAt?.seconds-a.updatedAt?.seconds);

  arr.forEach(m=>{
    const box=`
    <div class="quiz">
      <b>${m.title}</b>
      <button onclick="edit('${m.id}')">Edit</button>
      <button class="view" onclick="viewModule('${m.id}')">View</button>
      <button class="delete" onclick="softDelete('${m.id}')">Delete</button>
    </div>`;
    if(m.status==="published")publishedTab.innerHTML+=box;
    else if(m.status==="draft")draftTab.innerHTML+=box;
    else binTab.innerHTML+=box;
  });
}

/* ===== VIEW ===== */
window.viewModule=async id=>{
  const s=await getDoc(doc(db,"courses","management_course","modules",id));
  const m=s.data();
  viewer.innerHTML=`<h2>${m.title}</h2><img src="${m.imageUrl}" style="max-width:100%"><div>${m.content}</div>`;
  viewer.classList.remove("hidden");
  viewer.scrollIntoView({behavior:"smooth"});
};

/* ===== DELETE ===== */
window.softDelete=async id=>{
  showStatus("Deleting...");
  await updateDoc(doc(db,"courses","management_course","modules",id),{status:"deleted"});
  hideStatus();loadModules();
};

/* ===== EDIT ===== */
window.edit=async id=>{
  const s=await getDoc(doc(db,"courses","management_course","modules",id));
  const m=s.data();
  title.value=m.title;imageUrl.value=m.imageUrl;videoUrl.value=m.videoUrl;
  quill.root.innerHTML=m.content;quizzes=m.quizzes||[];editingId=id;
  renderQuizzes();editor.scrollIntoView({behavior:"smooth"});
};

/* ===== RESET ===== */
function reset(){title.value=imageUrl.value=videoUrl.value="";quill.root.innerHTML="";quizzes=[];editingId=null;renderQuizzes();}

/* ===== TABS ===== */
window.showTab=id=>{
  ["publishedTab","draftTab","binTab"].forEach(t=>document.getElementById(t).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");
  document.getElementById(id).scrollIntoView({behavior:"smooth"});
};

/* ===== AUTO SAVE ===== */
setInterval(()=>{
  if(title.value||quill.getText().trim()) saveModule("draft");
},15000);

/* ===== THEME ===== */
window.toggleTheme=()=>{
  document.body.classList.toggle("dark");
  localStorage.theme=document.body.classList.contains("dark")?"dark":"light";
};
if(localStorage.theme==="dark")document.body.classList.add("dark");

</script>
</body>
</html>
