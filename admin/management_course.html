<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin – Management Course</title>

<!-- Icons & Editor -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
:root {
  --primary:#4f46e5;
  --secondary:#0ea5e9;
  --success:#16a34a;
  --warning:#f59e0b;
  --danger:#dc2626;
  --bg:#f1f5f9;
}

body {
  font-family:Segoe UI, sans-serif;
  background:var(--bg);
  margin:0;
  padding:20px;
}

header {
  background:var(--primary);
  color:white;
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
}

.tabs {
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:10px;
  margin-bottom:20px;
}

.tabs button {
  padding:12px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
  background:white;
}

.tabs .active {
  background:var(--primary);
  color:white;
}

section { display:none; }
section.active { display:block; }

.card {
  background:white;
  border-radius:12px;
  padding:20px;
  margin-bottom:15px;
}

input, button {
  width:100%;
  padding:10px;
  margin:6px 0;
}

button {
  border:none;
  border-radius:6px;
  font-weight:bold;
}

.publish { background:var(--success); color:white; }
.draft { background:var(--warning); }
.delete { background:var(--danger); color:white; }
.restore { background:var(--secondary); color:white; }

.badge {
  padding:4px 10px;
  border-radius:20px;
  font-size:12px;
  color:white;
}

.published { background:var(--success); }
.draft-badge { background:var(--warning); }

.module-card {
  border-left:6px solid var(--secondary);
}

.student-module img,
.student-module iframe {
  width:100%;
  border-radius:8px;
  margin:10px 0;
}

#editor { height:200px; background:white; }
</style>
</head>

<body>

<header>
  <h1><i class="fa-solid fa-graduation-cap"></i> Admin – Management Course</h1>
</header>

<div class="tabs">
  <button class="active" onclick="showTab('editor')"><i class="fa fa-pen"></i> Editor</button>
  <button onclick="showTab('published')"><i class="fa fa-check"></i> Published</button>
  <button onclick="showTab('drafts')"><i class="fa fa-file"></i> Drafts</button>
  <button onclick="showTab('recycle')"><i class="fa fa-trash"></i> Recycle Bin</button>
  <button onclick="showTab('student')"><i class="fa fa-eye"></i> Student View</button>
</div>

<!-- ================= EDITOR ================= -->
<section id="editor" class="active">
<div class="card">
  <h2>Module Editor</h2>
  <input id="title" placeholder="Module Title">
  <input id="imageUrl" placeholder="Image URL">
  <input id="videoUrl" placeholder="Video URL (Embed)">
  <div id="editorBox"></div>

  <h3>Quiz</h3>
  <input id="question" placeholder="Question">
  <input id="opt1" placeholder="Option 1">
  <input id="opt2" placeholder="Option 2">
  <input id="opt3" placeholder="Option 3">
  <input id="answer" placeholder="Correct Answer">

  <button onclick="addQuiz()">Add Quiz</button>
  <br><br>
  <button class="draft" onclick="saveModule('draft')">Save Draft</button>
  <button class="publish" onclick="saveModule('published')">Publish</button>
</div>
</section>

<!-- ================= PUBLISHED ================= -->
<section id="published">
<div class="card">
  <h2>Published Modules</h2>
  <div id="publishedList"></div>
</div>
</section>

<!-- ================= DRAFTS ================= -->
<section id="drafts">
<div class="card">
  <h2>Draft Modules</h2>
  <div id="draftList"></div>
</div>
</section>

<!-- ================= RECYCLE BIN ================= -->
<section id="recycle">
<div class="card">
  <h2>Recycle Bin</h2>
  <div id="recycleList"></div>
</div>
</section>

<!-- ================= STUDENT ================= -->
<section id="student">
<div class="card">
  <h2>Student Course View</h2>
  <div id="studentModules"></div>
</div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, doc, addDoc, getDocs, updateDoc,
  deleteDoc, setDoc, query, where, orderBy
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain: "students-login-29409.firebaseapp.com",
  projectId: "students-login-29409"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const quill = new Quill('#editorBox', { theme: 'snow' });

let quizzes = [], editingId = null;

window.showTab = tab => {
  document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
  document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
  document.getElementById(tab).classList.add("active");
  event.target.classList.add("active");
};

window.addQuiz = () => {
  quizzes.push({
    question: question.value,
    options: [opt1.value, opt2.value, opt3.value],
    answer: answer.value
  });
  question.value = opt1.value = opt2.value = opt3.value = answer.value = "";
};

window.saveModule = async status => {
  const data = {
    title: title.value,
    imageUrl: imageUrl.value,
    videoUrl: videoUrl.value,
    content: quill.root.innerHTML,
    quizzes,
    status,
    updatedAt: new Date()
  };

  const ref = collection(db, "courses", "management_course", "modules");

  if (editingId) {
    await updateDoc(doc(ref, editingId), data);
  } else {
    const snap = await getDocs(ref);
    data.order = snap.size;
    await addDoc(ref, data);
  }

  reset();
  loadAll();
};

async function loadAll() {
  loadPublished();
  loadDrafts();
  loadRecycle();
  loadStudent();
}

async function loadPublished() {
  const q = query(collection(db,"courses","management_course","modules"), where("status","==","published"));
  const snap = await getDocs(q);
  publishedList.innerHTML = "";
  snap.forEach(d => renderModule(d, publishedList));
}

async function loadDrafts() {
  const q = query(collection(db,"courses","management_course","modules"), where("status","==","draft"));
  const snap = await getDocs(q);
  draftList.innerHTML = "";
  snap.forEach(d => renderModule(d, draftList));
}

async function loadRecycle() {
  const snap = await getDocs(collection(db,"recycleBin"));
  recycleList.innerHTML = "";
  snap.forEach(d => {
    const m = d.data();
    recycleList.innerHTML += `
      <div class="card module-card">
        <strong>${m.title}</strong><br><br>
        <button class="restore" onclick="restore('${d.id}')">Restore</button>
        <button class="delete" onclick="permanentDelete('${d.id}')">Delete Forever</button>
      </div>`;
  });
}

function renderModule(d, target) {
  const m = d.data();
  target.innerHTML += `
    <div class="card module-card">
      <strong>${m.title}</strong>
      <span class="badge ${m.status==='published'?'published':'draft-badge'}">${m.status}</span><br><br>
      <button onclick="edit('${d.id}')">Edit</button>
      <button class="delete" onclick="trash('${d.id}')">Delete</button>
    </div>`;
}

window.trash = async id => {
  const ref = doc(db,"courses","management_course","modules",id);
  const snap = await getDocs(collection(db,"courses","management_course","modules"));
  snap.forEach(async d=>{
    if(d.id===id){
      await setDoc(doc(db,"recycleBin",id),d.data());
      await deleteDoc(ref);
      loadAll();
    }
  });
};

window.restore = async id => {
  const snap = await getDocs(collection(db,"recycleBin"));
  snap.forEach(async d=>{
    if(d.id===id){
      await setDoc(doc(db,"courses","management_course","modules",id),d.data());
      await deleteDoc(doc(db,"recycleBin",id));
      loadAll();
    }
  });
};

window.permanentDelete = async id => {
  await deleteDoc(doc(db,"recycleBin",id));
  loadRecycle();
};

async function loadStudent() {
  const q = query(
    collection(db,"courses","management_course","modules"),
    where("status","==","published"),
    orderBy("order")
  );
  const snap = await getDocs(q);
  studentModules.innerHTML="";
  snap.forEach(d=>{
    const m=d.data();
    studentModules.innerHTML+=`
      <div class="card student-module">
        <h3>${m.title}</h3>
        ${m.imageUrl?`<img src="${m.imageUrl}">`:""}
        ${m.videoUrl?`<iframe src="${m.videoUrl}"></iframe>`:""}
        ${m.content}
      </div>`;
  });
}

function reset(){
  title.value=imageUrl.value=videoUrl.value="";
  quill.root.innerHTML="";
  quizzes=[];
  editingId=null;
}

loadAll();
</script>

</body>
  </html>
