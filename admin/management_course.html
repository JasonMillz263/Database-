<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin â€“ Management Course</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
/* ===== BASE ===== */
body{
  font-family:Segoe UI;
  background:#f1f5f9;
  padding:12px;
  margin:0;
}
body.dark{
  background:#0f172a;
  color:#f8fafc;
}
header{
  background:#4f46e5;
  color:#fff;
  padding:16px;
  border-radius:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.card{
  background:#fff;
  padding:16px;
  border-radius:12px;
  margin-top:12px;
}
body.dark .card{background:#1e293b}
input,button{
  width:100%;
  padding:10px;
  margin:6px 0;
}
button{
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
  transition:.15s;
}
button:active{transform:scale(.97)}
.publish{background:#16a34a;color:#fff}
.draft{background:#f59e0b}
.delete{background:#dc2626;color:#fff}
.view{background:#0ea5e9;color:#fff}
.quiz{background:#eef2ff;padding:8px;border-radius:6px;margin:5px 0}
.hidden{display:none}

/* ===== TABS ===== */
.tabs{
  display:flex;
  gap:8px;
  margin-top:12px;
}
.tabs button{
  flex:1;
  background:#e5e7eb;
}
.tabs button.active{
  background:#4f46e5;
  color:#fff;
}

/* ===== STATUS TOAST ===== */
#actionToast{
  position:fixed;
  bottom:20px;
  right:20px;
  background:#111827;
  color:#fff;
  padding:12px 16px;
  border-radius:10px;
  display:flex;
  gap:10px;
  align-items:center;
  z-index:9999;
}
#actionToast.hidden{display:none}

/* ===== MOBILE ===== */
@media(max-width:768px){
  header h2{font-size:18px}
  .tabs{flex-direction:column}
  .card{padding:12px}
}
</style>
</head>

<body>

<header>
  <h2><i class="fa fa-user-shield"></i> Admin â€“ Management Course</h2>
  <button onclick="toggleTheme()">ðŸŒ™</button>
</header>

<div id="actionToast" class="hidden">
  <i class="fa fa-spinner fa-spin"></i>
  <span id="actionText"></span>
</div>

<div class="card hidden" id="editor">
  <h3>Module Editor</h3>

  <input id="title" placeholder="Module title">
  <input id="imageUrl" placeholder="Image URL">
  <input id="videoUrl" placeholder="Video URL">

  <div id="quill" style="height:200px"></div>

  <h4>Quizzes</h4>
  <input id="q" placeholder="Question">
  <input id="o1" placeholder="Option 1">
  <input id="o2" placeholder="Option 2">
  <input id="o3" placeholder="Option 3">
  <input id="o4" placeholder="Option 4">
  <input id="a" placeholder="Correct answer">
  <button onclick="addQuiz()">Add / Update Quiz</button>

  <div id="quizList"></div>

  <button class="draft" onclick="saveModule('draft')">Save Draft</button>
  <button class="publish" onclick="saveModule('published')">Publish</button>
</div>

<div class="tabs">
  <button class="active" onclick="showTab('publishedTab')">Published</button>
  <button onclick="showTab('draftTab')">Drafts</button>
  <button onclick="showTab('binTab')">Recycle Bin</button>
</div>

<div class="card" id="publishedTab"></div>
<div class="card hidden" id="draftTab"></div>
<div class="card hidden" id="binTab"></div>

<div class="card hidden" id="viewer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, doc, addDoc, getDocs,
  updateDoc, getDoc, serverTimestamp, query, orderBy
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import {
  getAuth, signInWithEmailAndPassword, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getStorage, ref, uploadBytesResumable, getDownloadURL
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

/* ===== FIREBASE ===== */
const app = initializeApp({
  apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain: "students-login-29409.firebaseapp.com",
  projectId: "students-login-29409",
  storageBucket: "students-login-29409.appspot.com"
});
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

signInWithEmailAndPassword(auth,"ADMIN_EMAIL","ADMIN_PASSWORD");

/* ===== STATE ===== */
let quizzes=[];
let editingQuiz=null;
let editingId=null;

/* ===== TOAST ===== */
function showAction(t){
  actionText.innerText=t;
  actionToast.classList.remove("hidden");
}
function hideAction(){
  setTimeout(()=>actionToast.classList.add("hidden"),1200);
}

/* ===== THEME ===== */
window.toggleTheme=()=>{
  document.body.classList.toggle("dark");
  localStorage.theme=document.body.classList.contains("dark");
};
if(localStorage.theme==="true")document.body.classList.add("dark");

/* ===== QUILL + IMAGE UPLOAD % ===== */
const quill=new Quill("#quill",{
  theme:"snow",
  modules:{
    toolbar:{
      container:[
        ["bold","italic","underline"],
        ["image","link"],
        [{list:"ordered"},{list:"bullet"}]
      ],
      handlers:{
        image:()=>{
          const input=document.createElement("input");
          input.type="file";
          input.accept="image/*";
          input.click();
          input.onchange=()=>{
            const file=input.files[0];
            const task=uploadBytesResumable(
              ref(storage,"modules/"+Date.now()+"_"+file.name),
              file
            );
            showAction("Uploading image 0%");
            task.on("state_changed",s=>{
              actionText.innerText=
                "Uploading image "+
                Math.round(s.bytesTransferred/s.totalBytes*100)+"%";
            },null,async()=>{
              const url=await getDownloadURL(task.snapshot.ref);
              const r=quill.getSelection();
              quill.insertEmbed(r.index,"image",url);
              hideAction();
            });
          };
        }
      }
    }
  }
});

/* ===== AUTODRAFT ===== */
setInterval(()=>{
  localStorage.autoDraft=JSON.stringify({
    title:title.value,
    imageUrl:imageUrl.value,
    videoUrl:videoUrl.value,
    content:quill.root.innerHTML,
    quizzes
  });
},10000);

window.addEventListener("offline",()=>{
  showAction("Offline â€“ draft auto saved");
  hideAction();
});

if(localStorage.autoDraft){
  const d=JSON.parse(localStorage.autoDraft);
  title.value=d.title||"";
  imageUrl.value=d.imageUrl||"";
  videoUrl.value=d.videoUrl||"";
  quill.root.innerHTML=d.content||"";
  quizzes=d.quizzes||[];
  renderQuizzes();
}

/* ===== QUIZZES ===== */
window.addQuiz=()=>{
  const quiz={
    question:q.value,
    options:[o1.value,o2.value,o3.value,o4.value],
    answer:a.value
  };
  editingQuiz!==null
    ? quizzes[editingQuiz]=quiz
    : quizzes.push(quiz);
  editingQuiz=null;
  q.value=o1.value=o2.value=o3.value=o4.value=a.value="";
  renderQuizzes();
};
function renderQuizzes(){
  quizList.innerHTML="";
  quizzes.forEach((x,i)=>{
    quizList.innerHTML+=`
      <div class="quiz">
        ${i+1}. ${x.question}
        <button onclick="editQuiz(${i})">Edit</button>
        <button class="delete" onclick="deleteQuiz(${i})">Delete</button>
      </div>`;
  });
}
window.editQuiz=i=>{
  const x=quizzes[i];
  q.value=x.question;
  o1.value=x.options[0];
  o2.value=x.options[1];
  o3.value=x.options[2];
  o4.value=x.options[3];
  a.value=x.answer;
  editingQuiz=i;
};
window.deleteQuiz=i=>{
  quizzes.splice(i,1);
  renderQuizzes();
};

/* ===== SAVE MODULE ===== */
window.saveModule=async status=>{
  showAction(status==="published"?"Publishing...":"Saving draft...");
  const refCol=collection(db,"courses","management_course","modules");
  const data={
    title:title.value,
    imageUrl:imageUrl.value,
    videoUrl:videoUrl.value,
    content:quill.root.innerHTML,
    quizzes:quizzes||[],
    status,
    updatedAt:serverTimestamp()
  };
  editingId
    ? await updateDoc(doc(refCol,editingId),data)
    : await addDoc(refCol,data);
  localStorage.removeItem("autoDraft");
  reset();
  loadModules();
  hideAction();
};

/* ===== LOAD MODULES ===== */
async function loadModules(){
  publishedTab.innerHTML=draftTab.innerHTML=binTab.innerHTML="";
  const snap=await getDocs(
    query(
      collection(db,"courses","management_course","modules"),
      orderBy("updatedAt","desc")
    )
  );
  snap.forEach(d=>{
    const m=d.data();
    const box=`
      <div class="quiz">
        <b>${m.title}</b><br>
        <button class="view" onclick="viewModule('${d.id}')">View</button>
        <button onclick="edit('${d.id}')">Edit</button>
        <button class="delete" onclick="softDelete('${d.id}')">Delete</button>
      </div>`;
    if(m.status==="published")publishedTab.innerHTML+=box;
    else if(m.status==="draft")draftTab.innerHTML+=box;
    else if(m.status==="deleted")binTab.innerHTML+=box;
  });
}
loadModules();

/* ===== VIEW ===== */
window.viewModule=async id=>{
  const s=await getDoc(doc(db,"courses","management_course","modules",id));
  const m=s.data();
  viewer.innerHTML=`
    <h3>${m.title}</h3>
    ${m.imageUrl?`<img src="${m.imageUrl}" width="100%">`:""}
    ${m.videoUrl?`<iframe src="${m.videoUrl}" width="100%" height="240"></iframe>`:""}
    <div>${m.content}</div>
    <button onclick="viewer.classList.add('hidden')">Back</button>
  `;
  viewer.classList.remove("hidden");
};

/* ===== EDIT / DELETE ===== */
window.edit=async id=>{
  const s=await getDoc(doc(db,"courses","management_course","modules",id));
  const m=s.data();
  title.value=m.title;
  imageUrl.value=m.imageUrl;
  videoUrl.value=m.videoUrl;
  quill.root.innerHTML=m.content;
  quizzes=m.quizzes||[];
  editingId=id;
  renderQuizzes();
};
window.softDelete=async id=>{
  showAction("Moving to recycle bin...");
  await updateDoc(
    doc(db,"courses","management_course","modules",id),
    {status:"deleted"}
  );
  hideAction();
  loadModules();
};

/* ===== RESET ===== */
function reset(){
  title.value=imageUrl.value=videoUrl.value="";
  quill.root.innerHTML="";
  quizzes=[];
  editingId=null;
  renderQuizzes();
}

/* ===== TABS ===== */
window.showTab=id=>{
  ["publishedTab","draftTab","binTab"].forEach(t=>{
    document.getElementById(t).classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");
  document.querySelectorAll(".tabs button")
    .forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");
};
</script>

</body>
</html>
