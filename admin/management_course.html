<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin â€“ Management Course</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
body{
  font-family:Segoe UI;
  background:#f1f5f9;
  padding:12px;
  margin:0;
}
header{
  background:#4f46e5;
  color:#fff;
  padding:16px;
  border-radius:12px;
}
.card{
  background:#fff;
  padding:16px;
  border-radius:12px;
  margin-top:12px;
}
input,button{
  width:100%;
  padding:10px;
  margin:6px 0;
}
button{
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
}
.publish{background:#16a34a;color:#fff}
.draft{background:#f59e0b}
.delete{background:#dc2626;color:#fff}
.quiz{background:#eef2ff;padding:8px;border-radius:6px;margin:5px 0}
.hidden{display:none}

/* IMAGE UPLOAD NOTIFICATION */
#imgStatus{
  margin-top:6px;
  font-size:13px;
  color:#0f172a;
}

.tabs{
  display:flex;
  gap:8px;
  margin-top:12px;
}
.tabs button{
  flex:1;
  background:#e5e7eb;
}
.tabs button.active{
  background:#4f46e5;
  color:#fff;
}
</style>
</head>

<body>

<header>
  <h2><i class="fa fa-user-shield"></i> Admin â€“ Management Course</h2>
  <div id="authStatus">Checking authentication...</div>
</header>

<div class="card hidden" id="editor">
  <h3>Module Editor</h3>

  <input id="title" placeholder="Module title">
  <input id="imageUrl" placeholder="Cover image URL (optional)">
  <input id="videoUrl" placeholder="Video URL">

  <div id="quill" style="height:220px"></div>
  <div id="imgStatus"></div>

  <h4>Quizzes</h4>
  <input id="q" placeholder="Question">
  <input id="o1" placeholder="Option 1">
  <input id="o2" placeholder="Option 2">
  <input id="o3" placeholder="Option 3">
  <input id="o4" placeholder="Option 4">
  <input id="a" placeholder="Correct answer">

  <button onclick="addQuiz()">Add / Update Quiz</button>
  <div id="quizList"></div>

  <button class="draft" onclick="saveModule('draft')">Save Draft</button>
  <button class="publish" onclick="saveModule('published')">Publish</button>
</div>

<div class="tabs">
  <button class="active" onclick="showTab('publishedTab',this)">Published</button>
  <button onclick="showTab('draftTab',this)">Drafts</button>
  <button onclick="showTab('binTab',this)">Recycle Bin</button>
</div>

<div class="card" id="publishedTab"></div>
<div class="card hidden" id="draftTab"></div>
<div class="card hidden" id="binTab"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, doc, addDoc, getDocs,
  updateDoc, getDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import {
  getAuth, signInWithEmailAndPassword, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

/* ===== FIREBASE ===== */
const app = initializeApp({
  apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain: "students-login-29409.firebaseapp.com",
  projectId: "students-login-29409"
});

const db = getFirestore(app);
const auth = getAuth(app);
signInWithEmailAndPassword(auth,"ADMIN_EMAIL","ADMIN_PASSWORD");

/* ===== AUTH ===== */
onAuthStateChanged(auth, async user=>{
  if(!user) return authStatus.innerText="âŒ Not logged in";
  const adminDoc=await getDoc(doc(db,"admins",user.uid));
  if(!adminDoc.exists()) return authStatus.innerText="âŒ Not admin";
  authStatus.innerText="âœ… Admin authenticated";
  editor.classList.remove("hidden");
  loadModules();
});

/* ===== QUILL WITH BASE64 UPLOAD NOTIFICATIONS ===== */
const quill = new Quill("#quill",{
  theme:"snow",
  modules:{
    toolbar:{
      container:[
        ["bold","italic","underline"],
        ["image","link"],
        [{ list:"ordered" },{ list:"bullet" }]
      ],
      handlers:{
        image: imageHandler
      }
    }
  }
});

function imageHandler(){
  const input=document.createElement("input");
  input.type="file";
  input.accept="image/*";
  input.click();

  input.onchange=()=>{
    const file=input.files[0];
    if(!file) return;

    imgStatus.innerText="ðŸ“¤ Uploading image... 0%";

    const reader=new FileReader();

    reader.onprogress=e=>{
      if(e.lengthComputable){
        const percent=Math.round((e.loaded/e.total)*100);
        imgStatus.innerText=`ðŸ“¤ Uploading image... ${percent}%`;
      }
    };

    reader.onload=()=>{
      const range=quill.getSelection(true);
      quill.insertEmbed(range.index,"image",reader.result);
      quill.setSelection(range.index+1);
      imgStatus.innerText="âœ… Image uploaded";
      setTimeout(()=>imgStatus.innerText="",2000);
    };

    reader.readAsDataURL(file);
  };
}

/* ===== QUIZZES / SAVE / LOAD (UNCHANGED) ===== */
let quizzes=[],editingId=null;
window.addQuiz=()=>{ quizzes.push({question:q.value,options:[o1.value,o2.value,o3.value,o4.value],answer:a.value}); q.value=o1.value=o2.value=o3.value=o4.value=a.value=""; renderQuizzes(); };
function renderQuizzes(){ quizList.innerHTML=""; quizzes.forEach((x,i)=>quizList.innerHTML+=`<div class="quiz">${x.question}<button onclick="deleteQuiz(${i})">Delete</button></div>`);}
window.deleteQuiz=i=>{quizzes.splice(i,1);renderQuizzes();};

window.saveModule=async status=>{
  const ref=collection(db,"courses","management_course","modules");
  const data={title:title.value,imageUrl:imageUrl.value,videoUrl:videoUrl.value,content:quill.root.innerHTML,quizzes,status,updatedAt:serverTimestamp()};
  editingId?await updateDoc(doc(ref,editingId),data):await addDoc(ref,data);
  reset();loadModules();
};

async function loadModules(){ publishedTab.innerHTML=""; const snap=await getDocs(collection(db,"courses","management_course","modules")); snap.forEach(d=>publishedTab.innerHTML+=`<div class="quiz"><b>${d.data().title}</b></div>`);}
function reset(){title.value=imageUrl.value=videoUrl.value="";quill.root.innerHTML="";quizzes=[];renderQuizzes();}

window.showTab=(id,btn)=>{["publishedTab","draftTab","binTab"].forEach(t=>document.getElementById(t).classList.add("hidden"));document.getElementById(id).classList.remove("hidden");document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));btn.classList.add("active");};
</script>

</body>
</html>
