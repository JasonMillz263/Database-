<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin ‚Äì Management Course</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
body{font-family:Segoe UI;background:#f1f5f9;padding:20px}
header{background:#4f46e5;color:#fff;padding:20px;border-radius:12px}
.card{background:#fff;padding:20px;border-radius:12px;margin-top:15px}
input,button{width:100%;padding:10px;margin:6px 0}
button{border:none;border-radius:6px;font-weight:bold}
.publish{background:#16a34a;color:#fff}
.draft{background:#f59e0b}
.delete{background:#dc2626;color:#fff}
.view{background:#0ea5e9;color:#fff}
.quiz{background:#eef2ff;padding:8px;border-radius:6px;margin:5px 0}
.hidden{display:none}
</style>
</head>

<body>

<header>
<h2><i class="fa fa-user-shield"></i> Admin ‚Äì Management Course</h2>
<div id="authStatus">Checking authentication...</div>
</header>

<div class="card" id="editor" class="hidden">
<h3>Module Editor</h3>

<input id="title" placeholder="Module title">
<input id="imageUrl" placeholder="Image URL">
<input id="videoUrl" placeholder="Video URL">

<div id="quill" style="height:180px"></div>

<h4>Quizzes</h4>
<input id="q" placeholder="Question">
<input id="o1" placeholder="Option 1">
<input id="o2" placeholder="Option 2">
<input id="o3" placeholder="Option 3">
<input id="a" placeholder="Correct answer">
<button onclick="addQuiz()">Add Quiz</button>
<div id="quizList"></div>

<button class="draft" onclick="saveModule('draft')">Save Draft</button>
<button class="publish" onclick="saveModule('published')">Publish</button>
</div>

<div class="card">
<h3>Published Modules</h3>
<div id="published"></div>
</div>

<div class="card">
<h3>Draft Modules</h3>
<div id="drafts"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, doc, addDoc, getDocs,
  updateDoc, deleteDoc, getDoc, serverTimestamp, query, where
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import {
  getAuth, signInWithEmailAndPassword, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

/* üî• FIREBASE INIT */
const app = initializeApp({
  apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain: "students-login-29409.firebaseapp.com",
  projectId: "students-login-29409"
});

const db = getFirestore(app);
const auth = getAuth(app);

/* üîê SIGN IN ADMIN (TEMP ‚Äì REPLACE WITH LOGIN FORM) */
signInWithEmailAndPassword(auth, "ADMIN_EMAIL", "ADMIN_PASSWORD");

/* üõ°Ô∏è ADMIN CHECK */
let adminUID = null;

onAuthStateChanged(auth, async user => {
  if (!user) {
    authStatus.innerText = "‚ùå Not logged in";
    return;
  }

  const adminDoc = await getDoc(doc(db, "admins", user.uid));

  if (!adminDoc.exists()) {
    authStatus.innerText = "‚ùå Not an admin (admins/{uid} missing)";
    return;
  }

  adminUID = user.uid;
  authStatus.innerText = "‚úÖ Admin authenticated";
  editor.classList.remove("hidden");
  loadModules();
});

/* ‚úèÔ∏è QUILL */
const quill = new Quill("#quill", { theme: "snow" });

let quizzes = [];
let editingId = null;

/* üß† QUIZ */
window.addQuiz = () => {
  quizzes.push({
    question: q.value,
    options: [o1.value, o2.value, o3.value],
    answer: a.value
  });
  q.value=o1.value=o2.value=o3.value=a.value="";
  renderQuizzes();
};

function renderQuizzes(){
  quizList.innerHTML="";
  quizzes.forEach((x,i)=>{
    quizList.innerHTML+=`<div class="quiz">${i+1}. ${x.question}</div>`;
  });
}

/* üíæ SAVE MODULE (RULE-COMPATIBLE) */
window.saveModule = async status => {
  if (!adminUID) return alert("Admin not authenticated");

  const ref = collection(db,"courses","management_course","modules");

  const data = {
    title: title.value,
    imageUrl: imageUrl.value,
    videoUrl: videoUrl.value,
    content: quill.root.innerHTML,
    quizzes,
    status,
    updatedAt: serverTimestamp()
  };

  if (editingId) {
    await updateDoc(doc(ref, editingId), data);
  } else {
    await addDoc(ref, data);
  }

  reset();
  loadModules();
};

/* üì¶ LOAD MODULES */
async function loadModules(){
  published.innerHTML=drafts.innerHTML="";

  const snap = await getDocs(
    collection(db,"courses","management_course","modules")
  );

  snap.forEach(d=>{
    const m=d.data();
    const html=`
      <div class="quiz">
        <b>${m.title}</b>
        <button onclick="edit('${d.id}')">Edit</button>
        <button class="delete" onclick="del('${d.id}')">Delete</button>
      </div>`;
    (m.status==="published"?published:drafts).innerHTML+=html;
  });
}

/* ‚úèÔ∏è EDIT */
window.edit = async id => {
  const snap = await getDoc(doc(db,"courses","management_course","modules",id));
  const m = snap.data();
  title.value=m.title;
  imageUrl.value=m.imageUrl;
  videoUrl.value=m.videoUrl;
  quill.root.innerHTML=m.content;
  quizzes=m.quizzes||[];
  editingId=id;
  renderQuizzes();
};

/* üóëÔ∏è DELETE */
window.del = async id => {
  await deleteDoc(doc(db,"courses","management_course","modules",id));
  loadModules();
};

/* ‚ôªÔ∏è RESET */
function reset(){
  title.value=imageUrl.value=videoUrl.value="";
  quill.root.innerHTML="";
  quizzes=[]; editingId=null;
  renderQuizzes();
}
</script>

</body>
</html>
