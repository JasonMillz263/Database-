<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin â€“ Quiz System</title>
<style>
/* ========= MOBILE RESPONSIVE =========== */
body { font-family: sans-serif; margin: 0; padding:0; }
.admin-container { padding: 10px; max-width: 1200px; margin: auto; }
.module-toggle button {
  padding: 12px;
  border-radius: 8px;
  margin: 5px;
  background: #2c7be5;
  color: #fff;
  border: none;
  cursor: pointer;
}
.quiz-container { padding: 15px; border:1px solid #ddd; border-radius: 8px; margin-top:10px; }
.quiz-options button { display:block; width:100%; margin:5px 0; padding:10px; }
#quizTimer { font-weight:bold; color:red; margin-bottom:10px; }
@media (max-width:768px){
  .module-toggle button { width:100%; margin-bottom: 8px; }
  .quiz-options button { font-size:14px; }
}
</style>
</head>
<body>

<div class="admin-container">

  <!-- MODULE TOGGLE -->
  <div class="module-toggle">
    <button onclick="showModules('published')">ğŸ“˜ Published</button>
    <button onclick="showModules('draft')">ğŸ“ Drafts</button>
    <button onclick="showModules('bin')">ğŸ—‘ Recycle Bin</button>
  </div>

  <div id="published-modules" class="module-list" style="display:none"></div>
  <div id="draft-modules" class="module-list" style="display:none"></div>
  <div id="bin-modules" class="module-list" style="display:none"></div>

  <!-- QUIZ CONTAINER -->
  <div class="quiz-container" id="quizContainer">
    <div id="quizTimer">Time Left: <span id="timeLeft">00:00</span></div>
    <h3 id="question">Question</h3>
    <div class="quiz-options">
      <button id="opt0" onclick="submitAnswer(0)"></button>
      <button id="opt1" onclick="submitAnswer(1)"></button>
      <button id="opt2" onclick="submitAnswer(2)"></button>
      <button id="opt3" onclick="submitAnswer(3)"></button>
    </div>
  </div>

  <!-- CERTIFICATE CANVAS -->
  <canvas id="certCanvas" width="1200" height="850" style="display:none"></canvas>
  <button id="certBtn" style="display:none">ğŸ“ Download Certificate</button>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script>
// ===== FIREBASE INIT =====
const firebaseConfig = {
  // YOUR FIREBASE CONFIG
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

// ===== MODULE TOGGLE FUNCTION =====
function showModules(type){
  document.querySelectorAll('.module-list').forEach(d=>d.style.display='none');
  document.getElementById(type+'-modules').style.display='block';
}

// ===== QUIZ DATA (EXAMPLE) =====
const quizzes = [
  {question:"What is HACCP?", options:["Process","Food safety system","Packaging","Training"], correctIndex:1},
  {question:"Max fridge temp?", options:["5Â°C","10Â°C","15Â°C","0Â°C"], correctIndex:0},
  {question:"How often wash hands?", options:["Daily","Before eating","Before handling food","Never"], correctIndex:2}
];

let currentQuizIndex = 0;
let score = 0;
let perQuestionDuration = 30; // seconds per question
let remainingTime = perQuestionDuration;
let timerInterval;
let attemptId;
const studentId = "student123"; // Replace with logged-in student id

// ===== START QUIZ ATTEMPT (ANTI-CHEAT) =====
async function startQuizAttempt(studentId, moduleId){
  const ref = await db.collection("quiz_attempts").add({
    studentId,
    moduleId,
    startedAt: firebase.firestore.FieldValue.serverTimestamp(),
    duration: perQuestionDuration * quizzes.length,
    completed: false
  });
  attemptId = ref.id;
  loadQuiz();
}

// ===== LOAD QUIZ =====
function loadQuiz(){
  const quiz = quizzes[currentQuizIndex];
  document.getElementById('question').innerText = quiz.question;
  quiz.options.forEach((opt,i)=>document.getElementById(`opt${i}`).innerText=opt);
  remainingTime = perQuestionDuration;
  updateTimerUI();
  clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    remainingTime--;
    updateTimerUI();
    if(remainingTime<=0){
      clearInterval(timerInterval);
      submitAnswer(null); // no answer = timeout
    }
  },1000);
}

// ===== TIMER UI =====
function updateTimerUI(){
  const min = Math.floor(remainingTime/60);
  const sec = remainingTime%60;
  document.getElementById("timeLeft").innerText = `${min}:${sec.toString().padStart(2,"0")}`;
}

// ===== SUBMIT ANSWER =====
function submitAnswer(selectedIndex){
  const correct = quizzes[currentQuizIndex].correctIndex;
  if(selectedIndex!==null && selectedIndex===correct) score++;
  currentQuizIndex++;
  if(currentQuizIndex<quizzes.length){
    loadQuiz();
  }else{
    finishQuiz();
  }
}

// ===== FINISH QUIZ =====
function finishQuiz(){
  const passMark = Math.ceil(quizzes.length*0.6);
  const passed = score>=passMark;
  db.collection("quiz_attempts").doc(attemptId).update({completed:true, score:score});
  db.collection("quiz_results").add({studentId, score, passed});
  if(passed){
    alert(`You Passed! Score: ${score}/${quizzes.length}`);
    checkAndGenerateCertificate(studentId);
  }else{
    alert(`You Failed! Score: ${score}/${quizzes.length}`);
  }
}

// ===== CHECK ALL MODULES COMPLETED =====
async function checkAndGenerateCertificate(studentId){
  const modulesSnap = await db.collection("modules").where("status","==","published").get();
  const completedSnap = await db.collection("progress").where("studentId","==",studentId).where("completed","==",true).get();
  if(completedSnap.size!==modulesSnap.size) return;
  const quizSnap = await db.collection("quiz_results").where("studentId","==",studentId).where("passed","==",true).get();
  if(quizSnap.size!==modulesSnap.size) return;
  generateCertificate(studentId);
}

// ===== GENERATE CERTIFICATE =====
async function generateCertificate(studentId){
  const student = await db.collection("students").doc(studentId).get();
  const name = student.data().name || "Student Name";
  const canvas = document.getElementById("certCanvas");
  const ctx = canvas.getContext("2d");
  const bg = new Image();
  bg.src = "certificate_template.png"; // replace with your template
  bg.onload = async ()=>{
    ctx.drawImage(bg,0,0,canvas.width,canvas.height);
    ctx.font="48px serif";
    ctx.fillStyle="#000";
    ctx.textAlign="center";
    ctx.fillText(name, canvas.width/2,420);
    ctx.font="24px serif";
    ctx.fillText("Food Business Academy", canvas.width/2,500);
    const blob = await new Promise(res=>canvas.toBlob(res));
    const ref = storage.ref(`certificates/${studentId}.png`);
    await ref.put(blob);
    const url = await ref.getDownloadURL();
    await db.collection("certificates").add({studentId, issuedAt:firebase.firestore.FieldValue.serverTimestamp(), certificateUrl:url});
    document.getElementById("certBtn").style.display="block";
    document.getElementById("certBtn").onclick=()=>{window.open(url,"_blank");};
    alert("ğŸ‰ Certificate Generated Successfully!");
  };
}

// ===== START QUIZ AUTOMATICALLY =====
startQuizAttempt(studentId,"module123"); // module id example
</script>
</body>
  </html>
