<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Payment Preview - Food Business Academy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body{font-family:'Poppins',sans-serif;background:#f4f6fb;margin:0;padding:20px;}
.container{max-width:700px;margin:auto;background:#fff;border-radius:20px;padding:30px;box-shadow:0 10px 25px rgba(0,0,0,.08);}
h2{text-align:center;margin-bottom:20px;}
.student-details p{margin:6px 0;}
.course-summary{display:flex;justify-content:space-between;align-items:center;margin:15px 0;padding:15px;background:#f0f4ff;border-radius:12px;}
label{font-weight:600;display:block;margin:8px 0 4px;}
select,input[type="checkbox"]{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;margin-top:4px;}
button{margin-top:20px;width:100%;padding:15px;border:none;border-radius:12px;background:linear-gradient(135deg,#2563eb,#6d28d9);color:#fff;font-weight:600;cursor:pointer;font-size:16px;}
button:hover{opacity:.9;}
#loading{text-align:center;margin-top:15px;display:none;}
.spinner{margin:0 auto;width:40px;height:40px;border:5px solid #ddd;border-top-color:#2563eb;border-radius:50%;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.invoice-popup{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:95%;max-width:650px;background:#fff;border-radius:20px;padding:25px;box-shadow:0 15px 40px rgba(0,0,0,.3);z-index:999;overflow:auto;}
.invoice-header{text-align:center;border-bottom:2px solid #f0f0f0;padding-bottom:10px;margin-bottom:15px;}
.invoice-header img{width:100px;margin-bottom:10px;}
.invoice-title{font-size:22px;font-weight:700;color:#2563eb;}
.invoice-body p{margin:6px 0;}
.payment-instructions{margin-top:15px;padding:10px;background:#f9f9f9;border-radius:12px;font-size:14px;}
.invoice-footer{display:flex;justify-content:space-between;margin-top:20px;}
.invoice-footer button{width:48%;}
@media(max-width:600px){.course-summary{flex-direction:column;align-items:flex-start;}.invoice-footer{flex-direction:column;gap:10px;}.invoice-footer button{width:100%;}}
</style>
</head>
<body>

<div class="container">
  <h2>Payment Preview</h2>

  <div class="student-details" id="studentDetails"></div>

  <div class="course-summary">
    <p><strong>Course:</strong> <span id="courseName"></span></p>
    <p><strong>Amount:</strong> $<span id="amount"></span></p>
  </div>

  <label for="paymentMethod">Payment Method</label>
  <select id="paymentMethod" required>
    <option value="ecocash">Ecocash</option>
    <option value="bank">Bank Transfer</option>
    <option value="paypal">PayPal</option>
  </select>

  <label style="margin-top:10px;">
    <input type="checkbox" id="terms" required> I agree to the <a href="#">terms and conditions</a>
  </label>

  <button id="proceedPayment">Proceed to Payment</button>

  <div id="loading">
    <div class="spinner"></div>
    <p>Generating invoice...</p>
  </div>
</div>

<!-- Invoice Popup -->
<div class="invoice-popup" id="invoicePopup">
  <div class="invoice-header">
    <img src="school-logo.png" alt="School Logo">
    <div class="invoice-title">Invoice - Pending Payment</div>
  </div>
  <div class="invoice-body" id="invoiceContent">
    <p><strong>Name:</strong> <span id="invName"></span></p>
    <p><strong>Email:</strong> <span id="invEmail"></span></p>
    <p><strong>Phone:</strong> <span id="invPhone"></span></p>
    <p><strong>Course:</strong> <span id="invCourse"></span></p>
    <p><strong>Amount:</strong> $<span id="invAmount"></span></p>
    <p><strong>Payment Method:</strong> <span id="invMethod"></span></p>

    <div class="payment-instructions">
      <p><strong>Bank Details:</strong> Food Business Academy, ABC Bank, Acc#: 1234567890</p>
      <p><strong>Ecocash:</strong> 0771234567</p>
      <p>Send proof of payment to WhatsApp: <strong>0771234567</strong> or email: <strong>support@foodbusinessacademy.com</strong></p>
    </div>
  </div>
  <div class="invoice-footer">
    <button onclick="closeInvoicePopup()">Back to Courses</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain: "students-login-29409.firebaseapp.com",
  projectId: "students-login-29409",
  storageBucket: "students-login-29409.firebasestorage.app",
  messagingSenderId: "634331456872",
  appId: "1:634331456872:web:6dae360c5e28d8356562dd",
  measurementId: "G-96XXYG1VR2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- Load student/course info ---
const studentName = localStorage.getItem('studentName');
const studentEmail = localStorage.getItem('studentEmail');
const studentPhone = localStorage.getItem('studentPhone');
const courseName = localStorage.getItem('courseName');
const coursePrice = localStorage.getItem('coursePrice');

document.getElementById('studentDetails').innerHTML = `
  <p><strong>Name:</strong> ${studentName}</p>
  <p><strong>Email:</strong> ${studentEmail}</p>
  <p><strong>Phone:</strong> ${studentPhone}</p>
`;
document.getElementById('courseName').textContent = courseName;
document.getElementById('amount').textContent = coursePrice;

// --- Original working popup logic ---
document.getElementById('proceedPayment').addEventListener('click', async ()=>{
  const paymentMethod = document.getElementById('paymentMethod').value;
  if(!document.getElementById('terms').checked){
    alert("Please accept terms and conditions");
    return;
  }

  document.getElementById('loading').style.display = 'block';

  try {
    await addDoc(collection(db,"invoices"),{
      name: studentName,
      email: studentEmail,
      phone: studentPhone,
      course: courseName,
      amount: coursePrice,
      paymentMethod: paymentMethod,
      status: "pending",
      createdAt: serverTimestamp()
    });
    document.getElementById('loading').style.display = 'none';

    // Show popup
    document.getElementById('invName').textContent = studentName;
    document.getElementById('invEmail').textContent = studentEmail;
    document.getElementById('invPhone').textContent = studentPhone;
    document.getElementById('invCourse').textContent = courseName;
    document.getElementById('invAmount').textContent = coursePrice;
    document.getElementById('invMethod').textContent = paymentMethod;

    document.getElementById('invoicePopup').style.display = 'block';

  } catch(e){
    console.error("Error:", e);
    alert("Failed to generate invoice.");
    document.getElementById('loading').style.display = 'none';
  }
});

function closeInvoicePopup(){
  document.getElementById('invoicePopup').style.display = 'none';
  window.location.href = "courses.html";
}
</script>

</body>
</html>
