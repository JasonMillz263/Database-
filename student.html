<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Food Business Academy | Student Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<style>
:root{
  --purple:#6d28d9;
  --blue:#2563eb;
  --bg:linear-gradient(180deg,#eef2ff,#f9fbff);
  --text:#1f2937;
  --soft:rgba(255,255,255,.95);
  --green: #10b981;
  --gold: #f59e0b;
}

*{box-sizing:border-box;font-family:'Poppins',sans-serif}
body{margin:0;background:var(--bg);color:var(--text);overflow-x:hidden}

/* Layout */
.layout{
  display:grid;
  grid-template-columns:280px 1fr;
  min-height:100vh;
}

/* Sidebar */
.sidebar{
  background:linear-gradient(180deg,var(--blue),var(--purple));
  color:#fff;
  padding:25px;
  position: sticky;
  top: 0;
  height: 100vh;
}
.sidebar h2{margin-bottom:20px; font-weight: 700;}
.sidebar a{
  display:flex;gap:12px;align-items:center;
  color:#e5e7eb;text-decoration:none;
  padding:12px;border-radius:12px;margin-bottom:8px;
  transition:.25s;
}
.sidebar a:hover{
  background:rgba(255,255,255,.2);
  transform:translateX(6px);
}
.sidebar .logout{background:rgba(239, 68, 68, 0.2); color:#fff; margin-top: 20px;}
.sidebar .logout:hover{background:#ef4444;}

/* Main */
.main{
  padding:28px;
  animation:pageIn .5s ease;
}
@keyframes pageIn{
  from{opacity:0;transform:translateY(20px)}
  to{opacity:1;transform:translateY(0)}
}

/* Header */
.top-header{
  display:flex;justify-content:space-between;align-items:center;
  background:linear-gradient(135deg,var(--blue),var(--purple));
  color:#fff;
  padding:20px 24px;
  border-radius:20px;
  box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.3);
}
.badge{
  background:rgba(255,255,255,.2);
  padding:6px 14px;border-radius:999px;
  font-size:14px;
  backdrop-filter: blur(4px);
}

/* HERO SLIDER */
.hero{
  margin:28px 0;
  position:relative;
  height:260px;
  border-radius:26px;
  overflow:hidden;
  box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
}
.slide{
  position:absolute;
  inset:0;
  background-size:cover;
  background-position:center;
  opacity:0;
  transition:opacity 1s ease;
}
.slide.active{opacity:1}
.hero-overlay{
  position:absolute;
  inset:0;
  background:linear-gradient(90deg,rgba(0,0,0,.7),transparent);
  display:flex;
  align-items:center;
  padding:40px;
  color:#fff;
}
.hero h2{font-size:32px;margin:0; font-weight: 700;}
.hero p{max-width:480px;margin-top:10px; font-weight: 300;}

/* Stats */
.glass{
  background:rgba(255,255,255,.8);
  backdrop-filter:blur(14px);
  border-radius:22px;
  box-shadow:0 10px 30px rgba(0,0,0,.05);
  border: 1px solid rgba(255,255,255,0.5);
}

.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:18px;
  margin-bottom:40px;
}
.stat-card{
  padding:22px;
  color:#111;
  position:relative;
  transition: transform 0.3s ease;
}
.stat-card:hover { transform: translateY(-5px); }
.stat-card i{
  font-size:28px;
  background: linear-gradient(135deg, var(--blue), var(--purple));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 10px;
  display: block;
}
.stat-value{
  font-size:32px;
  font-weight:700;
  color: var(--text);
}
.stat-title{opacity:.7; font-size: 0.9rem;}

/* --- COURSE GRID STYLES (NEW) --- */
.section-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.course-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 25px;
}

.course-card {
  padding: 0;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.course-header {
  height: 6px;
  background: linear-gradient(90deg, var(--blue), var(--purple));
  width: 100%;
}

.course-body { padding: 25px; flex-grow: 1; display: flex; flex-direction: column;}

.course-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
.course-icon {
  width: 45px; height: 45px;
  background: #f0f4ff;
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  color: var(--blue);
  font-size: 1.2rem;
}

/* Status Badges */
.status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;}
.badge-new { background: #e0e7ff; color: var(--blue); }
.badge-active { background: #dcfce7; color: #15803d; border: 1px solid #86efac; }
.badge-pending { background: #fef3c7; color: #b45309; border: 1px solid #fcd34d; }

.course-title { font-size: 1.1rem; font-weight: 700; margin: 0 0 10px 0; color: var(--text); }
.course-desc { font-size: 0.85rem; color: #6b7280; line-height: 1.5; margin-bottom: 20px; flex-grow: 1;}

.course-footer {
  padding: 15px 25px 25px;
  border-top: 1px solid #f3f4f6;
  display: flex; justify-content: space-between; align-items: center;
}

.price { font-size: 1.2rem; font-weight: 800; color: var(--text); }

/* Buttons */
.btn {
  padding: 10px 18px; border: none; border-radius: 10px;
  font-weight: 600; cursor: pointer; transition: .3s; font-size: 0.9rem;
  text-decoration: none; display: inline-block;
}
.btn-enroll { background: var(--text); color: #fff; }
.btn-enroll:hover { background: var(--blue); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3); }

.btn-access { background: var(--green); color: #fff; width: 100%; text-align: center;}
.btn-access:hover { filter: brightness(1.1); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3); }

.btn-pending { background: #cbd5e1; color: #64748b; cursor: not-allowed; width: 100%; }

.link-cancel {
  display: block; text-align: center; color: #ef4444; 
  font-size: 0.75rem; margin-top: 8px; cursor: pointer; 
  text-decoration: underline; font-weight: 500;
}

/* Page transition overlay */
#pageTransition{
  position:fixed; inset:0; background:linear-gradient(135deg,var(--blue),var(--purple));
  z-index:999; opacity:0; pointer-events:none; transition:opacity .45s ease;
}
#pageTransition.active{ opacity:1; pointer-events:auto; }

@media(max-width:900px){
  .layout{grid-template-columns:1fr}
  .sidebar { position: relative; height: auto; }
}
</style>
</head>

<body>

<div id="pageTransition"></div>

<div class="layout">

<aside class="sidebar">
  <h2>FBA Portal</h2>
  <a href="dashboard.html" class="nav-link" style="background:rgba(255,255,255,.2); font-weight:600;"><i class="fa fa-home"></i> Dashboard</a>
  <a href="progress.html" class="nav-link"><i class="fa fa-chart-line"></i> Progress Tracking</a>
  <a href="courses.html" class="nav-link"><i class="fa fa-book"></i> Courses Offered</a>
  <a href="certificates.html" class="nav-link"><i class="fa fa-certificate"></i> Certificates</a>
  <a href="tickets.html" class="nav-link"><i class="fa fa-ticket"></i> Tickets Support</a>
  <a href="profile.html" class="nav-link"><i class="fa fa-user"></i> Student Profile</a>
  <a href="#" class="logout" onclick="logout()"><i class="fa fa-sign-out-alt"></i> Logout</a>
</aside>

<main class="main">

<div class="top-header">
  <div>
    <h1>Welcome, <span id="studentName">Student</span> üëã</h1>
    <div class="badge">Student ID: <span id="studentId">...</span></div>
  </div>
</div>

<div class="hero">
  <div class="slide active" style="background-image:url('https://images.unsplash.com/photo-1556911220-e15b29be8c8f')"></div>
  <div class="slide" style="background-image:url('https://images.unsplash.com/photo-1504674900247-0877df9cc836')"></div>
  <div class="slide" style="background-image:url('https://images.unsplash.com/photo-1600891964599-f61ba0e24092')"></div>

  <div class="hero-overlay">
    <div>
      <h2>Build a Profitable Food Business</h2>
      <p>Master recipes, branding, costing & real-world entrepreneurship skills today.</p>
    </div>
  </div>
</div>

<section class="stats">
  <div class="stat-card glass">
    <i class="fa fa-book-open"></i>
    <div class="stat-value" id="coursesEnrolled">0</div>
    <div class="stat-title">Courses Enrolled</div>
  </div>

  <div class="stat-card glass">
    <i class="fa fa-chart-pie"></i>
    <div class="stat-value" id="completionRate">0%</div>
    <div class="stat-title">Completion Rate</div>
  </div>

  <div class="stat-card glass">
    <i class="fa fa-award"></i>
    <div class="stat-value" id="certificatesCount">0</div>
    <div class="stat-title">Certificates</div>
  </div>
</section>

<div class="section-title">
  <i class="fa fa-layer-group" style="color:var(--blue)"></i> Available Courses
</div>

<div class="course-grid" id="coursesGrid">
  <div style="grid-column:1/-1; text-align:center; padding:40px; color:#64748b;">
    <i class="fas fa-spinner fa-spin fa-2x"></i><br><br>Loading Courses...
  </div>
</div>

</main>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* üî• FIREBASE INIT */
firebase.initializeApp({
  apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain:"students-login-29409.firebaseapp.com",
  projectId:"students-login-29409"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* üìö COURSE DATA */
const coursesData = [
  {
    name: "Food Business Management Course",
    price: 49,
    icon: "fa-briefcase",
    desc: "The flagship program covering the ecosystem of running a compliant and profitable food business."
  },
  {
    name: "Financial Management for Food Processors",
    price: 59,
    icon: "fa-calculator",
    desc: "Learn yield loss, unit costing, and cash flow specifically for food manufacturing economics."
  },
  {
    name: "Food Value Addition Course for Farmers",
    price: 45,
    icon: "fa-tractor",
    desc: "Stop selling raw produce. Learn to process, package, and brand your harvest for higher margins."
  },
  {
    name: "New Product Development and Management",
    price: 69,
    icon: "fa-flask",
    desc: "Masterclass in innovation. Take an idea from kitchen recipe to shelf-stable commercial product."
  },
  {
    name: "Management",
    price: 39,
    icon: "fa-users",
    desc: "Essential soft skills and hard tactics for managing teams in high-pressure food environments."
  }
];

/* üîê AUTH & LOGIC */
auth.onAuthStateChanged(async user => {
  if(!user){ location.href='index.html'; return; }

  // 1. Basic User Info
  document.getElementById('studentId').textContent = user.uid.slice(0,6).toUpperCase();
  document.getElementById('studentName').textContent = user.displayName || user.email.split('@')[0];

  // 2. Fetch Student Data (For Stats & Access)
  const studentRef = db.collection('students').doc(user.uid);
  const studentSnap = await studentRef.get();
  
  let coursesPaid = [];
  
  if (studentSnap.exists) {
    const data = studentSnap.data();
    coursesPaid = data.coursesPaid || [];
    
    // Stats Update
    const enrolledCount = coursesPaid.length;
    document.getElementById('coursesEnrolled').textContent = enrolledCount;

    // Fetch Certificates subcollection size
    const certsSnap = await studentRef.collection('certificates').get();
    const certCount = certsSnap.size;
    document.getElementById('certificatesCount').textContent = certCount;

    // Calc Completion
    if(enrolledCount > 0) {
      const rate = (certCount / enrolledCount) * 100;
      document.getElementById('completionRate').textContent = `${Math.round(rate)}%`;
    }
  }

  // 3. Fetch Pending Payments
  const paymentsSnap = await db.collection('payments')
    .where('studentId', '==', user.uid)
    .get();
  
  const paymentMap = {};
  paymentsSnap.forEach(doc => {
    paymentMap[doc.data().courseName] = { ...doc.data(), id: doc.id };
  });

  // 4. Render Course Grid
  renderCourses(coursesPaid, paymentMap);
});

/* üé® RENDER FUNCTION */
function renderCourses(coursesPaid, paymentMap) {
  const grid = document.getElementById('coursesGrid');
  grid.innerHTML = "";

  coursesData.forEach(course => {
    const hasAccess = coursesPaid.includes(course.name);
    const payment = paymentMap[course.name];

    let statusHtml = `<span class="status-badge badge-new">New</span>`;
    let footerHtml = "";

    if (hasAccess) {
      // ‚úÖ Enrolled
      statusHtml = `<span class="status-badge badge-active"><i class="fa fa-check"></i> Active</span>`;
      footerHtml = `<button class="btn btn-access" onclick="startCourse('${course.name}')">Enter Classroom</button>`;
    } else if (payment && payment.status === "pending") {
      // ‚è≥ Pending
      statusHtml = `<span class="status-badge badge-pending">Processing</span>`;
      footerHtml = `
        <div style="width:100%">
          <button class="btn btn-pending" disabled>Pending Approval...</button>
          <span class="link-cancel" onclick="cancelInvoice('${payment.id}')">Cancel Request</span>
        </div>
      `;
    } else {
      // üõí Available
      footerHtml = `
        <div class="price">$${course.price}</div>
        <button class="btn btn-enroll" onclick="createInvoice('${course.name}', ${course.price})">Enroll Now</button>
      `;
    }

    grid.innerHTML += `
      <div class="course-card glass">
        <div class="course-header"></div>
        <div class="course-body">
          <div class="course-top">
            <div class="course-icon"><i class="fa ${course.icon}"></i></div>
            ${statusHtml}
          </div>
          <h3 class="course-title">${course.name}</h3>
          <p class="course-desc">${course.desc}</p>
        </div>
        <div class="course-footer">
          ${footerHtml}
        </div>
      </div>
    `;
  });
}

/* üßæ ACTIONS */
window.createInvoice = async (courseName, price) => {
  const user = auth.currentUser;
  if (!confirm(`Generate enrollment invoice for:\n${courseName}\nPrice: $${price}`)) return;

  try {
    const docRef = await db.collection('payments').add({
      studentId: user.uid,
      studentName: user.displayName || user.email,
      email: user.email,
      courseName: courseName,
      price: price,
      paymentMethod: "Manual",
      invoiceNumber: `FBA-${Date.now()}`,
      status: "pending",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    // Redirect to invoice details
    window.location.href = `student-details.html?invoiceId=${docRef.id}`;
  } catch (error) {
    alert("Error creating invoice: " + error.message);
  }
};

window.cancelInvoice = async (invoiceId) => {
  if (!confirm("Cancel this pending request?")) return;
  await db.collection('payments').doc(invoiceId).delete();
  location.reload();
};

window.startCourse = (courseName) => {
  const coursePages = {
    "Management": "management_course.html",
    "Food Business Management Course": "course-food-business-management.html",
    "Financial Management for Food Processors": "course-financial-management.html",
    "Food Value Addition Course for Farmers": "course-value-addition.html",
    "New Product Development and Management": "course-product-development.html"
  };
  const page = coursePages[courseName];
  if (page) window.location.href = page;
  else alert("Course page not found.");
};

function logout(){
  auth.signOut().then(()=>location.href='index.html');
}

/* UI UTILS */
let slides = document.querySelectorAll('.slide');
let i = 0;
setInterval(() => {
  slides[i].classList.remove('active');
  i = (i + 1) % slides.length;
  slides[i].classList.add('active');
}, 4500);

document.querySelectorAll('.nav-link').forEach(link => {
  link.addEventListener('click', e => {
    e.preventDefault();
    document.getElementById('pageTransition').classList.add('active');
    setTimeout(() => window.location = link.href, 420);
  });
});
</script>

</body>
</html>
